<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>AutoSender Pro</title>
    <!-- 全局样式和字体设置 -->
    <style>
        /*#region 全局样式和字体设置 */
        @font-face {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            src: url('./test/Xiaolai.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --text-dark: #2F2F2F;
            --border-dark: #2F2F2F;
            --shadow: rgba(0, 0, 0, 0.1);
            --hacker-green: #00ff41;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 全局字体设置 */
        *,
        *::before,
        *::after {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif !important;
        }

        /* 输入框和日志框字体 */
        textarea,
        .log-box,
        #numbersText,
        #messageText {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif !important;
        }

        /* 输入框占位符字体 */
        textarea::placeholder {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif !important;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* 页面主体 */
        body {
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
            background-color: #00ff88;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            color: var(--text-dark);
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            visibility: visible;
            opacity: 1;
        }

        /* 内容包装器 */
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        /* 导航按钮栏容器 */
        .nav-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: flex-start;
            margin-right: 10px;
            margin-top: 30px;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        /*#endregion */
        /*#region 导航按钮样式 */
        /* 导航按钮组 */
        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: flex-start;
        }

        /* 导航按钮基础样式 */
        .nav-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            min-width: 100px;
            position: relative;
        }

        /* 主页面按钮 */
        #navHomeBtn {
            background: linear-gradient(135deg, #b2ff9be6, rgb(208, 255, 1));
        }

        /* 主页面按钮 - 悬停效果 */
        #navHomeBtn:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        /* 主页面按钮 - 激活状态 */
        #navHomeBtn:active,
        #navHomeBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        /* 主页面按钮 - 激活状态悬停 */
        #navHomeBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(240, 147, 251, 0.6);
        }

        /* IMessage按钮 */
        #navSendBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            font-size: 10px;
            padding: 12px 15px;
        }

        /* IMessage按钮 - 悬停效果 */
        #navSendBtn:hover {
            background: linear-gradient(100deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #000002;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(79, 172, 254, 0.5);
        }

        /* IMessage按钮 - 激活状态 */
        #navSendBtn:active,
        #navSendBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(102, 166, 255, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        /* IMessage按钮 - 激活状态悬停 */
        #navSendBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(102, 166, 255, 0.6);
        }

        /* 账号管理按钮 */
        #navAccountBtn {
            background: linear-gradient(135deg, #a8c0ff 0%, #9d8fff 50%, #b794f6 100%);
        }

        /* 账号管理按钮 - 悬停效果 */
        #navAccountBtn:hover {
            background: linear-gradient(150deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #000000;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(157, 143, 255, 0.5);
        }

        /* 账号管理按钮 - 激活状态 */
        #navAccountBtn:active,
        #navAccountBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(183, 148, 246, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        /* 账号管理按钮 - 激活状态悬停 */
        #navAccountBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(183, 148, 246, 0.6);
        }

        /* 收件箱按钮 */
        #navInboxBtn {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
        }

        /* 收件箱按钮 - 悬停效果 */
        #navInboxBtn:hover {
            background: linear-gradient(150deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #000000;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(252, 182, 159, 0.5);
        }

        /* 收件箱按钮 - 激活状态 */
        #navInboxBtn:active,
        #navInboxBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(255, 179, 71, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        /* 收件箱按钮 - 激活状态悬停 */
        #navInboxBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(255, 179, 71, 0.6);
        }

        /* 退出账号按钮 */
        #navLogoutBtn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        /* 退出账号按钮 - 悬停效果 */
        #navLogoutBtn:hover {
            background: linear-gradient(150deg, #ff5252 0%, #d32f2f 50%, #b71c1c 100%);
            border-color: #000000;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
        }

        /* 退出账号按钮 - 激活状态 */
        #navLogoutBtn:active {
            background: linear-gradient(120deg, #d32f2f 0%, #b71c1c 50%, #8b0000 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        /* 退出账号按钮 - 激活状态悬停 */
        #navLogoutBtn:active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(255, 107, 107, 0.6);
        }

        /*#endregion */
        /*#region 主容器和工作区 */
        /* 主容器 */
        .main-container {
            display: flex;
            gap: 10px;
            width: 1300px;
            height: 580px;
            position: relative;
            max-width: 100vw;
            max-height: 100vh;
            box-sizing: border-box;
        }

        /* 工作区A+B */
        .workspace-ab {
            display: none;
            gap: 10px;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* 工作区A+B - 单面板模式（只显示A版） */
        .workspace-ab.single-panel {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 工作区A+B - 单面板模式下的A版居中 */
        .workspace-ab.single-panel .panel-a {
            margin: 0 auto;
        }

        /* 工作区A+B - 显示日志面板模式 */
        .workspace-ab.show-log {
            display: flex;
        }

        /* 日志面板切换按钮 */
        .btn-log-panel {
            position: absolute;
            left: 10px;
            padding: 8px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, hsla(341, 100%, 63%, 0.949) 0%, hsl(273, 100%, 85%) 50%, #ffec8ff2 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3), 0 0 15px rgba(255, 152, 0, 0.2);
            white-space: nowrap;
        }

        /* 日志面板切换按钮 - 悬停效果 */
        .btn-log-panel:hover {
            background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
            border-color: #FF9800;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5), 0 0 25px rgba(255, 152, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        /* 日志面板切换按钮 - 点击效果 */
        .btn-log-panel:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4), 0 0 15px rgba(255, 152, 0, 0.3);
            background: linear-gradient(135deg, rgba(255, 180, 80, 0.95) 0%, rgba(255, 160, 60, 0.9) 50%, rgba(255, 140, 40, 0.95) 100%);
        }

        /* 日志面板切换按钮 - 激活状态 */
        .btn-log-panel.active {
            background: linear-gradient(135deg, rgba(202, 136, 255, 0.3) 0%, rgb(255, 70, 190) 50%, rgb(255, 130, 136) 100%);
            border-color: #8B00FF;
            box-shadow: 0 4px 15px rgba(139, 0, 255, 0.4), 0 0 20px rgba(139, 0, 255, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }

        /* 日志面板切换按钮 - 激活状态悬停 */
        .btn-log-panel.active:hover {
            background: linear-gradient(135deg, rgba(233, 90, 255, 0.924) 0%, hsl(270, 100%, 81%) 50%, rgb(102, 126, 234) 100%);
            box-shadow: 0 6px 20px rgba(139, 0, 255, 0.5), 0 0 25px rgba(139, 0, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        /*#endregion */
        /*#region A版面板（发送面板） */
        /* A版面板（发送面板） */
        .panel-a {
            width: 750px;
            height: 580px;
            background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* A版面板 - 悬停效果 */
        .panel-a:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }

        /*#endregion */
        /*#region B版面板（日志面板） */
        /* B版面板（日志面板） */
        .panel-b {
            width: 450px;
            background: linear-gradient(to right, #8ad3f7 0%, #9becd1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-width: 450px;
            height: 580px;
            position: relative;
            flex-shrink: 0;
        }

        /* B版面板 - 显示状态 */
        .workspace-ab.show-log .panel-b {
            display: flex;
        }

        /* 工作区A+B - 显示日志时的布局 */
        .workspace-ab.show-log {
            display: flex;
            align-items: flex-start;
        }

        /* B版面板 - 悬停效果 */
        .panel-b:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }

        /*#endregion */
        /*#region D版面板（主页面） */
        /* D版面板（主页面空白面板） */
        .panel-d {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
            box-sizing: border-box;
        }

        /* 主页面标题 */
        .main-title {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 72px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #634ffe 75%, #bd00fe 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: 4px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
            position: relative;
            line-height: 1.2;
        }

        /* 主页面副标题 */
        .main-subtitle {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: rgba(47, 47, 47, 0.6);
            text-align: center;
            margin-top: 20px;
            letter-spacing: 8px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        /*#endregion */
        /*#region C版面板（收件箱面板） */
        /* C版面板（收件箱面板） */
        .panel-c {
            width: 900px;
            height: 100%;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            box-sizing: border-box;
        }

        /*#endregion */
        /*#region E版面板（账号管理面板） */
        /* E版面板（账号管理面板） */
        .panel-e {
            width: 900px;
            height: 100%;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            box-sizing: border-box;
        }
        
        /* E版面板内容区域使用用户详情样式 */
        .panel-e .panel-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .panel-e .user-detail-header,
        .panel-e .user-detail-stats-grid,
        .panel-e .user-detail-stat-card {
            flex-shrink: 0;
        }

        /* E版面板标题栏 */
        .panel-e .panel-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.851) 35%, hsla(76, 100%, 80%, 0.902) 70%, rgba(216, 255, 172, 0.85) 100%);
            border-radius: 15px 15px 0 0;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 面板标题栏（通用） */
        .panel-header {
            height: 35px;
            padding: 0 15px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 18px;
            color: var(--text-dark);
            border-bottom: 3px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        /* A版面板标题栏 */
        .panel-a .panel-header {
            background: linear-gradient(0.3turn, #f072ee, #896bf7, #66ddf8);
            border-radius: 15px 15px 0 0;
        }

        /* B版面板标题栏 */
        .panel-b .panel-header {
            background: linear-gradient(to right, #90a2f5 0%, #6bf3dd 100%);
            border-radius: 15px 15px 0 0;
            position: relative;
        }

        /* C版面板标题栏 */
        .panel-c .panel-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.851) 35%, hsla(76, 100%, 80%, 0.902) 70%, rgba(216, 255, 172, 0.85) 100%);
            border-radius: 15px 15px 0 0;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 面板内容区域（通用） */
        .panel-content {
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* A版内容区域 */
        .content-area {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow: hidden;
        }

        /* A版号码输入容器 */
        .numbers-container {
            width: 380px;
            min-width: 380px;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            background: linear-gradient(0.25turn, #fdc4f0, hsl(200, 84%, 88%), #edc7ff);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .message-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(45deg, #ffddff 0%, #ffc9e6 50%, #a4ffff 100%);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            overflow: hidden;
        }

        .input-header {
            padding: 8px 12px;
            border-bottom: 2px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.3);
        }

        .input-title {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 16px;
        }

        .input-actions {
            display: flex;
            gap: 6px;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-icon:hover {
            background: linear-gradient(135deg, rgba(139, 0, 255, 0.15), rgba(139, 0, 255, 0.1));
            border-color: #8B00FF;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
        }

        .btn-icon:active {
            transform: translateY(0) scale(0.95);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7)) !important;
            border-color: var(--border-dark) !important;
        }

        /* 图标按钮 - 焦点状态 */
        .btn-icon:focus {
            outline: none;
        }

        /* 图标按钮 - 焦点非激活状态 */
        .btn-icon:focus:not(:active) {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7)) !important;
            border-color: var(--border-dark) !important;
            transform: none !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        .btn-icon svg {
            width: 14px;
            height: 14px;
        }

        .input-area {
            flex: 1;
            position: relative;
        }

        textarea {
            width: 100%;
            height: 100%;
            padding: 12px;
            border: none;
            outline: none;
            resize: none;
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            background: transparent;
            transition: all 0.2s;
        }

        /* 号码输入框 */
        #numbersText {
            font-size: 18px;
            width: 100%;
            box-sizing: border-box;
        }

        /* 输入框 - 焦点状态 */
        textarea:focus {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 字符计数器 */
        .char-count {
            position: absolute;
            bottom: 8px;
            right: 10px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            color: rgba(47, 47, 47, 0.6);
            background: rgba(255, 255, 255, 0.7);
            padding: 3px 8px;
            font-weight: bold;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* 号码计数器 - 有号码时绿色 */
        #numbersCount.has-numbers {
            color: #4CAF50;
        }

        /* 消息计数器 - 有内容时绿色 */
        #messageCount.has-content {
            color: #4CAF50;
        }

        /* 消息计数器 - 超过160字符时红色 */
        #messageCount.over-limit {
            color: #F44336;
        }

        /* 消息条数标签 */
        .message-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 20px;
            padding: 0 6px;
            background: linear-gradient(135deg, #FF9800, #FF6B35);
            color: white;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }

        /* A版控制栏 */
        .control-bar {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-top: 10px;
            justify-content: flex-start;
            gap: 10px;
            position: relative;
            flex-wrap: nowrap;
            width: 100%;
        }

        /* 统计栏 - 在日志按钮后 */
        .btn-log-panel+.stats-bar-inline {
            flex-shrink: 0;
            white-space: nowrap;
            margin-left: 10px;
            margin-right: auto;
            flex: 1;
            min-width: 0;
            overflow: visible;
        }

        /* 内联统计栏 */
        .stats-bar-inline {
            flex: 1;
            min-width: 0;
            display: flex;
            gap: 8px;
            padding: 6px 8px;
            background: linear-gradient(0.3turn, rgba(235, 185, 234, 0.6) 0%, rgba(178, 157, 255, 0.6) 50%, rgba(155, 236, 254, 0.6) 100%);
            border-radius: 8px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 9px;
            font-weight: bold;
            flex-wrap: wrap;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex-shrink: 1;
            justify-content: center;
            align-items: center;
        }

        /* 内联统计栏 - 统计项 */
        .stats-bar-inline .stat-item {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 1;
            min-width: 0;
            flex: 0 1 auto;
        }

        /* 内联统计栏 - 统计值 */
        .stats-bar-inline .stat-value {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 9px;
            margin-left: 2px;
            white-space: nowrap;
        }

        /* A版内联统计栏 - 统计项颜色 */
        #taskCountInline {
            color: #9C27B0;
        }

        #phoneCountInline {
            color: #2196F3;
        }

        #totalSentCountInline {
            color: #00BCD4;
        }

        #successCountInline {
            color: #4CAF50;
        }

        #failCountInline {
            color: #FF5252;
        }

        #successRateInline {
            color: #FF9800;
        }

        /* A版内联统计栏 - B版打开时隐藏 */
        .workspace-ab.show-log .stats-bar-inline {
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }

        /* B版统计栏 - B版打开时显示 */
        .workspace-ab.show-log .stats-bar {
            display: flex;
        }

        /* B版统计栏 - 默认隐藏 */
        .stats-bar {
            display: none;
        }

        /* 发送间隔控制 */
        .interval-control {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
            white-space: nowrap;
        }

        /* 发送间隔标签 */
        .interval-label {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: 600;
        }

        /* 发送间隔选择器 */
        .interval-select {
            padding: 5px 8px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            background: rgba(243, 252, 254, 0.9);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15), inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        /* 发送间隔选择器 - 选项 */
        .interval-select option {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            color: var(--text-dark);
            background: linear-gradient(135deg, rgba(235, 185, 234, 0.95) 0%, rgba(178, 157, 255, 0.9) 50%, rgba(155, 236, 254, 0.95) 100%);
        }

        /* 发送间隔选择器 - 不同值的颜色 */
        .interval-select[data-value="0.3"] {
            color: #F44336;
            font-weight: 900;
        }

        .interval-select[data-value="0.7"] {
            color: #FF8A80;
            font-weight: 900;
        }

        .interval-select[data-value="1.0"] {
            color: #4CAF50;
            font-weight: 900;
        }

        .interval-select[data-value="1.5"] {
            color: #FFE082;
            font-weight: 900;
        }

        .interval-select[data-value="2.0"] {
            color: #FFC107;
            font-weight: 900;
        }

        /* 发送间隔选择器 - 悬停效果 */
        .interval-select:hover {
            border-color: #8B00FF;
            transform: translateY(-1px);
        }

        /* 发送按钮 */
        .btn-send {
            flex-shrink: 0;
            white-space: nowrap;
            padding: 6px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, #c5f6df 0%, #75baff 50%, hwb(303 69% 2%) 100%);
            color: rgb(255, 255, 255);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(151, 117, 250, 0.3);
            height: auto;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(151, 117, 250, 0.4);
            background: linear-gradient(135deg, #b24dfb 0%, #ff68fc 50%, #519fe9 100%);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* B版日志容器 */
        .log-box {
            flex: 1;
            background: linear-gradient(135deg, #e6d2d8 0%, #a8edea 100%);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            padding: 10px;
            padding-bottom: 60px;
            overflow-y: auto;
            font-size: 14px;
            color: var(--text-dark);
            position: relative;
        }

        .log-item {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(47, 47, 47, 0.2);
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .stats-bar {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(138, 211, 247, 0.85) 0%, rgba(155, 236, 209, 0.8) 50%, rgba(138, 211, 247, 0.85) 100%);
            border-radius: 8px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            font-weight: bold;
            flex-wrap: wrap;
            width: 100%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            color: var(--text-dark);
        }

        .stat-value {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 12px;
            margin-left: 3px;
        }

        /* B版统计栏 - 统计项颜色 */
        #taskCount {
            color: #9C27B0;
        }

        #phoneCount {
            color: #2196F3;
        }

        #totalSentCount {
            color: #00BCD4;
        }

        #successCount {
            color: #4CAF50;
        }

        #failCount {
            color: #FF5252;
        }

        #successRate {
            color: #FF9800;
        }

        /* 锚点触发器 */
        .anchor-trigger {
            position: absolute;
            bottom: clamp(-8px, -0.8vh, -6px);
            right: clamp(-15px, -1.5vw, -12px);
            width: clamp(16px, 2vw, 20px);
            height: clamp(16px, 2vw, 20px);
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            touch-action: manipulation;
        }

        .anchor-trigger::before {
            content: '';
            width: 8px;
            height: 8px;
            border-bottom: 2px solid rgba(0, 255, 65, 0.7);
            border-right: 2px solid rgba(0, 255, 65, 0.7);
            transition: 0.2s;
        }

        .anchor-trigger:hover::before {
            width: 14px;
            height: 14px;
            border-color: var(--hacker-green);
        }

        .textarea-wrapper.expanded~.anchor-trigger::before,
        .log-wrapper.expanded~.anchor-trigger::before {
            width: 14px;
            height: 14px;
            border-color: var(--hacker-green);
        }

        .textarea-wrapper.locked~.anchor-trigger::before,
        .log-wrapper.locked~.anchor-trigger::before {
            border-color: var(--hacker-green);
        }

        #logTrigger {
            bottom: -4px;
            right: -10px;
        }


        /* 未读消息通知徽章 */
        .notification-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #FF6B6B;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }

        /* 未读消息通知徽章 - 有未读时显示 */
        .notification-count.has-unread {
            display: flex;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 收件箱布局 */
        .inbox-layout {
            display: flex;
            height: 100%;
            gap: 10px;
        }

        .contact-list {
            width: 250px;
            min-width: 200px;
            border-right: 2px solid var(--border-dark);
            padding-right: 10px;
            overflow-y: auto;
            background: linear-gradient(120deg, rgba(168, 200, 255, 0.25) 0%, rgba(255, 154, 162, 0.2) 50%, rgba(168, 200, 255, 0.22) 100%);
            border-radius: 8px;
            position: relative;
        }

        .contact-item {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(110deg, rgba(200, 255, 220, 0.75) 0%, rgba(255, 200, 220, 0.7) 45%, rgba(255, 220, 230, 0.72) 100%);
            position: relative;
        }

        .contact-item:hover {
            background: linear-gradient(110deg, rgba(220, 240, 255, 0.85) 0%, rgba(255, 210, 230, 0.8) 45%, rgba(255, 230, 240, 0.82) 100%);
            transform: translateY(-2px);
        }

        .contact-item.active {
            background: linear-gradient(110deg, rgba(240, 250, 255, 0.95) 0%, rgba(255, 240, 250, 0.9) 45%, rgba(255, 250, 255, 0.92) 100%);
            border: 3px solid var(--border-dark);
            box-shadow: 0 2px 8px rgba(168, 200, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        /* 联系人项 - 未读消息标记 */
        .contact-item.unread::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #FF6B6B;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(255, 107, 107, 0.6);
            z-index: 1;
        }

        .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 220, 100, 0.9) 0%, rgba(255, 200, 150, 0.85) 50%, rgba(255, 180, 200, 0.9) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(255, 200, 100, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .contact-preview {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            color: rgba(47, 47, 47, 0.7);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-area {
            width: 640px;
            display: flex;
            flex-direction: column;
            min-width: 0;
            flex-shrink: 0;
        }

        .chat-header {
            padding: 10px;
            border-bottom: 2px solid var(--border-dark);
            margin-bottom: 10px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
            background: linear-gradient(100deg, rgba(168, 200, 255, 0.2) 0%, rgba(255, 154, 162, 0.18) 50%, rgba(168, 200, 255, 0.19) 100%);
            border-radius: 8px;
        }

        .chat-header .phone-number {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(110deg, rgba(200, 255, 220, 0.75) 0%, rgba(255, 200, 220, 0.7) 45%, rgba(255, 220, 230, 0.72) 100%);
            border-radius: 10px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(168, 200, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .chat-display {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: linear-gradient(125deg, rgba(168, 200, 255, 0.18) 0%, rgba(255, 154, 162, 0.15) 40%, rgba(168, 200, 255, 0.16) 100%);
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
        }


        .chat-bubble {
            max-width: 70%;
            padding: 6px 20px;
            border-radius: 20px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 13px;
            line-height: 1.2;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            min-width: 0;
            position: relative;
            box-shadow: inset 0 8px 5px rgba(255, 255, 255, 0.65), 0 1px 2px rgba(0, 0, 0, 0.2);
            border: solid 1px rgba(0, 0, 0, 0.5);
            margin-bottom: 25px;
            box-sizing: border-box;
            float: left;
            clear: both;
        }

        .chat-bubble.left {
            align-self: flex-start;
            background: linear-gradient(to top, #ffd700 0%, #ffeb3b 15%);
            color: var(--text-dark);
            font-weight: bold;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
        }


        .chat-bubble.left:before,
        .chat-bubble.left:after {
            border-radius: 20px / 5px;
            content: '';
            display: block;
            position: absolute;

        }

        .chat-bubble.left:before {
            border: 7px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.8);
            bottom: 0px;
            left: -6px;
            z-index: 1;
        }

        .chat-bubble.left:after {
            border: 7px solid transparent;
            border-bottom-color: #fbe981;
            bottom: 1px;
            left: -4px;
            right: auto;
            z-index: 2;
            /* 在before上面 */
        }

        .chat-bubble.right {
            align-self: flex-end;
            background-image: linear-gradient(to top, #3d7eff 0%, #7bb3ff 25%);
            color: #000;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
            font-weight: bold;
            float: right;
        }

        .chat-bubble.right:before,
        .chat-bubble.right:after {
            border-radius: 20px / 5px;
            content: '';
            display: block;
            position: absolute;

        }

        /* 右侧聊天气泡 - 左侧箭头（边框层） */
        .chat-bubble.right:before {
            border: 7px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.8);
            bottom: 0px;
            right: -6px;
            left: auto;
            z-index: 1;
        }

        /* 右侧聊天气泡 - 左侧箭头（背景层） */
        .chat-bubble.right:after {
            border: 7px solid transparent;
            border-bottom-color: #86beec;
            bottom: 1px;
            right: -4px;
            left: auto;
            z-index: 2;
        }




        .chat-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
            font-weight: bold;
            position: absolute;
            bottom: -18px;
            left: 0;
            white-space: nowrap;
        }

        .chat-bubble.right .chat-time {
            right: 0;
            left: auto;
        }


        .reply-bar {
            display: flex;
            gap: 8px;
        }

        .reply-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 18px;
            outline: none;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 18px;
            color: var(--text-dark);
            background: linear-gradient(115deg, rgba(168, 200, 255, 0.3) 0%, rgba(255, 154, 162, 0.28) 45%, rgba(255, 179, 186, 0.29) 100%);
            transition: all 0.2s;
        }

        .reply-input::placeholder {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
        }

        .reply-input:focus {
            border-color: #0213f7;
            box-shadow: 0 0 0 2px rgba(129, 212, 250, 0.2);
        }

        .btn-send-reply {
            padding: 8px 24px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 138, 128, 0.4), 0 0 15px rgba(255, 138, 128, 0.3);
        }

        .btn-send-reply:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
            border: 2px solid var(--border-dark);
            border-color: #000000;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 82, 82, 0.6), 0 0 25px rgba(255, 82, 82, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .btn-send-reply:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.5), 0 0 18px rgba(255, 82, 82, 0.4);
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
        }

        .btn-send-reply:disabled {
            cursor: not-allowed;
            opacity: 1;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
        }

        /* 滚动条样式 - 渐变效果 */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(135deg, rgba(168, 200, 255, 0.2) 0%, rgba(255, 154, 162, 0.15) 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #a8c8ff 0%, #ff9aa2 50%, #ffb3ba 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8bb5ff 0%, #ff7a8a 50%, #ff9fb3 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Firefox 滚动条 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #a8c8ff rgba(168, 200, 255, 0.2);
        }

        .file-input {
            display: none;
        }

        /* 连接状态指示器 */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid var(--border-dark);
            background: rgba(255, 255, 255, 0.95);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            white-space: nowrap;
        }

        .status-connected {
            background: linear-gradient(135deg, #66ff66 0%, #4CAF50 50%, #81C784 100%);
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .status-disconnected {
            background: #FF8A80;
            color: white;
            border-color: #FF8A80;
            font-weight: bold;
        }

        /* 清空日志按钮 */
        .btn-clear-logs {
            position: absolute;
            bottom: 57px;
            right: 14px;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid var(--border-dark);
            background: linear-gradient(135deg, hwb(83 73% 0% / 0.886) 0%, rgba(227, 255, 14, 0.945) 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 99999;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-clear-logs:hover {
            background: linear-gradient(135deg, rgba(255, 168, 233, 0.886) 0%, rgba(206, 253, 255, 0.945) 100%);
            border-color: #8B00FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
        }

        /* 清空收件箱按钮 */
        .btn-clear-inbox {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid var(--border-dark);
            background: linear-gradient(135deg, hwb(83 73% 0% / 0.886) 0%, rgba(227, 255, 14, 0.945) 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 99999;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-clear-inbox:hover {
            background: linear-gradient(135deg, rgba(255, 168, 233, 0.886) 0%, rgba(206, 253, 255, 0.945) 100%);
            border-color: #8B00FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
        }

        /* 消息气泡通知 */
        .message-bubble-notification {
            position: fixed;
            right: -300px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, rgba(129, 212, 250, 0.9), rgba(129, 212, 250, 0.7));
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            padding: 12px 18px;
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
            animation: slideInBubble 0.5s ease-out forwards, fadeOutBubble 0.5s ease-in 2.5s forwards;
        }

        @keyframes slideInBubble {
            0% {
                right: -300px;
                opacity: 0;
            }

            100% {
                right: 20px;
                opacity: 1;
            }
        }

        @keyframes fadeOutBubble {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                transform: translateY(-50%) scale(0.9);
            }
        }

        /*#endregion */
        /*#region 移动端响应式样式 */
        /* 手机端样式 - 视口边距10px设计 */
        @media (max-width: 768px) {

            /* 1. 重置基础布局 - 边距10px */
            body {
                padding: 10px;
                margin: 0;
                width: 100vw;
                height: 100dvh;
                overflow: hidden;
                -webkit-overflow-scrolling: touch;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: stretch;
                background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
                position: fixed;
                top: 0;
                left: 0;
                box-sizing: border-box;
            }

            /* 2. 主容器 - 边距10px */
            .content-wrapper {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: stretch;
                justify-content: flex-start;
                padding: 0;
                box-sizing: border-box;
                overflow: hidden;
                background: transparent;
                border: none;
                position: relative;
                gap: 6px;
            }

            /* 3. 导航按钮在顶部 - 固定高度50px */
            .nav-container {
                width: 100%;
                height: 50px;
                max-height: 50px;
                min-height: 50px;
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 8px;
                margin: 0;
                padding: 0;
                flex-shrink: 0;
                z-index: 100;
                box-sizing: border-box;
            }

            .nav-buttons {
                display: flex;
                flex-direction: row;
                gap: 12px;
                align-items: center;
                justify-content: flex-start;
                width: 100%;
            }

            .nav-btn {
                flex: 0 0 auto;
                padding: 10px 12px;
                font-size: 12px;
                min-width: 0;
                height: auto;
                border-radius: 25px;
                border: 2px solid var(--border-dark);
                color: var(--text-dark);
                font-weight: bold;
                text-align: center;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            /* 移动端 - 主页面按钮 */
            #navHomeBtn {
                background: linear-gradient(135deg, #b2ff9be6, rgb(208, 255, 1));
            }

            #navHomeBtn:hover {
                background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
                border-color: #0a0909;
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
            }

            #navHomeBtn:active,
            #navHomeBtn.active {
                background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
                border-width: 3px;
                box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
                font-weight: 900;
            }

            #navHomeBtn.active:hover {
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 18px rgba(240, 147, 251, 0.6);
            }

            /* IMessage按钮 - 蓝青色系 */
            #navSendBtn {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
                font-size: 10px;
                padding: 12px 15px;

            }

            #navSendBtn:hover {
                background: linear-gradient(100deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
                border-color: #000002;
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 15px rgba(79, 172, 254, 0.5);
            }

            #navSendBtn:active,
            #navSendBtn.active {
                background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
                border-width: 3px;
                box-shadow: 0 3px 10px rgba(102, 166, 255, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
                font-weight: 900;
            }

            #navSendBtn.active:hover {
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 18px rgba(102, 166, 255, 0.6);

            }

            /* 收件箱按钮 - 橙黄色系 */
            #navInboxBtn {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            }

            #navInboxBtn:hover {
                background: linear-gradient(150deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
                border-color: #000000;
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 15px rgba(252, 182, 159, 0.5);
            }

            #navInboxBtn:active,
            #navInboxBtn.active {
                background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
                border-width: 3px;
                box-shadow: 0 3px 10px rgba(255, 179, 71, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
                font-weight: 900;
            }

            #navInboxBtn.active:hover {
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 18px rgba(255, 179, 71, 0.6);
            }

            /* 主容器 - 固定尺寸 */
            .main-container {
                display: flex;
                gap: 10px;
                width: 1300px;
                height: 580px;
                position: relative;
                max-width: 100vw;
                max-height: 100vh;
                box-sizing: border-box;
            }

            /* 工作区A+B */
            .workspace-ab {
                display: none;
                gap: 10px;
                width: 100%;
                height: 100%;
                position: relative;
            }

            /* A版单独居中显示 */
            .workspace-ab.single-panel {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* A版单独显示时的样式 */
            .workspace-ab.single-panel .panel-a {
                margin: 0 auto;
            }

            /* 显示B版时，恢复正常的flex布局 */
            .workspace-ab.show-log {
                display: flex;
            }

            /* 日志面板按钮 */
            .btn-log-panel {
                position: absolute;
                left: 10px;
                padding: 8px 20px;
                border: 2px solid var(--border-dark);
                border-radius: 20px;
                background: linear-gradient(135deg, hsla(341, 100%, 63%, 0.949) 0%, hsl(273, 100%, 85%) 50%, #ffec8ff2 100%);
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
                font-size: 12px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3), 0 0 15px rgba(255, 152, 0, 0.2);
                white-space: nowrap;
            }

            .btn-log-panel:hover {
                background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
                border-color: #FF9800;
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5), 0 0 25px rgba(255, 152, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            }

            .btn-log-panel:active {
                transform: translateY(-1px) scale(0.98);
                box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4), 0 0 15px rgba(255, 152, 0, 0.3);
                background: linear-gradient(135deg, rgba(255, 180, 80, 0.95) 0%, rgba(255, 160, 60, 0.9) 50%, rgba(255, 140, 40, 0.95) 100%);
            }

            .btn-log-panel.active {
                background: linear-gradient(135deg, rgba(202, 136, 255, 0.3) 0%, rgb(255, 70, 190) 50%, rgb(255, 130, 136) 100%);
                border-color: #8B00FF;
                box-shadow: 0 4px 15px rgba(139, 0, 255, 0.4), 0 0 20px rgba(139, 0, 255, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.2);
            }

            .btn-log-panel.active:hover {
                background: linear-gradient(135deg, rgba(233, 90, 255, 0.924) 0%, hsl(270, 100%, 81%) 50%, rgb(102, 126, 234) 100%);
                box-shadow: 0 6px 20px rgba(139, 0, 255, 0.5), 0 0 25px rgba(139, 0, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            }


            /* 4. 主容器区域 - 填充剩余空间 */
            .main-container {
                flex: 1;
                width: 100%;
                display: flex;
                align-items: stretch;
                justify-content: flex-start;
                overflow: hidden;
                position: relative;
                border: 3px solid var(--border-dark);
                border-radius: 15px;
                background: rgba(255, 255, 255, 0.1);
                box-sizing: border-box;
            }

            /* 5. 所有面板的通用样式 - 绝对定位填满容器 */
            .workspace-ab,
            .panel-b,
            .panel-c,
            .panel-d {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none;
                flex-direction: column;
                overflow: hidden;
                box-sizing: border-box;
                border-radius: 12px;
            }

            /* 激活的面板显示 */
            .workspace-ab.mobile-show,
            .panel-b.mobile-show,
            .panel-c.mobile-show,
            .panel-d.mobile-show,
            .panel-e.mobile-show {
                display: flex !important;
            }

            /* 6. 主页面板D */
            .panel-d {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
                justify-content: center;
                align-items: center;
                padding: 20px;
            }

            .panel-d .main-title {
                font-size: 36px;
                letter-spacing: 2px;
                line-height: 1.2;
                text-align: center;
                padding: 0 10px;
            }

            .panel-d .main-subtitle {
                font-size: 12px;
                letter-spacing: 4px;
                margin-top: 15px;
                padding: 0 10px;
                text-align: center;
            }

            /* 7. 发送面板A（单独显示） */
            .workspace-ab {
                background: transparent;
            }

            .panel-a {
                width: 100%;
                height: 100%;
                background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
                border-radius: 12px;
                border: none;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .panel-a:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(178, 157, 255, 0.4);
            }

            .panel-a .panel-header {
                height: 35px;
                padding: 0 10px;
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--border-dark);
                background: linear-gradient(0.3turn, #f072ee, #896bf7, #66ddf8);
            }

            /* A板内容区域 - 垂直排列号码和内容 */
            .content-area {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 4px;
                padding: 4px;
                overflow: hidden;
                min-height: 0;
            }

            .numbers-container,
            .message-container {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                min-height: 0;
                border-radius: 8px;
                border: 2px solid var(--border-dark);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                box-sizing: border-box;
                transition: all 0.3s ease;
            }

            /* 号码输入框高度增加 */
            .numbers-container {
                flex: 3;
                background: linear-gradient(0.25turn, #fdc4f0, hsl(200, 84%, 88%), #edc7ff);
            }

            .numbers-container:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(253, 196, 240, 0.5);
            }

            /* 内容输入框高度减小到约2/3 */
            .message-container {
                flex: 2;
                background: linear-gradient(45deg, #ffddff 0%, #ffc9e6 50%, #a4ffff 100%);
            }

            .message-container:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 201, 230, 0.5);
            }

            .input-header {
                padding: 4px 8px;
            }

            .input-area {
                flex: 1;
                min-height: 0;
                position: relative;
            }

            textarea {
                width: 100%;
                height: 100%;
                padding: 6px;
                border: none;
                outline: none;
                resize: none;
                font-size: 16px;
                font-weight: bold;
                background: transparent;
                box-sizing: border-box;
                -webkit-appearance: none;
                appearance: none;
                transform: none !important;
                max-height: none !important;
            }

            /* 8. A板底部控制栏 - 两行布局 */
            .control-bar {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                padding: 4px;
                gap: 4px;
                flex-shrink: 0;
                position: relative;
                align-items: center;
            }

            /* 第一行：日志面板按钮在左 */
            .btn-log-panel {
                position: static;
                flex-shrink: 0;
                white-space: nowrap;
                padding: 6px 12px;
                font-size: 12px;
                transition: all 0.3s ease;
                order: 1;
            }

            .btn-log-panel:hover {
                background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
                border-color: #FF9800;
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
            }

            .btn-log-panel:active {
                transform: scale(0.98);
                box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
            }

            /* 第一行：发送间隔居中靠右 */
            .interval-control {
                display: flex;
                align-items: center;
                gap: 4px;
                flex-shrink: 0;
                white-space: nowrap;
                margin-left: auto;
                order: 2;
            }

            .interval-select {
                transition: all 0.2s ease;
            }

            .interval-select:hover {
                border-color: #8B00FF;
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(139, 0, 255, 0.2);
            }

            /* 第一行：发送按钮在右 */
            .btn-send {
                flex-shrink: 0;
                white-space: nowrap;
                padding: 6px 15px;
                font-size: 12px;
                transition: all 0.3s ease;
                order: 3;
            }

            /* 第二行：统计栏独占一行 */
            .stats-bar-inline {
                display: flex !important;
                flex: 0 0 100% !important;
                width: 100% !important;
                min-width: 100% !important;
                justify-content: space-around;
                gap: 4px;
                padding: 4px 6px;
                background: linear-gradient(0.3turn, rgba(235, 185, 234, 0.6) 0%, rgba(178, 157, 255, 0.6) 50%, rgba(155, 236, 254, 0.6) 100%);
                border-radius: 6px;
                font-size: 10px;
                flex-wrap: wrap;
                visibility: visible !important;
                opacity: 1 !important;
                order: 4;
                margin-left: 0 !important;
                margin-right: 0 !important;
                transition: all 0.3s ease;
            }

            .stats-bar-inline:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(178, 157, 255, 0.4);
            }

            .stats-bar-inline .stat-item {
                flex: 0 0 auto;
                white-space: nowrap;
            }

            .btn-send:hover:not(:disabled) {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(151, 117, 250, 0.5);
                background: linear-gradient(135deg, #b24dfb 0%, #ff68fc 50%, #519fe9 100%);
            }

            .btn-send:active:not(:disabled) {
                transform: scale(0.98);
            }

            /* 回复按钮hover效果 */
            .btn-send-reply {
                transition: all 0.3s ease;
            }

            .btn-send-reply:hover:not(:disabled) {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 82, 82, 0.5);
            }

            .btn-send-reply:active:not(:disabled) {
                transform: scale(0.98);
            }

            /* 清空按钮hover效果 */
            .btn-clear-inbox,
            .btn-clear-logs,
            .btn-clear-logs-mobile {
                transition: all 0.3s ease;
            }

            .btn-clear-inbox:hover,
            .btn-clear-logs:hover,
            .btn-clear-logs-mobile:hover {
                background: linear-gradient(135deg, rgba(255, 168, 233, 0.9) 0%, rgba(206, 253, 255, 0.95) 100%);
                border-color: #8B00FF;
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(139, 0, 255, 0.3);
            }

            /* 图标按钮hover效果 */
            .btn-icon {
                transition: all 0.3s ease;
            }

            .btn-icon:hover {
                background: linear-gradient(135deg, rgba(139, 0, 255, 0.15), rgba(139, 0, 255, 0.1));
                border-color: #8B00FF;
                transform: scale(1.1);
                box-shadow: 0 3px 6px rgba(139, 0, 255, 0.2);
            }

            .btn-icon:active {
                transform: scale(0.95);
            }

            /* 9. 桌面端B面板隐藏 */
            .panel-b.desktop-only {
                display: none !important;
            }

            /* 移动端B面板（独立页面，和A/C同样大小位置） */
            .panel-b-mobile {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(to right, #8ad3f7 0%, #9becd1 100%);
                border-radius: 12px;
                border: none;
                display: none;
                flex-direction: column;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .panel-b-mobile:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(138, 211, 247, 0.4);
            }

            .panel-b-mobile.mobile-show {
                display: flex !important;
            }

            .panel-b-mobile .panel-header {
                height: 35px;
                padding: 0 10px;
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--border-dark);
                background: linear-gradient(to right, #90a2f5 0%, #6bf3dd 100%);
                display: flex;
                align-items: center;
                flex-shrink: 0;
            }

            /* B面板内容区域 */
            .panel-b-mobile .panel-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                position: relative;
                overflow: hidden;
                padding: 4px;
            }

            .panel-b-mobile .log-box {
                flex: 1;
                margin-bottom: 4px;
                background: linear-gradient(135deg, #e6d2d8 0%, #a8edea 100%);
                border: 2px solid var(--border-dark);
                border-radius: 8px;
                padding: 6px;
                overflow-y: auto;
                font-size: 14px;
                color: var(--text-dark);
                transition: all 0.3s ease;
            }

            .panel-b-mobile .log-box:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(168, 237, 234, 0.4);
            }

            .panel-b-mobile .stats-bar {
                flex-shrink: 0;
                margin-top: 0;
                margin-bottom: 4px;
                display: flex;
                gap: 4px;
                padding: 4px 6px;
                background: linear-gradient(135deg, rgba(138, 211, 247, 0.85) 0%, rgba(155, 236, 209, 0.8) 50%, rgba(138, 211, 247, 0.85) 100%);
                border-radius: 6px;
                font-size: 10px;
                flex-wrap: wrap;
                justify-content: space-around;
                transition: all 0.3s ease;
            }

            .panel-b-mobile .stats-bar:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(138, 211, 247, 0.4);
            }

            .panel-b-mobile .stats-bar .stat-item {
                white-space: nowrap;
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            }

            .panel-b-mobile .stats-bar .stat-value {
                font-weight: bold;
            }

            /* 移动端B面板统计栏颜色（6个不同颜色，与A版一致） */
            #taskCountMobile {
                color: #9C27B0;
                /* 紫色 */
            }

            #phoneCountMobile {
                color: #2196F3;
                /* 蓝色 */
            }

            #totalSentCountMobile {
                color: #00BCD4;
                /* 青色 */
            }

            #successCountMobile {
                color: #4CAF50;
                /* 绿色 */
            }

            #failCountMobile {
                color: #FF5252;
                /* 红色 */
            }

            #successRateMobile {
                color: #FF9800;
                /* 橙色 */
            }

            /* B面板底部控制栏 */
            .panel-b-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 0 0 0;
                flex-shrink: 0;
            }

            /* B面板的返回按钮样式 - 和A面板日志按钮位置一致 */
            .btn-back-to-send {
                padding: 8px 20px;
                border: 2px solid var(--border-dark);
                border-radius: 20px;
                background: linear-gradient(135deg, hsla(341, 100%, 63%, 0.949) 0%, hsl(273, 100%, 85%) 50%, #ffec8ff2 100%);
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
                font-size: 12px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3), 0 0 15px rgba(255, 152, 0, 0.2);
                white-space: nowrap;
            }

            .btn-back-to-send:hover {
                background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
                border-color: #FF9800;
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5), 0 0 25px rgba(255, 152, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            }

            .btn-back-to-send:active {
                transform: translateY(-1px) scale(0.98);
                box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4), 0 0 15px rgba(255, 152, 0, 0.3);
                background: linear-gradient(135deg, rgba(255, 180, 80, 0.95) 0%, rgba(255, 160, 60, 0.9) 50%, rgba(255, 140, 40, 0.95) 100%);
            }

            /* 清空日志按钮样式 */
            .btn-clear-logs-mobile {
                padding: 6px 14px;
                border-radius: 20px;
                border: 2px solid var(--border-dark);
                background: linear-gradient(135deg, hwb(83 73% 0% / 0.886) 0%, rgba(227, 255, 14, 0.945) 100%);
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
                font-size: 11px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }

            .btn-clear-logs-mobile:hover {
                background: linear-gradient(135deg, rgba(255, 168, 233, 0.886) 0%, rgba(206, 253, 255, 0.945) 100%);
                border-color: #8B00FF;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
            }

            /* 10. 收件箱面板C - 上下布局 */
            .panel-c {
                background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
                border: none;
                transition: all 0.3s ease;
            }

            .panel-c:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(193, 240, 255, 0.4);
            }

            .panel-c .panel-header {
                height: 35px;
                padding: 0 10px;
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--border-dark);
                background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.851) 35%, hsla(76, 100%, 80%, 0.902) 70%, rgba(216, 255, 172, 0.85) 100%);
            }

            .panel-c .inbox-layout {
                display: flex;
                flex-direction: column;
                height: 100%;
                width: 100%;
                gap: 4px;
                padding: 4px;
                box-sizing: border-box;
                overflow: hidden;
            }

            /* 联系人列表在上 */
            .panel-c .contact-list {
                width: 100%;
                flex: 2;
                min-height: 100px;
                border: 2px solid var(--border-dark);
                border-radius: 8px;
                padding: 4px;
                overflow-y: auto;
                background: linear-gradient(120deg, rgba(168, 200, 255, 0.25) 0%, rgba(255, 154, 162, 0.2) 50%, rgba(168, 200, 255, 0.22) 100%);
                transition: all 0.3s ease;
            }

            .panel-c .contact-list:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(168, 200, 255, 0.4);
            }

            /* 联系人项hover效果 */
            .panel-c .contact-item {
                transition: all 0.2s ease;
            }

            .panel-c .contact-item:hover {
                background: linear-gradient(110deg, rgba(220, 240, 255, 0.85) 0%, rgba(255, 210, 230, 0.8) 45%, rgba(255, 230, 240, 0.82) 100%);
                transform: translateX(3px);
            }

            /* 聊天区域在下 */
            .panel-c .chat-area {
                flex: 3;
                display: flex;
                flex-direction: column;
                min-height: 0;
                overflow: hidden;
            }

            .panel-c .chat-display {
                padding: 4px;
            }

            /* 回复栏在最底部 */
            .panel-c .reply-bar {
                flex-shrink: 0;
                padding: 4px 0 0 0;
                gap: 4px;
            }

            /* 11. 防止iOS输入框缩放 */
            html {
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }

            textarea,
            input {
                font-size: 16px !important;
                -webkit-user-select: text;
                user-select: text;
            }

            /* 12. 字符计数器调整 */
            .char-count {
                font-size: 10px;
                bottom: 5px;
                right: 8px;
                padding: 2px 6px;
            }

            /* 13. 确保所有内容不超出容器 */
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
        }
        /*#endregion */
    </style>
    <!-- 登录页面样式 -->
    <style>
        /*#region 登录页面样式 */
        @font-face {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            src: url('./test/Xiaolai.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --text-dark: #2F2F2F;
            --border-dark: #2F2F2F;
            --shadow: rgba(0, 0, 0, 0.1);
            --hacker-green: #00ff41;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *,
        *::before,
        *::after {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif !important;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* 登录页面显示时的 body 样式（通过类名控制） */
        body.login-mode {
            flex-direction: column;
            padding-top: 0;
        }

        /* ==================== 登录页面 ==================== */
        .login-page {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* 登录页标题区域（类似 panelD） */
        .login-title-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            animation: titleFadeIn 0.8s ease-out;
        }

        @keyframes titleFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-main-title {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 72px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #634ffe 75%, #bd00fe 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: 4px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
            position: relative;
            line-height: 1.2;
            margin-bottom: 10px;
        }

        .login-main-subtitle {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: rgba(47, 47, 47, 0.6);
            text-align: center;
            letter-spacing: 8px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        /* 右上角管理员入口 */
        .admin-entry-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            border: 2px solid var(--border-dark);
            border-radius: 25px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(10px);
            color: var(--text-dark);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 100;
        }

        .admin-entry-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.25) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .admin-entry-btn:active {
            transform: translateY(0);
        }

        .admin-entry-btn svg {
            width: 16px;
            height: 16px;
        }

        /* 登录面板 - 玻璃质感效果（Glassmorphism） */
        .login-panel {
            width: 370px;
            /* 半透明背景，带轻微渐变 */
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.25) 0%, 
                rgba(255, 255, 255, 0.15) 50%, 
                rgba(255, 255, 255, 0.2) 100%);
            /* 毛玻璃模糊效果 */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 18px;
            /* 半透明边框，带高光 */
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            overflow: hidden;
            animation: panelFloat 0.6s ease-out;
            margin-top: 20px;
            /* 增强立体感 */
            position: relative;
        }

        /* 玻璃面板内部高光效果 */
        .login-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.6) 50%, 
                transparent 100%);
            pointer-events: none;
        }

        /* 管理员登录面板 - 黑色主题 */
        .login-panel.admin-mode {
            background: linear-gradient(135deg, 
                rgba(30, 30, 30, 0.9) 0%, 
                rgba(20, 20, 20, 0.85) 50%, 
                rgba(15, 15, 15, 0.9) 100%);
            border: 2px solid rgba(60, 60, 60, 0.6);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        @keyframes panelFloat {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 面板头部 - 玻璃质感 */
        .login-panel-header {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.2) 0%, 
                rgba(255, 255, 255, 0.15) 50%, 
                rgba(255, 255, 255, 0.1) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            position: relative;
        }

        /* 头部底部高光 */
        .login-panel-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.5) 50%, 
                transparent 100%);
        }

        /* 面板头部 - Admin模式 */
        .login-panel.admin-mode .login-panel-header {
            background: linear-gradient(135deg, 
                rgba(40, 40, 40, 0.8) 0%, 
                rgba(30, 30, 30, 0.7) 50%, 
                rgba(25, 25, 25, 0.8) 100%);
            border-bottom: 1px solid rgba(80, 80, 80, 0.5);
        }

        .login-logo {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin: 0;
            letter-spacing: 1px;
        }
        
        /* 管理员模式下文字颜色改为白色 */
        .login-panel.admin-mode .login-logo {
            color: rgba(255, 255, 255, 0.95);
        }
        
        .login-panel.admin-mode .form-input {
            background: rgba(50, 50, 50, 0.6);
            border-color: rgba(100, 100, 100, 0.5);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .login-panel.admin-mode .form-input::placeholder {
            color: rgba(200, 200, 200, 0.6);
        }
        
        .login-panel.admin-mode .form-input:focus {
            background: rgba(60, 60, 60, 0.7);
            border-color: rgba(150, 150, 150, 0.7);
            color: rgba(255, 255, 255, 1);
        }
        
        /* 管理员模式下的标签和文字 */
        .login-panel.admin-mode .form-label,
        .login-panel.admin-mode .modal-label,
        .login-panel.admin-mode label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .login-panel.admin-mode .forgot-password-link {
            color: rgba(200, 200, 255, 0.9);
        }
        
        .login-panel.admin-mode .forgot-password-link:hover {
            color: rgba(255, 255, 255, 1);
        }

        .login-subtitle {
            display: none;
        }

        /* 面板内容 - 保持透明 */
        .login-panel-content {
            padding: 15px 20px;
            background: transparent;
        }

        /* User/Admin 切换按钮组 */
        .user-admin-toggle {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 12px;
        }

        .toggle-btn {
            flex: none;
            padding: 6px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            color: var(--text-dark);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        /* 隐藏User按钮 */
        .toggle-btn#userToggle {
            display: none;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #c5f6df 0%, #75baff 50%, #f0b3ff 100%);
            box-shadow: 0 2px 8px rgba(117, 186, 255, 0.3);
            border-width: 3px;
        }

        .login-panel.admin-mode .toggle-btn.active,
        .toggle-btn.btn-admin.active {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            box-shadow: 0 2px 8px rgba(15, 52, 96, 0.5);
            color: #ffd700;
            border-width: 3px;
            border-color: #ffd700;
        }

        .toggle-btn.btn-admin:not(.active) {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #1a1a2e 100%);
            color: #ecf0f1;
            border-color: #34495e;
        }
        
        /* 管理员模式下User按钮（非激活状态）的样式 - 适配黑色主题 */
        .login-panel.admin-mode .toggle-btn.btn-admin:not(.active) {
            background: linear-gradient(135deg, rgba(60, 60, 60, 0.8) 0%, rgba(50, 50, 50, 0.8) 50%, rgba(40, 40, 40, 0.8) 100%);
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(120, 120, 120, 0.6);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .toggle-btn.btn-admin:not(.active):hover {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffd700;
            border-color: #ffd700;
            transform: translateX(-3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(15, 52, 96, 0.6);
        }
        
        /* 管理员模式下User按钮hover状态 - 适配黑色主题 */
        .login-panel.admin-mode .toggle-btn.btn-admin:not(.active):hover {
            background: linear-gradient(135deg, rgba(80, 80, 80, 0.9) 0%, rgba(70, 70, 70, 0.9) 50%, rgba(60, 60, 60, 0.9) 100%);
            color: rgba(255, 255, 255, 1);
            border-color: rgba(180, 180, 180, 0.8);
            transform: translateX(-3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .toggle-btn:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            transform: translateX(3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(117, 186, 255, 0.4);
        }

        .login-panel.admin-mode .toggle-btn:hover {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffd700;
            border-color: #ffd700;
            transform: translateX(-3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(15, 52, 96, 0.6);
        }

        /* 表单组 */
        .form-group {
            margin-bottom: 12px;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .password-wrapper {
            position: relative;
            width: 90%;
            display: flex;
            justify-content: center;
        }

        .password-wrapper .form-input {
            width: 100%;
        }

        .show-password-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-dark);
            font-size: 14px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .show-password-btn:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.05);
        }

        .forgot-password {
            text-align: right;
            margin-top: -8px;
            margin-bottom: 10px;
        }

        .forgot-password-link {
            color: rgba(47, 47, 47, 0.7);
            font-size: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .forgot-password-link:hover {
            color: #8B00FF;
            text-decoration: underline;
        }

        .form-input {
            width: 90%;
            padding: 10px 14px;
            border: 2px solid rgba(47, 47, 47, 0.3);
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
            /* 玻璃质感输入框 */
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            outline: none;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .form-input::placeholder {
            color: rgba(47, 47, 47, 0.5);
            font-weight: 600;
        }

        .form-input:focus {
            border-color: rgba(139, 0, 255, 0.6);
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 0 0 4px rgba(139, 0, 255, 0.15),
                0 4px 12px rgba(139, 0, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        /* 按钮样式 */
        .btn-group {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-top: 15px;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-group.vertical {
            flex-direction: column;
        }

        .btn-primary {
            flex: none;
            width: 20%;
            max-width: 20%;
            min-width: 0;
            padding: 10px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, #c5f6df 0%, #75baff 50%, #f0b3ff 100%);
            color: var(--text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            box-sizing: border-box;
        }

        .login-panel.admin-mode .btn-primary {
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .login-panel.admin-mode .btn-primary:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
        }

        .btn-primary:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .login-panel.admin-mode .btn-primary:active {
            background: linear-gradient(120deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .btn-secondary {
            flex: none;
            width: 20%;
            max-width: 20%;
            min-width: 0;
            padding: 10px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        /* 注册按钮特殊效果 */
        .btn-register {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%) !important;
        }

        .btn-register:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%) !important;
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .btn-register:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%) !important;
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        /* Admin按钮特殊效果 */
        .btn-admin {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%) !important;
        }

        .btn-admin:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%) !important;
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(79, 172, 254, 0.5);
        }

        .btn-admin:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%) !important;
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(102, 166, 255, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .login-panel.admin-mode .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 200, 200, 0.8) 0%, rgba(255, 180, 180, 0.6) 100%);
        }

        .btn-secondary:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .login-panel.admin-mode .btn-secondary:hover {
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
            color: white;
        }

        .btn-secondary:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .login-panel.admin-mode .btn-secondary:active {
            background: linear-gradient(120deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        /* 消息提示 */
        .message-box {
            margin-top: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            display: none;
            position: relative;
            z-index: 99999;
        }

        .message-box.error {
            display: block;
            background: linear-gradient(135deg, #ffcdd2 0%, #ffab91 100%);
            border: 2px solid #e57373;
            color: #c62828;
        }

        .message-box.success {
            display: block;
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border: 2px solid #81c784;
            color: #2e7d32;
        }

        /* ==================== 自定义弹窗样式 ==================== */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            /* 移除 backdrop-filter 以提升性能，改用更深的半透明背景 */
            /* backdrop-filter: blur(10px); */
            /* -webkit-backdrop-filter: blur(10px); */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            /* 始终保持display: flex，只改变opacity和visibility，隐藏时禁用交互 */
        }

        .custom-modal-overlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .custom-modal-panel {
            width: 400px;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            /* 优化动画：只使用opacity和轻微的scale，使用更平滑的缓动函数 */
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity;
        }
        
        .custom-modal-overlay.show .custom-modal-panel {
            transform: scale(1);
            opacity: 1;
        }

        .custom-modal-panel.admin-manage-modal {
            width: 600px;
            max-width: 90vw;
        }

        /* ==================== 管理员密码弹窗 ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            /* 移除 backdrop-filter 以提升性能，改用更深的半透明背景 */
            /* backdrop-filter: blur(10px); */
            /* -webkit-backdrop-filter: blur(10px); */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            /* 始终保持display: flex，只改变opacity和visibility，隐藏时禁用交互 */
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .modal-panel {
            width: 380px;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            /* 优化动画：只使用opacity和轻微的scale，使用更平滑的缓动函数 */
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity;
        }
        
        .modal-overlay.show .modal-panel {
            transform: scale(1);
            opacity: 1;
        }



        /* 自定义弹窗内容 */
        .custom-modal-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.9) 35%, hsla(76, 100%, 80%, 0.9) 70%, rgba(216, 255, 172, 0.9) 100%);
            padding: 15px 20px;
            border-bottom: 3px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-modal-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .custom-modal-close {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .custom-modal-close:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            transform: rotate(90deg);
        }

        .custom-modal-content {
            padding: 20px;
        }

        .custom-modal-message {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .custom-modal-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .custom-modal-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 4px rgba(139, 0, 255, 0.15);
        }

        .custom-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .custom-modal-btn {
            flex: none;
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .custom-modal-btn.cancel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
        }

        .custom-modal-btn.cancel:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .custom-modal-btn.confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .custom-modal-btn.confirm:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .custom-modal-btn:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .modal-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.9) 35%, hsla(76, 100%, 80%, 0.9) 70%, rgba(216, 255, 172, 0.9) 100%);
            padding: 18px 25px;
            border-bottom: 3px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-close:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            transform: rotate(90deg);
        }

        .modal-content {
            padding: 25px;
        }

        .modal-label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .modal-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            margin-bottom: 20px;
        }

        .modal-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 4px rgba(139, 0, 255, 0.15);
        }

        .modal-btn {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 14px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(252, 182, 159, 0.4);
        }

        .modal-btn:hover {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 50%, #ee5a24 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .modal-message {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .modal-message.error {
            display: block;
            background: #ffebee;
            border: 2px solid #ef9a9a;
            color: #c62828;
        }

        /* ==================== 服务器管理面板 ==================== */
        .admin-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
            z-index: 100;
        }

        .admin-page.show {
            display: block;
        }

        /* ==================== 管理员页面 ==================== */
        .manager-page {
            display: none;
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }

        .manager-page.show {
            display: block;
        }

        .manager-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .manager-header {
            background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .manager-header-left {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
        }

        /* 管理员数据面板 */
        .admin-data-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 20px;
            padding: 15px 0;
        }

        .admin-data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .admin-data-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .admin-data-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
        }

        /* 面板标题行 */
        .panel-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            margin: 0;
        }

        .add-user-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .add-user-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* 用户按钮网格 */
        .user-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* 用户按钮样式 - 炫彩渐变色 */
        .user-button {
            position: relative;
            padding: 15px 20px;
            background: linear-gradient(135deg, 
                rgba(255, 154, 162, 0.9) 0%, 
                rgba(255, 206, 84, 0.9) 25%,
                rgba(168, 255, 120, 0.9) 50%,
                rgba(120, 219, 255, 0.9) 75%,
                rgba(200, 181, 255, 0.9) 100%);
            border: 3px solid var(--border-dark);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15),
                        0 0 30px rgba(255, 154, 162, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        .user-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 70%);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .user-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.2),
                        0 0 40px rgba(255, 154, 162, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .user-button-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 圆形背景 - 彩色 */
        .user-server-count-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 25%, #c44569 50%, #ff6b6b 75%, #ee5a6f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5),
                        inset 0 2px 5px rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .user-button-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .user-button-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-id-text {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-manage-btn {
            padding: 6px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid var(--border-dark);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .user-manage-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .user-button-stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #555;
            margin-top: 5px;
        }

        .user-stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-stat-label {
            font-weight: 500;
        }

        .user-stat-value {
            font-weight: bold;
            color: var(--text-dark);
        }

        /* 新服务器按钮样式 */
        .server-buttons-grid-new {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            margin-top: 15px;
        }

        .server-buttons-grid-new > button,
        .server-buttons-grid-new button {
            flex: none;
            width: 50px;
            height: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffa500 100%);
            cursor: pointer;
            transition: transform 0.6s ease, box-shadow 0.3s ease, opacity 0.3s ease;
            filter: none;
            opacity: 1;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4), 0 0 20px rgba(255, 165, 0, 0.3);
            text-align: center;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            position: relative;
            overflow: visible;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 1;
            perspective: 1000px;
            transform-style: preserve-3d;
        }

        .server-buttons-grid-new > button::before,
        .server-buttons-grid-new button::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: repeating-conic-gradient(from 0deg, rgba(255, 215, 0, 0.8) 0deg 30deg, rgba(255, 237, 78, 0.8) 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, rgba(255, 165, 0, 0.8) 0deg 20deg, rgba(255, 215, 0, 0.8) 40deg 60deg, transparent 90deg);
            background-size: 200% 200%;
            opacity: 0.6;
            filter: blur(2px);
            animation: rotate 8s linear infinite;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .server-buttons-grid-new > button::after,
        .server-buttons-grid-new button::after {
            content: '';
            position: absolute;
            inset: 10%;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.6), rgba(255, 237, 78, 0.6), rgba(255, 165, 0, 0.6));
            opacity: 0.4;
            filter: blur(8px);
            z-index: -2;
            animation: rotate 12s linear infinite reverse;
        }

        .server-buttons-grid-new > button.active,
        .server-buttons-grid-new button.active {
            opacity: 1;
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.6), 0 0 60px rgba(0, 128, 255, 0.4);
            transform: scale(1.1) rotateY(0deg);
            filter: none;
        }

        .server-buttons-grid-new > button.active::before,
        .server-buttons-grid-new button.active::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, rgba(0, 255, 136, 0.9) 0deg 30deg, rgba(0, 128, 255, 0.9) 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, rgba(190, 125, 255, 0.9) 0deg 20deg, rgba(0, 255, 136, 0.9) 40deg 60deg, transparent 90deg);
            animation: rotate 6s linear infinite;
        }

        .server-buttons-grid-new > button.active::after,
        .server-buttons-grid-new button.active::after {
            background: linear-gradient(135deg, #0f0, #00f, #0ff);
            opacity: 0.3;
        }

        .server-buttons-grid-new > button:hover,
        .server-buttons-grid-new button:hover {
            opacity: 1;
            transform: scale(1.05) rotateY(15deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5), 0 0 30px rgba(255, 165, 0, 0.4);
        }
        
        .server-buttons-grid-new > button:active {
            transform: scale(0.95) rotateY(-15deg);
        }

        .server-buttons-grid-new > button.selected,
        .server-buttons-grid-new button.selected {
            opacity: 1;
            background: radial-gradient(circle at top left, #0f0 0%, transparent 50%), 
                        radial-gradient(circle at bottom right, #0f0 0%, transparent 60%);
            box-shadow: 0 0 50px #0f0;
            transform: scale(1.08);
            filter: blur(0.5px);
        }

        .server-buttons-grid-new > button.selected::before,
        .server-buttons-grid-new button.selected::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, #0f0 0deg 30deg, #0ff 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, #0f0 0deg 20deg, #0ff 40deg 60deg, transparent 90deg);
            animation-play-state: running;
        }

        .server-buttons-grid-new > button.selected::after,
        .server-buttons-grid-new button.selected::after {
            background: linear-gradient(135deg, #0f0, #00f, #0ff);
            opacity: 0.3;
        }

        /* 用户详情面板 - 接近正长方形 */
        .user-detail-panel {
            max-width: 900px;
            width: 90vw;
            max-height: 85vh;
            aspect-ratio: 1.2;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .user-detail-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-dark);
            flex-shrink: 0;
        }

        .user-detail-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .user-detail-stat-card {
            padding: 10px;
            background: rgba(139, 0, 255, 0.1);
            border-radius: 8px;
            border: 2px solid rgba(139, 0, 255, 0.2);
        }

        .user-detail-stat-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .user-detail-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-detail-server-section {
            margin-top: 5px;
            flex-shrink: 0;
        }

        .user-detail-server-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-detail-server-hint {
            font-size: 12px;
            color: #888;
            font-style: italic;
        }

        .user-detail-server-explanation {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .user-detail-server-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            max-height: 120px;
            overflow-y: auto;
        }

        .user-detail-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--border-dark);
            flex-shrink: 0;
        }

        .manager-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .manager-section h3 {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .user-manage-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .user-manage-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
        }

        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-cancel-btn {
            padding: 4px 10px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            color: white;
            transition: all 0.2s ease;
        }

        .user-cancel-btn:hover {
            transform: translateX(3px) scale(1.05);
        }

        .create-group-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .create-group-btn:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .group-creation-area {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
        }

        .group-creation-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-select-btn {
            padding: 8px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
        }

        .group-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .group-select-btn.selected {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .user-group-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
        }

        .user-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-group-name {
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-group-actions {
            display: flex;
            gap: 10px;
        }

        .user-group-servers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .server-tag {
            padding: 8px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .server-tag.private {
            background: linear-gradient(135deg, #ffd6e7 0%, #ff9aa2 100%);
        }

        .server-tag.public {
            background: linear-gradient(135deg, #c1f0ff 0%, #9becfe 100%);
        }

        .server-tag-label {
            font-size: 10px;
            color: rgba(47, 47, 47, 0.6);
            margin-top: 5px;
        }

        .admin-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* 服务器管理头部 */
        .server-manager-header {
            background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .server-manager-header h1 {
            font-size: 20px;
            font-weight: 900;
            color: var(--text-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-back-btn {
            padding: 12px 25px;
            border: 2px solid var(--border-dark);
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-back-btn:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            transform: translateY(-2px);
        }

        .admin-back-btn.password-setting-btn {
            background: linear-gradient(135deg, rgba(139, 0, 255, 0.8) 0%, rgba(139, 0, 255, 0.6) 100%);
            color: white;
            padding: 12px 25px;
            font-size: 14px;
            width: auto;
            min-width: auto;
        }

        .admin-back-btn.password-setting-btn:hover {
            background: linear-gradient(135deg, rgba(139, 0, 255, 1) 0%, rgba(100, 0, 200, 1) 100%);
            color: white;
            transform: translateY(-2px);
        }

        /* 添加服务器区域 */
        .server-manager-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .server-manager-section h3 {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 添加服务器表单行 - 三个元素同行 */
        .server-add-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .server-input-group {
            flex: 1;
            min-width: 0;
        }

        .server-input-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 8px;
            height: 20px;
            line-height: 20px;
        }

        .server-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
        }

        .server-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 3px rgba(139, 0, 255, 0.15);
        }

        .server-connect-btn {
            flex: none;
            padding: 8px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .server-connect-btn:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .server-connect-btn:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .server-connect-btn.connecting {
            background: linear-gradient(135deg, #ffb347 0%, #ff9a56 50%, #ff6b6b 100%);
            cursor: not-allowed;
        }

        /* 服务器列表区域 */
        .server-list-section {
            margin-top: 15px;
        }

        .server-list-label {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        /* 服务器按钮网格 */
        .server-buttons-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .server-buttons-grid > button,
        .server-buttons-grid .server-button {
            flex: none;
            width: 60px;
            height: 60px;
            min-width: 60px;
            max-width: 60px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffa500 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            filter: none;
            opacity: 1;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4), 0 0 20px rgba(255, 165, 0, 0.3);
            text-align: center;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            position: relative;
            z-index: 1;
            perspective: 1000px;
            transform-style: preserve-3d;
        }

        .server-buttons-grid > button::before,
        .server-buttons-grid .server-button::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: repeating-conic-gradient(from 0deg, rgba(255, 215, 0, 0.8) 0deg 30deg, rgba(255, 237, 78, 0.8) 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, rgba(255, 165, 0, 0.8) 0deg 20deg, rgba(255, 215, 0, 0.8) 40deg 60deg, transparent 90deg);
            background-size: 200% 200%;
            opacity: 0.6;
            filter: blur(2px);
            animation: rotate 8s linear infinite;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .server-buttons-grid > button::after,
        .server-buttons-grid .server-button::after {
            content: '';
            position: absolute;
            inset: 10%;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.6), rgba(255, 237, 78, 0.6), rgba(255, 165, 0, 0.6));
            opacity: 0.4;
            filter: blur(8px);
            z-index: -2;
            animation: rotate 12s linear infinite reverse;
        }

        .server-buttons-grid > button.active,
        .server-buttons-grid .server-button.active {
            opacity: 1;
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.6), 0 0 60px rgba(0, 128, 255, 0.4);
            transform: scale(1.1) rotateY(0deg);
            filter: none;
        }

        .server-buttons-grid > button.active::before,
        .server-buttons-grid .server-button.active::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, rgba(0, 255, 136, 0.9) 0deg 30deg, rgba(0, 128, 255, 0.9) 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, rgba(190, 125, 255, 0.9) 0deg 20deg, rgba(0, 255, 136, 0.9) 40deg 60deg, transparent 90deg);
            animation: rotate 6s linear infinite;
        }

        .server-buttons-grid > button.active::after,
        .server-buttons-grid .server-button.active::after {
            background: linear-gradient(135deg, #0f0, #00f, #0ff);
            opacity: 0.3;
        }

        .server-buttons-grid > button:hover,
        .server-buttons-grid .server-button:hover {
            opacity: 1;
            transform: scale(1.05) rotateY(15deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5), 0 0 30px rgba(255, 165, 0, 0.4);
        }
        
        /* 添加翻转动画效果 */
        .server-buttons-grid > button,
        .server-buttons-grid .server-button {
            transition: transform 0.6s ease, box-shadow 0.3s ease, opacity 0.3s ease;
        }
        
        .server-buttons-grid > button:hover {
            transform: scale(1.05) rotateY(15deg);
        }
        
        .server-buttons-grid > button:active {
            transform: scale(0.95) rotateY(-15deg);
        }

        .server-buttons-grid > button:hover .server-tooltip,
        .server-buttons-grid .server-button:hover .server-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(-10px);
        }

        .server-buttons-grid > button:active,
        .server-buttons-grid .server-button:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }

        .server-tooltip {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 99999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .server-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .server-buttons-grid > button.connecting,
        .server-buttons-grid .server-button.connecting {
            background: linear-gradient(135deg, #ffb347 0%, #ff9a56 50%, #ff6b6b 100%);
            cursor: not-allowed;
            color: white;
        }

        .server-buttons-grid > button.connected,
        .server-buttons-grid .server-button.connected {
            background: linear-gradient(135deg, #00ff88 0%, #4caf50 50%, #66bb6a 100%);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.5), 0 0 25px rgba(76, 175, 80, 0.4);
            opacity: 1;
            filter: none;
        }
        
        .server-buttons-grid > button.connected::before {
            background: repeating-conic-gradient(from 0deg, rgba(0, 255, 136, 0.8) 0deg 30deg, rgba(76, 175, 80, 0.8) 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, rgba(102, 187, 106, 0.8) 0deg 20deg, rgba(0, 255, 136, 0.8) 40deg 60deg, transparent 90deg);
            animation: rotate 8s linear infinite;
        }

        .server-buttons-grid > button.disconnected,
        .server-buttons-grid .server-button.disconnected {
            background: linear-gradient(135deg, #ffcdd2 0%, #ffab91 100%);
            position: relative;
            padding-right: 80px;
        }

        .server-buttons-grid > button.disconnected .server-action-btn,
        .server-buttons-grid .server-button.disconnected .server-action-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* 自动消失的提示样式 */
        .auto-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 99999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .auto-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .auto-toast-success {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }

        .auto-toast-info {
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
        }

        .auto-toast-error {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }

        .server-buttons-grid .server-button-name {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .server-buttons-grid > button.connecting .server-button-name,
        .server-buttons-grid .server-button.connecting .server-button-name,
        .server-buttons-grid > button.connected .server-button-name,
        .server-buttons-grid .server-button.connected .server-button-name,
        .server-buttons-grid > button.disconnected .server-button-name,
        .server-buttons-grid .server-button.disconnected .server-button-name {
            color: white;
        }

        .server-buttons-grid .server-button-url {
            display: none; /* 隐藏URL，只在tooltip中显示 */
        }

        .server-buttons-grid > button.connecting .server-button-url,
        .server-buttons-grid .server-button.connecting .server-button-url {
            display: none;
        }

        /* 已连接/已断开区域 */
        .server-status-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .server-status-header {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .server-status-header .count {
            font-size: 14px;
            color: rgba(47, 47, 47, 0.7);
            font-weight: 600;
        }

        .server-status-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--border-dark) 20%, var(--border-dark) 80%, transparent 100%);
            margin: 25px 0;
            border-radius: 2px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin-left: auto;
        }

        .status-badge.online {
            background: #c8e6c9;
            color: #2e7d32;
            border: 2px solid #81c784;
        }

        .status-badge.offline {
            background: #ffcdd2;
            color: #c62828;
            border: 2px solid #e57373;
        }

        /* 服务器列表 */
        .server-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .server-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .server-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(5px);
        }

        .server-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .server-dot.online {
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }

        .server-dot.offline {
            background: #f44336;
            box-shadow: 0 0 8px #f44336;
        }

        .server-info {
            flex: 1;
        }

        .server-name {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .server-url {
            font-size: 11px;
            color: rgba(47, 47, 47, 0.6);
            margin-top: 2px;
        }

        /* 服务器操作按钮 */
        .server-action-btn {
            padding: 6px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .server-action-btn.connect {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .server-action-btn.connect:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(250, 112, 154, 0.5);
        }

        .server-action-btn.reconnect {
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            color: white;
        }

        .server-action-btn.reconnect:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            transform: translateX(3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.5);
        }

        /* 管理员账户管理区域 */
        .admin-account-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .admin-account-section h3 {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .admin-account-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .admin-account-input-group {
            flex: 1;
            min-width: 0;
        }

        .admin-account-input-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .admin-account-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
        }

        .admin-account-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 3px rgba(139, 0, 255, 0.15);
        }

        .admin-account-btn {
            flex: none;
            padding: 8px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .admin-account-btn.cancel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
        }

        .admin-account-btn.cancel:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .admin-account-btn.confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-account-btn.confirm:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .admin-account-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .admin-account-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .admin-account-name {
            min-width: 100px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-account-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722 0%, #ff6f00 50%, #ff9800 100%);
            border: 2px solid var(--border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(255, 87, 34, 0.4);
        }

        .admin-account-actions {
            display: flex;
            gap: 5px;
        }

        .admin-account-action-btn {
            padding: 4px 10px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .admin-account-action-btn.edit {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-account-action-btn.edit:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            transform: translateX(3px) scale(1.05);
        }

        .admin-account-action-btn.delete {
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            color: white;
        }

        .admin-account-action-btn.delete:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            transform: translateX(3px) scale(1.05);
        }

        .admin-account-action-btn.manage {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-account-action-btn.manage:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            transform: translateX(3px) scale(1.05);
        }

        /* 管理员管理对话框 */
        .admin-manage-modal {
            width: 600px;
            max-width: 90vw;
        }

        .admin-manage-content {
            padding: 20px;
        }

        .admin-manage-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
        }

        .admin-manage-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .admin-manage-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .admin-manage-info-label {
            min-width: 60px;
        }

        .admin-manage-actions {
            display: flex;
            gap: 10px;
        }

        .admin-manage-permission-row {
            margin-bottom: 20px;
        }

        .admin-manage-permission-label {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .admin-manage-user-count {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-manage-user-count input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
        }

        .admin-manage-servers-label {
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .admin-manage-servers-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
            justify-content: flex-start;
        }

        .admin-manage-server-btn {
            flex: none;
            width: 50px;
            height: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at top left, #ff0 0%, transparent 50%), 
                        radial-gradient(circle at bottom right, #ff0 0%, transparent 60%);
            cursor: pointer;
            transition: all 2s ease;
            filter: blur(1px);
            opacity: 0.3;
            box-shadow: 0 0 25px rgba(255,255,0,0.2);
            text-align: center;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            position: relative;
            overflow: visible;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 1;
        }

        .admin-manage-server-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: repeating-conic-gradient(from 0deg, #ff0 0deg 30deg, #0f0 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, #ff0 0deg 20deg, #0f0 40deg 60deg, transparent 90deg);
            background-size: 200% 200%;
            opacity: 0.4;
            filter: blur(8px);
            animation: rotate 20s linear infinite paused;
            transition: opacity 2s ease;
            z-index: -1;
        }

        .admin-manage-server-btn::after {
            content: '';
            position: absolute;
            inset: 10%;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff0, #0f0, #0ff);
            opacity: 0.15;
            filter: blur(12px);
            z-index: -2;
        }

        .admin-manage-server-btn.active {
            opacity: 1;
            background: radial-gradient(circle at top left, #0f0 0%, transparent 50%), 
                        radial-gradient(circle at bottom right, #0f0 0%, transparent 60%);
            box-shadow: 0 0 50px #0f0;
            transform: scale(1.08);
            filter: blur(0.5px);
        }

        .admin-manage-server-btn.active::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, #0f0 0deg 30deg, #0ff 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, #0f0 0deg 20deg, #0ff 40deg 60deg, transparent 90deg);
            animation-play-state: running;
        }

        .admin-manage-server-btn.active::after {
            background: linear-gradient(135deg, #0f0, #00f, #0ff);
            opacity: 0.3;
        }

        .admin-manage-server-btn:hover {
            opacity: 0.6;
        }

        .admin-manage-server-btn.selected {
            opacity: 1;
            background: radial-gradient(circle at top left, #0f0 0%, transparent 50%), 
                        radial-gradient(circle at bottom right, #0f0 0%, transparent 60%);
            box-shadow: 0 0 50px #0f0;
            transform: scale(1.08);
            filter: blur(0.5px);
        }

        .admin-manage-server-btn.selected::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, #0f0 0deg 30deg, #0ff 60deg 90deg, transparent 120deg),
                        repeating-conic-gradient(from 45deg, #0f0 0deg 20deg, #0ff 40deg 60deg, transparent 90deg);
            animation-play-state: running;
        }

        .admin-manage-server-btn.selected::after {
            background: linear-gradient(135deg, #0f0, #00f, #0ff);
            opacity: 0.3;
        }

        .admin-manage-footer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .admin-manage-footer-btn {
            flex: 1;
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .admin-manage-footer-btn.reset {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
        }

        .admin-manage-footer-btn.select-all {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
        }

        .admin-manage-footer-btn.confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-manage-footer-btn:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        /* 分组管理区域 */
        .admin-group-section {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .admin-group-section h3 {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 20px;
        }

        .group-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .group-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--border-dark);
            border-radius: 14px;
            padding: 15px 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .group-name {
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .group-name.public {
            color: #2196F3;
        }

        .group-name.private {
            color: #9C27B0;
        }

        .group-count {
            font-size: 12px;
            color: rgba(47, 47, 47, 0.6);
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
        }

        .group-servers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .group-server-tag {
            padding: 6px 12px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #64b5f6;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: #1565c0;
            cursor: move;
            transition: all 0.3s ease;
        }

        .group-server-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(100, 181, 246, 0.4);
        }

        .group-server-tag.private {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-color: #ba68c8;
            color: #7b1fa2;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: rgba(47, 47, 47, 0.5);
            font-size: 14px;
            font-weight: 600;
        }

        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #a8c8ff 0%, #ff9aa2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8bb5ff 0%, #ff7a8a 100%);
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .login-panel {
                width: 90%;
                max-width: 400px;
            }

            .modal-panel {
                width: 90%;
                max-width: 360px;
            }

            .admin-status-section {
                grid-template-columns: 1fr;
            }

            .admin-form-row {
                flex-direction: column;
            }

            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }


        /* ==================== 补充的管理员页面样式 ==================== */

        /* 1. 服务器管理页面增强 */
        .admin-page.show {
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 服务器卡片增强 */
        .server-buttons-grid > div {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .server-buttons-grid > div::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            transform: translateX(-100%);
        }

        .server-buttons-grid > div:hover::after {
            animation: shine 1.5s ease-in-out infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 服务器状态徽章增强 */
        .server-status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .server-status-badge.online {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            animation: pulseOnline 2s infinite;
        }

        .server-status-badge.offline {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        }

        .server-status-badge.connecting {
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            animation: pulseConnecting 1.5s infinite;
        }

        @keyframes pulseOnline {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }

        @keyframes pulseConnecting {
            0% { box-shadow: 0 0 0 0 rgba(255, 170, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 170, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 170, 0, 0); }
        }

        /* 2. 管理员页面增强 */
        .manager-page.show {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 用户按钮网格增强 */
        .user-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            animation: fadeIn 0.6s ease-out;
        }

        .user-button {
            transform-origin: center;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .user-button:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .user-button-content {
            position: relative;
            z-index: 2;
        }

        .user-server-count-badge {
            position: relative;
            overflow: hidden;
        }

        .user-server-count-badge::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 70%
            );
            animation: badgeShine 3s infinite linear;
        }

        @keyframes badgeShine {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }

        /* 3. 服务器按钮网格（管理员页面）增强 */
        .server-buttons-grid-new {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .server-buttons-grid-new > div {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .server-buttons-grid-new > div::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .server-buttons-grid-new > div:hover::before {
            transform: translateX(0);
        }

        .server-buttons-grid-new > div.selected {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* 4. 统计卡片（管理员面板） */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, 
                rgba(255, 214, 231, 0.3) 0%, 
                rgba(193, 240, 255, 0.3) 50%, 
                rgba(197, 255, 193, 0.3) 100%);
            border: 3px solid var(--border-dark);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 50%, 
                transparent 100%);
            pointer-events: none;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-card-icon {
            font-size: 24px;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--text-dark);
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card-label {
            font-size: 13px;
            color: rgba(47, 47, 47, 0.7);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 5. 数据表格样式 */
        .data-table-container {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.25) 0%, 
                rgba(255, 255, 255, 0.15) 100%);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            overflow: hidden;
            margin: 20px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            color: white;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        /* 6. 搜索和筛选区域增强 */
        .search-filter-area {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.25) 0%, 
                rgba(255, 255, 255, 0.15) 100%);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid rgba(47, 47, 47, 0.3);
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: rgba(139, 0, 255, 0.6);
            box-shadow: 0 0 0 4px rgba(139, 0, 255, 0.15);
            background: rgba(255, 255, 255, 1);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 18px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }

        .filter-btn span {
            position: relative;
            z-index: 2;
        }

        .filter-btn.active {
            color: white;
            border-color: rgba(102, 126, 234, 0.8);
        }

        .filter-btn.active::before {
            opacity: 1;
        }

        .filter-btn:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 7. 操作按钮组优化 */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 70px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn.edit {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .action-btn.delete {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .action-btn.view {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* 8. 加载状态和空状态优化 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(47, 47, 47, 0.5);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.7;
        }

        /* 9. 分页控件优化 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid rgba(47, 47, 47, 0.1);
        }

        .pagination-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pagination-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }

        .pagination-btn span {
            position: relative;
            z-index: 2;
        }

        .pagination-btn.active {
            color: white;
        }

        .pagination-btn.active::before {
            opacity: 1;
        }

        .pagination-btn:hover:not(.disabled):not(.active) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .pagination-ellipsis {
            color: rgba(47, 47, 47, 0.5);
            font-weight: bold;
            padding: 0 10px;
        }

        /* 10. 用户详情面板增强 */
        .user-detail-panel {
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .user-detail-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .user-detail-stat-card {
            padding: 15px;
            background: linear-gradient(135deg, 
                rgba(139, 0, 255, 0.1) 0%, 
                rgba(139, 0, 255, 0.05) 100%);
            border-radius: 12px;
            border: 2px solid rgba(139, 0, 255, 0.2);
            transition: all 0.3s ease;
        }

        .user-detail-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 0, 255, 0.15);
        }

        .user-detail-stat-label {
            font-size: 12px;
            color: rgba(47, 47, 47, 0.6);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-detail-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 11. 标签样式 */
        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin: 2px;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .tag-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: #c3e6cb;
        }

        .tag-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-color: #ffeaa7;
        }

        .tag-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-color: #f5c6cb;
        }

        .tag-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-color: #bee5eb;
        }

        .tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 12. 响应式优化补充 */
        @media (max-width: 1024px) {
            .user-buttons-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .server-buttons-grid-new {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .server-manager-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .server-add-row {
                flex-direction: column;
            }
            
            .server-input-group {
                width: 100%;
            }
            
            .user-buttons-grid {
                grid-template-columns: 1fr;
            }
            
            .server-buttons-grid-new {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .data-table-container {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 600px;
            }
            
            .search-input-group {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .manager-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .server-buttons-grid-new {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .pagination {
                flex-wrap: wrap;
            }
        }

        /* 13. 滚动条样式优化 */
        .admin-page::-webkit-scrollbar,
        .manager-page::-webkit-scrollbar {
            width: 10px;
        }

        .admin-page::-webkit-scrollbar-track,
        .manager-page::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .admin-page::-webkit-scrollbar-thumb,
        .manager-page::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .admin-page::-webkit-scrollbar-thumb:hover,
        .manager-page::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4299 100%);
        }

        /* 14. 悬停提示优化 */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 99999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .server-buttons-grid > div:hover .tooltip,
        .user-button:hover .tooltip {
            opacity: 1;
            transform: translateY(0);
        }

        /* 15. 动画延迟效果 */
        .user-button {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }

        .user-button:nth-child(1) { animation-delay: 0.1s; }
        .user-button:nth-child(2) { animation-delay: 0.2s; }
        .user-button:nth-child(3) { animation-delay: 0.3s; }
        .user-button:nth-child(4) { animation-delay: 0.4s; }
        .user-button:nth-child(5) { animation-delay: 0.5s; }
        .user-button:nth-child(6) { animation-delay: 0.6s; }
        .user-button:nth-child(7) { animation-delay: 0.7s; }
        .user-button:nth-child(8) { animation-delay: 0.8s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 16. 切换动画 */
        .page-transition-enter {
            opacity: 0;
            transform: translateX(30px);
        }

        .page-transition-enter-active {
            opacity: 1;
            transform: translateX(0);
            transition: opacity 0.4s, transform 0.4s;
        }

        .page-transition-exit {
            opacity: 1;
            transform: translateX(0);
        }

        .page-transition-exit-active {
            opacity: 0;
            transform: translateX(-30px);
            transition: opacity 0.4s, transform 0.4s;
        }

        /* 17. 骨架屏加载效果 */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 25%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 120px;
            border-radius: 16px;
            margin-bottom: 15px;
        }

        .skeleton-text {
            height: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .skeleton-text.short {
            width: 60%;
        }

        /* 18. 交互反馈效果 */
        .button-press {
            animation: buttonPress 0.2s ease;
        }

        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* 19. 通知气泡 */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            border-radius: 10px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
            animation: bounce 2s infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* 20. 卡片翻转效果 */
        .flip-card {
            perspective: 1000px;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .flip-card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* 应用于用户卡片 */
        .user-button.flip-card {
            height: 120px;
        }














        /*#endregion */

    </style>
</head>



<body>
    <!--#region 登录页面 HTML -->
    <!-- ==================== 登录页面 ==================== -->
    <div class="login-page" id="loginPage" style="display: flex;">
        <!-- 右上角服务器管理入口（独立功能，需要管理员密码验证） -->
        <button class="admin-entry-btn" onclick="showAdminModal()">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
            </svg>
            服务器管理
        </button>

        <!-- 标题区域 -->
        <div class="login-title-area">
            <div class="login-main-title">AutoSender Pro</div>
            <div class="login-main-subtitle">IMessage sender</div>
        </div>

        <!-- 登录面板 -->
        <div class="login-panel" id="loginPanel">
            <div class="login-panel-header">
                <h1 class="login-logo">用户登录</h1>
            </div>

            <div class="login-panel-content">
                <!-- Admin 切换按钮 -->
                <div class="user-admin-toggle">
                    <button class="toggle-btn btn-admin" id="adminToggle" onclick="switchToAdmin()">Admin</button>
                </div>

                <!-- 用户登录表单 -->
                <div id="userLoginForm">
                    <form novalidate onsubmit="handleLogin(); return false;">
                        <div class="form-group">
                            <input type="text" class="form-input" id="loginUsername" placeholder="用户名" autocomplete="username">
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="loginPassword" placeholder="密码"
                                       autocomplete="current-password">
                                <button type="button" class="show-password-btn"
                                        onclick="togglePassword('loginPassword', this)">👁️</button>
                            </div>
                        </div>
                        <div class="forgot-password">
                            <a href="#" class="forgot-password-link"
                               onclick="handleForgotPassword(); return false;">忘记密码？</a>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary btn-register" onclick="showRegister()">注册</button>
                            <button type="submit" class="btn-primary">登录</button>
                        </div>
                    </form>
                </div>
                
                <!-- 管理员登录表单 -->
                <div id="adminLoginForm" style="display: none;">
                    <form novalidate onsubmit="handleAdminLogin(); return false;">
                        <div class="form-group">
                            <input type="text" class="form-input" id="adminLoginUsername" placeholder="管理员用户名" autocomplete="username">
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="adminLoginPassword" placeholder="管理员密码"
                                       autocomplete="current-password">
                                <button type="button" class="show-password-btn"
                                        onclick="togglePassword('adminLoginPassword', this)">👁️</button>
                            </div>
                        </div>
                        <div class="forgot-password" style="visibility: hidden;">
                            <a href="#" class="forgot-password-link">占位</a>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary" onclick="switchToUser()">返回</button>
                            <button type="submit" class="btn-primary">登录</button>
                        </div>
                    </form>
                </div>
                
                <!-- 注册表单 -->
                <div id="registerForm" style="display: none;">
                    <form novalidate onsubmit="handleRegister(); return false;">
                        <div class="form-group">
                            <input type="text" class="form-input" id="registerUsername" placeholder="请设置用户名" autocomplete="username">
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="registerPassword" placeholder="请设置密码,至少4位"
                                       autocomplete="new-password">
                                <button type="button" class="show-password-btn"
                                        onclick="togglePassword('registerPassword', this)">👁️</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="registerConfirmPassword" placeholder="请确认密码,至少4位"
                                       autocomplete="new-password">
                                <button type="button" class="show-password-btn"
                                        onclick="togglePassword('registerConfirmPassword', this)">👁️</button>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary" onclick="showLogin()">返回</button>
                            <button type="submit" class="btn-primary">确定</button>
                        </div>
                    </form>
                </div>
                
    
                
                <div class="message-box" id="authMessage"></div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 自定义弹窗 HTML -->
    <!-- ==================== 自定义弹窗 ==================== -->
    <div class="custom-modal-overlay" id="customModal">
        <div class="custom-modal-panel" id="customModalPanel">
            <div class="custom-modal-header">
                <span class="custom-modal-title" id="customModalTitle">提示</span>
                <button class="custom-modal-close" onclick="closeCustomModal()">×</button>
            </div>
            <div class="custom-modal-content" id="customModalContent">
                <div class="custom-modal-message" id="customModalMessage"></div>
                <input type="text" class="custom-modal-input" id="customModalInput" style="display: none;"
                    placeholder="">
                <div class="custom-modal-buttons" id="customModalButtons">
                    <!-- 动态生成按钮 -->
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 管理员密码弹窗 HTML -->
    <!-- ==================== 管理员密码弹窗 ==================== -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal-panel">
            <div class="modal-header">
                <span class="modal-title">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                        <path
                            d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                    </svg>
                    服务器管理
                </span>
                <button class="modal-close" onclick="closeAdminModal()">×</button>
            </div>
            <div class="modal-content">
                <label class="modal-label">请输入管理员密码：</label>
                <input type="password" class="modal-input" id="adminPasswordInput" placeholder="管理员密码">
                <button class="modal-btn" onclick="verifyAdminPassword()">确 认</button>
                <div class="modal-message" id="adminMessage"></div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 服务器管理密码修改弹窗 HTML -->
    <!-- ==================== 服务器管理密码修改弹窗 ==================== -->
    <div class="custom-modal-overlay" id="passwordChangeModal">
        <div class="custom-modal-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">🔐 服务器管理密码设置</span>
                <button class="custom-modal-close" onclick="closePasswordChangeModal()">×</button>
            </div>
            <div class="custom-modal-content">
                <input type="password" class="custom-modal-input" id="oldPasswordInput" placeholder="请输入旧密码">
                <input type="password" class="custom-modal-input" id="newPasswordInput" placeholder="新密码">
                <div class="custom-modal-buttons">
                    <button class="custom-modal-btn cancel" onclick="closePasswordChangeModal()">取消</button>
                    <button class="custom-modal-btn confirm" onclick="updateServerManagerPassword()">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 积分充值面板 HTML -->
    <!-- ==================== 积分充值面板 ==================== -->
    <div class="custom-modal-overlay" id="rechargeModal" style="display: none;">
        <div class="custom-modal-panel" style="width: 70%; max-width: 800px; height: 85vh; max-height: 85vh; overflow-y: auto;">
            <div class="custom-modal-header">
                <span class="custom-modal-title">💰 积分充值</span>
                <button class="custom-modal-close" onclick="closeRechargeModal()">×</button>
            </div>
            <div class="custom-modal-content" style="padding: 20px; display: flex; flex-direction: column; height: calc(85vh - 100px);">
                <!-- 第一行：用户ID输入、验证按钮、充值输入、确定按钮 -->
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-weight: bold; white-space: nowrap; font-size: 14px;">用户ID:</label>
                        <input type="text" class="custom-modal-input" id="rechargeUserIdInput" placeholder="请输入用户ID" style="width: 180px;">
                        <button class="custom-modal-btn" onclick="verifyRechargeUser()" style="white-space: nowrap; padding: 8px 15px;">验证</button>
                    </div>
                    <div style="width: 20px;"></div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-weight: bold; white-space: nowrap; font-size: 14px;">充值:</label>
                        <input type="number" class="custom-modal-input" id="rechargeAmountInput" placeholder="充值金额" style="width: 120px;" min="0.01" step="0.01">
                        <button class="custom-modal-btn confirm" onclick="confirmRecharge()" style="white-space: nowrap; padding: 8px 15px;">确定</button>
                    </div>
                </div>
                
                <!-- 第二行：用户信息显示区域（固定高度，两行布局） -->
                <div id="rechargeUserInfo" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px; height: 120px; border: 1px solid #ddd; overflow: hidden;">
                    <!-- 第一行：用户ID、用户编号、注册时间 -->
                    <div style="display: flex; gap: 30px; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">用户ID:</strong>
                            <span id="rechargeInfoUserId" style="color: #333; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">用户编号:</strong>
                            <span id="rechargeInfoUsername" style="color: #333; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">注册时间:</strong>
                            <span id="rechargeInfoCreated" style="color: #333; font-size: 14px;">-</span>
                        </div>
                    </div>
                    <!-- 第二行：余额、上次充值、总消费 -->
                    <div style="display: flex; gap: 30px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">余额:</strong>
                            <span id="rechargeInfoCredits" style="color: #4CAF50; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">上次充值:</strong>
                            <span id="rechargeInfoLastRecharge" style="color: #333; font-size: 13px;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">总消费:</strong>
                            <span id="rechargeInfoTotalSpent" style="color: #FF9800; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 充值记录区域 -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">充值记录</h3>
                    <div id="rechargeRecordsList" style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; max-height: 400px; overflow-y: auto;">
                        <div style="padding: 15px; text-align: center; color: #999;">请先验证用户以查看充值记录</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 添加管理员弹窗 HTML -->
    <!-- ==================== 添加管理员弹窗 ==================== -->
    <div class="custom-modal-overlay" id="addAdminModal">
        <div class="custom-modal-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">👤 添加管理员账号</span>
                <button class="custom-modal-close" onclick="closeAddAdminModal()">×</button>
            </div>
            <div class="custom-modal-content">
                <input type="text" class="custom-modal-input" id="newAdminId" placeholder="管理员ID">
                <input type="password" class="custom-modal-input" id="newAdminPassword" placeholder="密码">
                <div class="custom-modal-buttons">
                    <button class="custom-modal-btn cancel" onclick="closeAddAdminModal()">取消</button>
                    <button class="custom-modal-btn confirm" onclick="addAdminAccount()">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 服务器管理面板 HTML -->
    <!-- ==================== 服务器管理面板 ==================== -->
    <div class="admin-page" id="adminPage">
        <div class="admin-container">
            <!-- 头部 -->
            <div class="server-manager-header">
                <h1>🔧 Server Manager</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="admin-back-btn" onclick="showRechargeModal()">💰 充值</button>
                    <button class="admin-back-btn password-setting-btn" onclick="showPasswordChangeModal()">修改管理密码</button>
                    <button class="admin-back-btn" onclick="backToLogin()">保存退出</button>
                </div>
            </div>

            <!-- 可连接服务器列表 -->
            <div class="server-manager-section">
                <div class="server-list-section">
                    <div class="server-list-label">可连接(空闲):</div>
                    <div class="server-buttons-grid" id="availableServers">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 已连接和已断开服务器 -->
            <div class="server-status-section">
                <div class="server-status-header">
                    已连接 <span class="count" id="connectedCount">(0)</span>
                </div>
                <div class="server-buttons-grid" id="connectedServers">
                    <!-- 动态生成 -->
                </div>

                <div class="server-status-divider"></div>

                <div class="server-status-header">
                    已断开 <span class="count" id="disconnectedCount">(0)</span>
                </div>
                <div class="server-buttons-grid" id="disconnectedServers">
                    <!-- 动态生成 -->
                </div>
            </div>


            <!-- 管理员账户管理（用于登录窗口的管理员账号） -->
            <div class="admin-account-section">
                <h3>👤 创建管理员账号</h3>
                <div style="margin-bottom: 15px;">
                    <button class="admin-account-btn confirm" onclick="showAddAdminModal()">添加管理员</button>
                </div>
                <div class="admin-account-list" id="adminAccountList">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 管理员页面 HTML -->
    <!-- ==================== 管理员页面 ==================== -->
    <div class="manager-page" id="managerPage">
        <div class="manager-container">
            <!-- Header -->
            <div class="manager-header">
                <button class="admin-back-btn password-setting-btn" onclick="showPasswordChangeModal()">修改密码</button>
                <button class="admin-back-btn" onclick="backToLoginFromManager()">保存退出</button>
            </div>

            <!-- 面板1：管理员数据 -->
            <div class="manager-section" id="adminDataPanel">
                <div class="admin-data-row">
                    <div class="admin-data-item">
                        <span class="admin-data-label">管理员:</span>
                        <span class="admin-data-value" id="managerIdDisplay">-</span>
                    </div>
                    <div class="admin-data-item">
                        <span class="admin-data-label">管理用户数量:</span>
                        <span class="admin-data-value" id="managerUserCountDisplay">0</span>
                    </div>
                    <div class="admin-data-item">
                        <span class="admin-data-label">总业绩:</span>
                        <span class="admin-data-value" id="totalPerformanceDisplay">0</span>
                    </div>
                </div>
            </div>

            <!-- 面板2：用户列表 -->
            <div class="manager-section" id="userListPanel">
                <div class="panel-header-row">
                    <h3 class="panel-title">用户列表</h3>
                    <button class="add-user-btn" onclick="showAddUserModal()">添加用户</button>
                </div>
                <div class="user-buttons-grid" id="userList">
                    <!-- 动态生成用户按钮 -->
                </div>
            </div>

            <!-- 面板3：可分配服务器 -->
            <div class="manager-section" id="availableServersPanel">
                <h3 class="panel-title">可分配服务器</h3>
                <div class="server-buttons-grid-new" id="managerAvailableServers">
                    <!-- 动态生成服务器按钮 -->
                </div>
            </div>
        </div>
    </div>
            <!--#region 添加用户弹窗 HTML -->
            <!-- ==================== 添加用户弹窗 ==================== -->
            <div class="custom-modal-overlay" id="addUserModal">
                <div class="custom-modal-panel">
                    <div class="custom-modal-header">
                        <span class="custom-modal-title">👤 添加用户</span>
                        <button class="custom-modal-close" onclick="closeAddUserModal()">×</button>
                    </div>
                    <div class="custom-modal-content">
                        <input type="text" class="custom-modal-input" id="addUserUsername" placeholder="用户名">
                        <input type="text" class="custom-modal-input" id="addUserUserId" placeholder="用户ID">
                        <div class="custom-modal-buttons">
                            <button class="custom-modal-btn cancel" onclick="closeAddUserModal()">取消</button>
                            <button class="custom-modal-btn confirm" onclick="confirmAddUser()">确定</button>
                        </div>
                    </div>
                </div>
            </div>
            <!--#endregion -->

            <!--#region 用户详情管理弹窗 HTML -->
            <!-- ==================== 用户详情管理弹窗 ==================== -->
            <div class="custom-modal-overlay" id="userDetailModal">
                <div class="custom-modal-panel user-detail-panel">
                    <div class="custom-modal-header">
                        <span class="custom-modal-title">👤 用户详情</span>
                        <button class="custom-modal-close" onclick="closeUserDetailModal()">×</button>
                    </div>
                    <div class="custom-modal-content user-detail-content" id="userDetailContent">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>
            <!--#endregion -->

            <!--#endregion -->
            <!--#region 主应用页面 HTML -->
    <!-- ==================== 主应用页面 ==================== -->
    <div class="content-wrapper" style="display: none;">
        <!-- 导航按钮栏 -->
        <div class="nav-container">
            <div class="nav-buttons">
                <button class="nav-btn active" id="navHomeBtn">主页面</button>
                <button class="nav-btn" id="navAccountBtn">账号管理</button>
                <button class="nav-btn" id="navSendBtn">IMessage</button>
                <button class="nav-btn" id="navInboxBtn">收件箱
                    <div class="notification-count">0</div>
                </button>
                <button class="nav-btn" id="navLogoutBtn" onclick="handleLogout()">退出账号</button>
            </div>
        </div>
        <div class="main-container" style="display: none;">
            <!-- 工作区A+B -->
            <div class="workspace-ab" id="workspaceAB" style="display: none;">
                <!-- A版面板 -->
                <div class="panel-a">
                    <div class="panel-header">
                        <span>AutoSender Pro</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="userInfoDisplay"
                                style="font-family: 'Xiaolai', sans-serif; font-size: 12px; color: var(--text-dark); display: none;">
                                <span id="currentUsername"></span> | 积分: <span id="currentCredits">-</span>
                            </span>
                            <div class="connection-status" id="connectionStatus"><span>连接中...</span></div>
                        </div>
                    </div>

                    <div class="panel-content">
                        <div class="content-area">
                            <!-- 左侧号码输入框 -->
                            <div class="numbers-container">
                                <div class="input-header">
                                    <div class="input-title">发送号码</div>
                                    <div class="input-actions">
                                        <button class="btn-icon" id="importNumbersBtn" title="导入">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                                            </svg>
                                        </button>
                                        <button class="btn-icon" id="clearNumbersBtn" title="清空">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path
                                                    d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="input-area">
                                    <textarea id="numbersText" placeholder="输入目标号码，每行一个"></textarea>
                                    <div class="char-count" id="numbersCount">号码: 0</div>
                                </div>
                                <!-- 延长按钮 -->
                                <div class="anchor-trigger" id="numTrigger"></div>
                            </div>

                            <!-- 右侧消息输入框 -->
                            <div class="message-container">
                                <div class="input-header">
                                    <div class="input-title">发送内容</div>
                                    <div class="input-actions">
                                        <button class="btn-icon" id="importMessageBtn" title="导入">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                                            </svg>
                                        </button>
                                        <button class="btn-icon" id="clearMessageBtn" title="清空">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path
                                                    d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="input-area">
                                    <textarea id="messageText" placeholder="输入要发送的消息内容"></textarea>
                                    <div class="char-count" id="messageCount">字符: 0</div>
                                </div>
                            </div>
                        </div>

                        <div class="control-bar">
                            <button class="btn-log-panel" id="logPanelBtn">日志面板</button>
                            <!-- A版中的统计栏（当B版未打开时显示） -->
                            <div class="stats-bar-inline" id="statsBarInline">
                                <div class="stat-item">任务次数: <span class="stat-value" id="taskCountInline">0</span>
                                </div>
                                <div class="stat-item">总号码: <span class="stat-value" id="phoneCountInline">0</span>
                                </div>
                                <div class="stat-item">总数量: <span class="stat-value" id="totalSentCountInline">0</span>
                                </div>
                                <div class="stat-item">成功: <span class="stat-value" id="successCountInline">0</span>
                                </div>
                                <div class="stat-item">失败: <span class="stat-value" id="failCountInline">0</span></div>
                                <div class="stat-item">成功率: <span class="stat-value" id="successRateInline">0%</span>
                                </div>
                            </div>
                            <div class="interval-control">
                                <span class="interval-label">发送间隔:</span>
                                <select class="interval-select" id="intervalInput">
                                    <option value="0.3">0.3s</option>
                                    <option value="0.7">0.7s</option>
                                    <option value="1.0" selected>1.0s</option>
                                    <option value="1.5">1.5s</option>
                                    <option value="2.0">2.0s</option>
                                </select>
                            </div>
                            <button class="btn-send" id="sendBtn">发送</button>
                        </div>
                    </div>
                </div>
                <!-- B版面板（桌面端AB并排） -->
                <div class="panel-b desktop-only">
                    <div class="panel-header">
                        <span>任务日志</span>
                    </div>
                    <div class="panel-content" style="position: relative;">
                        <div class="log-box" id="statusList">
                            <!-- 日志内容将通过JavaScript动态添加 -->
                        </div>
                        <!-- 清空按钮 - 放在日志容器右下角 -->
                        <button class="btn-clear-logs" id="clearLogsBtn" title="清空日志">清空</button>
                        <div class="stats-bar">
                            <div class="stat-item">任务次数: <span class="stat-value" id="taskCount">0</span></div>
                            <div class="stat-item">总号码: <span class="stat-value" id="phoneCount">0</span></div>
                            <div class="stat-item">总数量: <span class="stat-value" id="totalSentCount">0</span></div>
                            <div class="stat-item">成功: <span class="stat-value" id="successCount">0</span></div>
                            <div class="stat-item">失败: <span class="stat-value" id="failCount">0</span></div>
                            <div class="stat-item">成功率: <span class="stat-value" id="successRate">0%</span></div>
                        </div>
                        <!-- 延长按钮 -->
                        <div class="anchor-trigger" id="logTrigger"></div>
                    </div>
                </div>
            </div>
            <!-- B版面板（移动端独立显示） -->
            <div class="panel-b-mobile" id="panelB">
                <div class="panel-header">
                    <span>任务日志</span>
                </div>
                <div class="panel-content">
                    <div class="log-box" id="statusListMobile">
                        <!-- 日志内容将通过JavaScript动态添加 -->
                    </div>
                    <div class="stats-bar">
                        <div class="stat-item">任务次数: <span class="stat-value" id="taskCountMobile">0</span></div>
                        <div class="stat-item">总号码: <span class="stat-value" id="phoneCountMobile">0</span></div>
                        <div class="stat-item">总数量: <span class="stat-value" id="totalSentCountMobile">0</span></div>
                        <div class="stat-item">成功: <span class="stat-value" id="successCountMobile">0</span></div>
                        <div class="stat-item">失败: <span class="stat-value" id="failCountMobile">0</span></div>
                        <div class="stat-item">成功率: <span class="stat-value" id="successRateMobile">0%</span></div>
                    </div>
                    <!-- 底部按钮区域 -->
                    <div class="panel-b-controls">
                        <button class="btn-back-to-send" id="backToSendBtn">IMessage</button>
                        <button class="btn-clear-logs-mobile" id="clearLogsBtnMobile" title="清空日志">清空</button>
                    </div>
                </div>
            </div>
            <!-- 空白面板 -->
            <div class="panel-d" id="panelD" style="display: none;">
                <div class="main-title">AutoSender Pro</div>
                <div class="main-subtitle">IMessage sender</div>
            </div>
            <!-- 收件箱面板 -->
            <div class="panel-c" id="panelC" style="display: none;">
                <div class="panel-header">
                    <span>收件箱</span>
                    <span id="inboxStats"
                        style="font-family: 'Xiaolai', sans-serif; font-size: 13px; padding: 4px 10px; background: rgba(47, 47, 47, 0.1); border-radius: 12px;">接收:
                        0 发送: 0 总数: 0</span>
                </div>
                <div class="panel-content">
                    <div class="inbox-layout">
                        <div class="contact-list" id="contactList" style="position: relative;">
                            <!-- 联系人列表将通过JavaScript动态添加 -->
                            <button class="btn-clear-inbox" id="clearInboxBtn" title="全部删除">全部删除</button>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header" id="chatHeader" style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                <span class="phone-number" id="chatPhoneNumber" style="flex: 1;">选择一个对话</span>
                                <div id="exclusivePhoneSelector" style="display: none; position: relative;">
                                    <button id="exclusivePhoneBtn" style="padding: 6px 12px; background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); border: 2px solid var(--border-dark); border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; white-space: nowrap;">
                                        本机号码: <span id="currentPhoneDisplay">-</span> <span style="font-size: 10px;">▼</span>
                                    </button>
                                    <div id="exclusivePhoneDropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; background: white; border: 2px solid var(--border-dark); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; min-width: 150px; max-height: 200px; overflow-y: auto;">
                                        <!-- 动态生成号码列表 -->
                                    </div>
                                </div>
                            </div>
                            <div class="chat-display" id="conversationDisplay">
                                <!-- 对话内容将通过JavaScript动态添加 -->
                            </div>
                            <div class="reply-bar">
                                <input type="text" class="reply-input" id="replyInput" placeholder="输入回复消息...">
                                <button class="btn-send-reply" id="sendReplyBtn">发送</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 账号管理面板 -->
            <div class="panel-e" id="panelE" style="display: none;">
                <div class="panel-header">
                    <span>账号管理</span>
                </div>
                <div class="panel-content">
                    <!-- 账号管理内容区域 -->
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region 文件输入 HTML -->
    <input type="file" id="numbersFile" class="file-input" accept=".txt,.csv">
    <input type="file" id="messageFile" class="file-input" accept=".txt">
    <!--#endregion -->
    <script>
        //#region 登录认证模块（用户登录、管理员登录、注册）
        // ==================== 管理员密码配置 ====================


        // ==================== 用户/管理员切换 ====================
        // 切换到用户登录表单
        function switchToUser() {
            const loginPanel = document.getElementById('loginPanel');
            const adminToggle = document.getElementById('adminToggle');
            
            // 切换到用户登录
            document.getElementById('userLoginForm').style.display = 'block';
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            
            // 移除管理员模式样式
            loginPanel.classList.remove('admin-mode');
            adminToggle.classList.remove('active');
            
            // 更新文字
            document.querySelector('.login-logo').textContent = '用户登录';
            if (adminToggle) {
                adminToggle.textContent = 'Admin';
            }
            
            clearMessage();
        }

        // 切换到管理员登录表单（双向切换）
        window.switchToAdmin = function switchToAdmin() {
            const loginPanel = document.getElementById('loginPanel');
            const adminToggle = document.getElementById('adminToggle');
            const isAdminMode = loginPanel.classList.contains('admin-mode');
            
            if (isAdminMode) {
                document.getElementById('userLoginForm').style.display = 'block';
                document.getElementById('adminLoginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'none';
                adminToggle.classList.remove('active');
                loginPanel.classList.remove('admin-mode');
                document.querySelector('.login-logo').textContent = '用户登录';
                adminToggle.textContent = 'Admin';
            } else {
                document.getElementById('userLoginForm').style.display = 'none';
                document.getElementById('adminLoginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
                adminToggle.classList.add('active');
                loginPanel.classList.add('admin-mode');
                document.querySelector('.login-logo').textContent = '管理员登录';
                adminToggle.textContent = 'User';
            }
            clearMessage();
        }

        //#endregion
        //#region 登录/注册切换功能
        // 显示注册表单
        function showRegister() {
            document.getElementById('userLoginForm').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearMessage();
        }

        // 显示登录表单
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('userLoginForm').style.display = 'block';
            clearMessage();
        }

        function clearMessage() {
            const msg = document.getElementById('authMessage');
            msg.className = 'message-box';
            msg.textContent = '';
        }

        // 显示认证消息
        function showAutoToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `auto-toast auto-toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000); // 3秒后自动消失
        }

        function showMessage(text, type) {
            // 如果是错误类型（密码错误等），使用弹窗方式确保显示在最前面
            if (type === 'error') {
                // 使用自动消失的toast，确保显示在最前面
                showAutoToast(text, type);
            } else {
                // 成功、信息等使用自动消失的提示
                showAutoToast(text, type);
            }
        }

        // ==================== 用户登录处理 ====================
        async function handleLogin() {
            const usernameEl = document.getElementById('loginUsername');
            const passwordEl = document.getElementById('loginPassword');

            if (!usernameEl || !passwordEl) {
                console.error('找不到登录输入框');
                return;
            }

            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            
            if (!username || !password) {
                if (typeof showMessage === 'function') {
                    showMessage('请输入用户名和密码', 'error');
                } else {
                    alert('请输入用户名和密码');
                }
                return;
            }
            
            // 调用后端API进行登录验证
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok && (data.ok || data.success)) {
                    // 登录成功，保存用户信息
                    localStorage.setItem('user_id', data.user_id);
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('username', username);
                    
                    if (typeof showMessage === 'function') {
                        showMessage('登录成功！正在跳转...', 'success');
                    }
                    
                    // 跳转到主界面
                    setTimeout(() => {
                        const loginPage = document.getElementById('loginPage');
                        const contentWrapper = document.querySelector('.content-wrapper');
                        const mainContainer = document.querySelector('.main-container');
                        
                        if (loginPage) loginPage.style.display = 'none';
                        document.body.classList.remove('login-mode');
                        if (contentWrapper) contentWrapper.style.display = 'flex';
                        if (mainContainer) mainContainer.style.display = 'flex';
                        
                        if (typeof showMainApp === 'function') {
                            showMainApp();
                        }
                        
                        if (typeof window.init === 'function') {
                            window.init();
                        }
                    }, 500);
                } else {
                    // 登录失败 - 直接显示API返回的错误信息
                    const errorMsg = data.message || '密码错误';
                    if (typeof showMessage === 'function') {
                        showMessage(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                // 网络错误时，尝试解析响应
                let errorMsg = '登录失败';
                try {
                    if (error.response) {
                        const errorData = await error.response.json();
                        errorMsg = errorData.message || '密码错误';
                    } else if (error.message && error.message.includes('fetch')) {
                        errorMsg = '网络连接失败，请稍后重试';
                    }
                } catch (e) {
                    errorMsg = '密码错误';
                }
                
                if (typeof showMessage === 'function') {
                    showMessage(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }
        window.handleLogin = handleLogin;

        // ==================== 管理员登录处理 ====================
        async function handleAdminLogin() {
            const username = document.getElementById('adminLoginUsername').value.trim();
            const password = document.getElementById('adminLoginPassword').value.trim();

            if (!username || !password) {
                showMessage('请输入管理员用户名和密码', 'error');
                return;
            }

            const account = adminAccounts.find(a => a.id === username && a.password === password);
            if (account) {
                showMessage('管理员登录成功！正在跳转...', 'success');
                setTimeout(() => {
                    loginAsManager(username);
                }, 1000);
            } else {
                // 普通管理员登录：通过API验证
                async function doAdminLogin() {
                    try {
                        if (typeof showMessage === 'function') {
                            showMessage('正在验证管理员身份...', 'info');
                        }
                        
                        const response = await fetch(`${API_BASE_URL}/admin/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                admin_id: username,
                                password: password
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && (data.ok || data.success)) {
                            localStorage.setItem('admin_id', data.admin_id || username);
                            localStorage.setItem('admin_token', data.token || 'admin_token');
                            localStorage.setItem('admin_username', username);
                            
                            showMessage('管理员登录成功！正在跳转...', 'success');
                            setTimeout(() => {
                                // 如果API返回了管理员权限，进入管理员面板
                                if (data.has_manager_access) {
                                    loginAsManager(username);
                                } else {
                                    if (typeof showMessage === 'function') {
                                        showMessage('您没有管理员面板访问权限', 'error');
                                    }
                                }
                            }, 1000);
                        } else {
                            // 管理员登录失败 - 直接显示API返回的错误信息
                            const errorMsg = data.message || '密码错误';
                            if (typeof showMessage === 'function') {
                                showMessage(errorMsg, 'error');
                            } else {
                                alert(errorMsg);
                            }
                        }
                    } catch (error) {
                        // 网络错误时，尝试解析响应
                        let errorMsg = '密码错误';
                        try {
                            if (error.response) {
                                const errorData = await error.response.json();
                                errorMsg = errorData.message || '密码错误';
                            } else if (error.message && error.message.includes('fetch')) {
                                errorMsg = '网络连接失败，请稍后重试';
                            }
                        } catch (e) {
                            errorMsg = '密码错误';
                        }
                        
                        if (typeof showMessage === 'function') {
                            showMessage(errorMsg, 'error');
                        } else {
                            alert(errorMsg);
                        }
                    }
                }
                
                // 执行管理员登录
                doAdminLogin();
            }
        }

        function handleRegister() {
            const usernameEl = document.getElementById('registerUsername');
            const passwordEl = document.getElementById('registerPassword');
            const confirmPasswordEl = document.getElementById('registerConfirmPassword');

            if (!usernameEl || !passwordEl || !confirmPasswordEl) {
                console.error('找不到注册输入框');
                return;
            }

            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            const confirmPassword = confirmPasswordEl.value.trim();

            // 验证用户名
            if (!username) {
                if (typeof showMessage === 'function') {
                    showMessage('请输入用户名', 'error');
                } else {
                    alert('请输入用户名');
                }
                return;
            }

            if (username.length < 4) {
                if (typeof showMessage === 'function') {
                    showMessage('用户名至少需要4位', 'error');
                } else {
                    alert('用户名至少需要4位');
                }
                return;
            }

            if (!/^[a-zA-Z0-9]+$/.test(username)) {
                if (typeof showMessage === 'function') {
                    showMessage('用户名只能包含字母或数字', 'error');
                } else {
                    alert('用户名只能包含字母或数字');
                }
                return;
            }

            if (!password) {
                if (typeof showMessage === 'function') {
                    showMessage('请输入密码', 'error');
                } else {
                    alert('请输入密码');
                }
                return;
            }

            if (password.length < 4) {
                if (typeof showMessage === 'function') {
                    showMessage('密码至少需要4位', 'error');
                } else {
                    alert('密码至少需要4位');
                }
                return;
            }

            if (!confirmPassword) {
                if (typeof showMessage === 'function') {
                    showMessage('请确认密码', 'error');
                } else {
                    alert('请确认密码');
                }
                return;
            }

            if (password !== confirmPassword) {
                if (typeof showMessage === 'function') {
                    showMessage('两次输入的密码不一致', 'error');
                } else {
                    alert('两次输入的密码不一致');
                }
                return;
            }

            // 调用API进行注册
            async function doRegister() {
                try {
                    if (typeof showMessage === 'function') {
                        showMessage('正在注册...', 'info');
                    }

                    const response = await fetch(`${API_BASE_URL}/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (response.ok && (data.ok || data.success)) {
                        // 清空注册表单
                        document.getElementById('registerUsername').value = '';
                        document.getElementById('registerPassword').value = '';
                        document.getElementById('registerConfirmPassword').value = '';
                        
                        // 切换到登录页面并填充用户名
                        if (typeof showLogin === 'function') {
                            showLogin();
                        }
                        const loginUsernameEl = document.getElementById('loginUsername');
                        const loginPasswordEl = document.getElementById('loginPassword');
                        if (loginUsernameEl) {
                            loginUsernameEl.value = username;
                        }
                        if (loginPasswordEl) {
                            loginPasswordEl.value = '';
                        }
                        
                        setTimeout(async () => {
                            await customAlert('注册成功！');
                        }, 300);
                    } else {
                        // 注册失败 - 直接显示API返回的错误信息
                        const errorMsg = data.message || '注册失败';
                        if (typeof showMessage === 'function') {
                            showMessage(errorMsg, 'error');
                        } else {
                            alert(errorMsg);
                        }
                    }
                } catch (error) {
                    // 网络错误时，尝试解析响应
                    let errorMsg = '注册失败';
                    if (error.message && error.message.includes('fetch')) {
                        errorMsg = '网络连接失败，请稍后重试';
                    } else {
                        // 尝试从响应中获取错误信息
                        try {
                            if (error.response) {
                                const errorData = await error.response.json();
                                errorMsg = errorData.message || '注册失败';
                            }
                        } catch (e) {
                            errorMsg = '注册失败';
                        }
                    }
                    
                    if (typeof showMessage === 'function') {
                        showMessage(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            }

            // 执行注册
            doRegister();
        }

        // ==================== 管理员弹窗 ====================
        // 显示管理员密码弹窗
        window.showAdminModal = function showAdminModal() {
            const modal = document.getElementById('adminModal');
            if (!modal) return;
            
            // 使用requestAnimationFrame确保DOM更新后再显示，触发动画
            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    document.getElementById('adminPasswordInput').focus();
                }, 50);
            });
        }

        // 关闭管理员密码弹窗
        function closeAdminModal() {
            const modal = document.getElementById('adminModal');
            if (!modal) return;
            
            // 先移除show类，触发关闭动画
            modal.classList.remove('show');
            
            // 等待动画完成后再清理
            setTimeout(() => {
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminMessage').className = 'modal-message';
            }, 300); // 等待过渡动画完成（0.3s）
        }

        // 验证服务器管理密码（从数据库验证，独立于管理员账号）
        async function verifyAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            const msg = document.getElementById('adminMessage');

            if (!password) {
                msg.className = 'modal-message error';
                msg.textContent = '请输入密码';
                setTimeout(() => {
                    msg.className = 'modal-message';
                    msg.textContent = '';
                }, 3000);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/server-manager/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });

                const data = await response.json();
                
                // 检查响应状态
                if (!response.ok || !data.success) {
                    const errorMsg = data.message || '密码错误';
                    msg.className = 'modal-message error';
                    msg.textContent = errorMsg;
                    setTimeout(() => {
                        msg.className = 'modal-message';
                        msg.textContent = '';
                    }, 5000);
                    return;
                }

                if (data.success) {
                    closeAdminModal();
                    const loginPage = document.getElementById('loginPage');
                    const adminPage = document.getElementById('adminPage');
                    
                    if (loginPage) {
                        loginPage.style.display = 'none';
                        document.body.classList.remove('login-mode');
                    }
                    
                    if (adminPage) {
                        adminPage.style.display = 'block';
                        adminPage.classList.add('show');
                        
                        const scheduleUpdate = (callback) => {
                            if (window.requestIdleCallback) {
                                requestIdleCallback(callback, { timeout: 1000 });
                            } else {
                                setTimeout(callback, 100);
                            }
                        };
                        
                        // 使用 requestIdleCallback 在浏览器空闲时更新
                        const scheduleServerUpdate = (callback) => {
                            if (window.requestIdleCallback) {
                                requestIdleCallback(callback, { timeout: 500 });
                            } else {
                                setTimeout(callback, 200);
                            }
                        };
                        
                        scheduleServerUpdate(() => {
                            updateServerDisplay();
                        });
                        
                        scheduleUpdate(() => {
                            updateAdminAccountDisplay();
                        });
                    }
                } else {
                    msg.className = 'modal-message error';
                    msg.textContent = data.message || '密码错误，请重试';
                    setTimeout(() => {
                        msg.className = 'modal-message';
                        msg.textContent = '';
                    }, 5000);
                }
            } catch (error) {
                // 网络错误时，尝试解析响应
                let errorMsg = '密码错误';
                try {
                    if (error.response) {
                        const errorData = await error.response.json();
                        errorMsg = errorData.message || '密码错误';
                    } else if (error.message && error.message.includes('fetch')) {
                        errorMsg = '网络连接失败，请稍后重试';
                    }
                } catch (e) {
                    errorMsg = '密码错误';
                }
                
                msg.className = 'modal-message error';
                msg.textContent = errorMsg;
                setTimeout(() => {
                    msg.className = 'modal-message';
                    msg.textContent = '';
                }, 5000);
            }
        }

        async function backToLogin() {
            // 保存管理员账户数据到localStorage（不再保存serverData，因为服务器数据应该从API实时获取）
            try {
                // 移除：不再保存serverData到localStorage，避免缓存旧的测试数据
                // localStorage.setItem('serverData', JSON.stringify(serverData));
                localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
            } catch (error) {
                console.error('保存数据失败:', error);
            }
            
            // 显示配置已保存对话框
            const result = await showCustomModal('配置已保存', '配置已保存', 'alert', '', [
                { text: '返回登录界面', value: 'login' },
                { text: '进入主面板', value: 'main' }
            ]);

            if (result === 'login') {
                const adminPage = document.getElementById('adminPage');
                const loginPage = document.getElementById('loginPage');
                if (adminPage) {
                    adminPage.classList.remove('show');
                    adminPage.style.display = 'none';
                }
                if (loginPage) {
                    loginPage.style.display = 'flex';
                    document.body.classList.add('login-mode');
                }
                // 切换到用户登录标签（不是管理员登录）
                const userLoginTab = document.querySelector('.login-tab[data-tab="user"]');
                const adminLoginTab = document.querySelector('.login-tab[data-tab="admin"]');
                if (userLoginTab && adminLoginTab) {
                    userLoginTab.classList.add('active');
                    adminLoginTab.classList.remove('active');
                    const userLoginForm = document.getElementById('userLoginForm');
                    const adminLoginForm = document.getElementById('adminLoginForm');
                    if (userLoginForm && adminLoginForm) {
                        userLoginForm.style.display = 'block';
                        adminLoginForm.style.display = 'none';
                    }
                }
            } else if (result === 'main') {
                const adminPage = document.getElementById('adminPage');
                const loginPage = document.getElementById('loginPage');
                // 先隐藏所有页面
                if (adminPage) {
                    adminPage.classList.remove('show');
                    adminPage.style.display = 'none';
                }
                if (loginPage) {
                    loginPage.style.display = 'none';
                    document.body.classList.remove('login-mode');
                }
                // 显示主面板
                const contentWrapper = document.querySelector('.content-wrapper');
                const mainContainer = document.querySelector('.main-container');
                if (contentWrapper) {
                    contentWrapper.style.display = 'flex';
                }
                if (mainContainer) {
                    mainContainer.style.display = 'flex';
                }
                const navHomeBtn = document.getElementById('navHomeBtn');
                if (navHomeBtn && typeof navHomeBtn.click === 'function') {
                    navHomeBtn.click();
                }
            }
        }

        // 回车键提交
        document.getElementById('adminPasswordInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                verifyAdminPassword();
            }
        });

        document.getElementById('loginPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        document.getElementById('adminLoginPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleAdminLogin();
            }
        });

        // 注册表单回车键支持
        document.getElementById('registerUsername').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('registerPassword').focus();
            }
        });

        document.getElementById('registerPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('registerConfirmPassword').focus();
            }
        });

        document.getElementById('registerConfirmPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleRegister();
            }
        });

        // ==================== 显示/隐藏密码 ====================
        // 切换密码显示/隐藏
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        // ==================== 自定义弹窗函数 ====================
        let customModalResolve = null;

        function showCustomModal(title, message, type = 'alert', defaultValue = '', customButtons = null) {
            const modal = document.getElementById('customModal');
            const panel = document.getElementById('customModalPanel');
            const titleEl = document.getElementById('customModalTitle');
            const messageEl = document.getElementById('customModalMessage');
            const inputEl = document.getElementById('customModalInput');
            const buttonsEl = document.getElementById('customModalButtons');

            panel.className = 'custom-modal-panel';
            
            titleEl.textContent = title;
            if (typeof message === 'string') {
                messageEl.textContent = message;
            } else {
                messageEl.innerHTML = message;
            }

            // 根据类型显示输入框
            if (type === 'prompt') {
                inputEl.style.display = 'block';
                inputEl.value = defaultValue;
                inputEl.focus();
            } else {
                inputEl.style.display = 'none';
            }

            // 生成按钮
            buttonsEl.innerHTML = '';
            if (customButtons && Array.isArray(customButtons)) {
                // 自定义按钮
                customButtons.forEach(btnConfig => {
                    const btn = document.createElement('button');
                    btn.className = 'custom-modal-btn confirm';
                    btn.textContent = btnConfig.text;
                    btn.onclick = () => closeCustomModal(btnConfig.value);
                    buttonsEl.appendChild(btn);
                });
            } else if (type === 'alert') {
                const btn = document.createElement('button');
                btn.className = 'custom-modal-btn confirm';
                btn.textContent = '确定';
                btn.onclick = () => closeCustomModal(true);
                buttonsEl.appendChild(btn);
            } else if (type === 'confirm') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'custom-modal-btn cancel';
                cancelBtn.textContent = '取消';
                cancelBtn.onclick = () => closeCustomModal(false);
                buttonsEl.appendChild(cancelBtn);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'custom-modal-btn confirm';
                confirmBtn.textContent = '确定';
                confirmBtn.onclick = () => closeCustomModal(true);
                buttonsEl.appendChild(confirmBtn);
            } else if (type === 'prompt') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'custom-modal-btn cancel';
                cancelBtn.textContent = '取消';
                cancelBtn.onclick = () => closeCustomModal(null);
                buttonsEl.appendChild(cancelBtn);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'custom-modal-btn confirm';
                confirmBtn.textContent = '确定';
                confirmBtn.onclick = () => {
                    const value = inputEl.value.trim();
                    closeCustomModal(value || null);
                };
                buttonsEl.appendChild(confirmBtn);
            }

            // 使用requestAnimationFrame确保DOM更新后再显示，触发动画
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });

            // 回车键确认
            const handleEnter = (e) => {
                if (e.key === 'Enter') {
                    if (type === 'prompt') {
                        const value = inputEl.value.trim();
                        closeCustomModal(value || null);
                    } else {
                        closeCustomModal(true);
                    }
                    inputEl.removeEventListener('keypress', handleEnter);
                }
            };
            if (type === 'prompt') {
                inputEl.addEventListener('keypress', handleEnter);
            }

            // 返回Promise
            return new Promise((resolve) => {
                customModalResolve = resolve;
            });
        }

        function closeCustomModal(result) {
            const modal = document.getElementById('customModal');
            const panel = document.getElementById('customModalPanel');
            const content = document.getElementById('customModalContent');
            
            if (!modal) {
                if (customModalResolve) {
                    customModalResolve(result);
                    customModalResolve = null;
                }
                return;
            }
            
            // 先移除show类，触发关闭动画
            modal.classList.remove('show');
            
            setTimeout(() => {
                if (panel) panel.className = 'custom-modal-panel';
                if (content) content.className = 'custom-modal-content';
                
                // 解决Promise
                if (customModalResolve) {
                    customModalResolve(result);
                    customModalResolve = null;
                }
            }, 300); // 等待过渡动画完成（0.3s）
        }

        async function customAlert(message) {
            await showCustomModal('提示', message, 'alert');
        }

        async function customConfirm(message) {
            return await showCustomModal('确认', message, 'confirm');
        }

        async function customPrompt(message, defaultValue = '') {
            return await showCustomModal('输入', message, 'prompt', defaultValue);
        }

        // ==================== 忘记密码 ====================
        // 处理忘记密码
        function handleForgotPassword() {
            customAlert('请联系管理员并提供正确的用户名');
        }

        //#endregion
        //#region 服务器管理模块（API调用、服务器连接）
        // ==================== 服务器管理 ====================
        let serverData = {
            available: [],
            connected: [],
            disconnected: []
        };

        // 清理localStorage中的旧测试服务器数据（如果有）
        try {
            const savedServerData = localStorage.getItem('serverData');
            if (savedServerData) {
                // 清除旧的测试数据
                localStorage.removeItem('serverData');
                console.log('已清除localStorage中的旧服务器数据');
            }
        } catch (error) {
            console.error('清理localStorage失败:', error);
        }

        let adminAccounts = [];
        // 加载管理员账号
        try {
            const savedAccounts = localStorage.getItem('adminAccounts');
            if (savedAccounts) {
                adminAccounts = JSON.parse(savedAccounts);
            }
        } catch (error) {
            console.error('加载管理员账号失败:', error);
        }
        
        // 移除测试管理员账号
        // const testAdminAccount = { id: 'debug', password: '1', selectedServers: [] };
        // if (!adminAccounts.some(a => a.id === 'debug')) {
        //     adminAccounts.push(testAdminAccount);
        // }
        
        let availableServersForUser = [];
        
        // API基础URL
        const isLocalDev = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1' || 
                          window.location.hostname === '';
        const API_BASE_URL = isLocalDev 
            ? 'http://127.0.0.1:5000/api'  // 本地API地址（端口5000）
            : 'https://autosender.up.railway.app/api';  // 远程API地址
        
        //console.log('API Base URL:', API_BASE_URL, '(Local Dev:', isLocalDev + ')');
        
        async function testAPIConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/servers`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // 添加超时控制
                    signal: AbortSignal.timeout(10000) // 10秒超时
                });
                return { success: true, status: response.status };
            } catch (error) {
                console.error('API连接测试失败:', error);
                return { 
                    success: false, 
                    error: error.message,
                    details: {
                        name: error.name,
                        message: error.message,
                        type: error.name === 'AbortError' ? 'timeout' : 
                              error.message.includes('Failed to fetch') ? 'network' : 
                              error.message.includes('CORS') ? 'cors' : 'unknown'
                    }
                };
            }
        }
        
        // 从API加载服务器列表
        async function loadServersFromAPI() {
            try {
                // 使用 /api/servers 获取所有服务器列表
                // 注意：这里可能需要优化权限，目前假设所有用户/管理员都能看到所有服务器
                // 添加时间戳防止缓存
                const response = await fetch(`${API_BASE_URL}/servers?t=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    signal: AbortSignal.timeout(10000) // 10秒超时
                });
                
                if (!response.ok) {
                    throw new Error(`API响应错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success && data.servers) {
                    // console.log('加载服务器列表成功，服务器数量:', data.servers.length);
                    
                    // 清空现有数据
                    serverData.available = [];
                    serverData.connected = [];
                    serverData.disconnected = [];
                    
                    // 处理每个服务器
                    data.servers.forEach(s => {
                        const serverItem = {
                            name: s.server_name || s.server_id, 
                            url: s.server_url || '', 
                            server_id: s.server_id, 
                            status: s.status,
                            assigned_user_id: s.assigned_user_id || null,
                            last_seen: s.last_seen
                        };
                        
                        // 根据状态分类
                        if (s.status === 'connected') {
                            serverData.connected.push(serverItem);
                        } else if (s.status === 'available') {
                            serverData.available.push(serverItem);
                        } else {
                            // 默认为断开
                            serverData.disconnected.push(serverItem);
                        }
                    });
                    
                    // 更新界面显示
                    updateServerDisplay();
                    
                    // 如果在管理员界面，也更新管理员界面的服务器列表
                    if (document.getElementById('adminManageServersGrid')) {
                       // 刷新管理员服务器选择列表（如果有必要）
                    }
                    
                } else {
                    console.warn('API返回数据格式异常:', data);
                }
            } catch (error) {
                console.error('加载服务器列表失败:', error);
                // 界面上显示错误状态或保留上次数据
            }
        }
        
        // 加载用户可用服务器
        // 独享服务器电话号码列表
        let exclusivePhoneNumbers = [];
        let currentSelectedPhone = null;

        // 加载独享服务器电话号码
        async function loadExclusivePhoneNumbers() {
            if (!currentUserId) {
                document.getElementById('exclusivePhoneSelector').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/${currentUserId}/available-servers`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.exclusive_servers && data.exclusive_servers.length > 0) {
                        // 获取独享服务器的电话号码（从服务器信息中获取）
                        exclusivePhoneNumbers = [];
                        for (const server of data.exclusive_servers) {
                            // 尝试从服务器信息中获取电话号码
                            // 如果API返回了phone_number字段，使用它；否则使用服务器名称或ID
                            const phoneNumber = server.phone_number || server.server_name || server.server_id;
                            if (phoneNumber && !exclusivePhoneNumbers.find(p => p.phone === phoneNumber)) {
                                exclusivePhoneNumbers.push({
                                    phone: phoneNumber,
                                    server_id: server.server_id,
                                    server_name: server.server_name
                                });
                            }
                        }
                        
                        // 如果有独享服务器电话号码，显示选择器
                        if (exclusivePhoneNumbers.length > 0) {
                            document.getElementById('exclusivePhoneSelector').style.display = 'block';
                            if (!currentSelectedPhone && exclusivePhoneNumbers.length > 0) {
                                currentSelectedPhone = exclusivePhoneNumbers[0].phone;
                            }
                            updateExclusivePhoneDisplay();
                        } else {
                            document.getElementById('exclusivePhoneSelector').style.display = 'none';
                        }
                    } else {
                        document.getElementById('exclusivePhoneSelector').style.display = 'none';
                    }
                } else {
                    document.getElementById('exclusivePhoneSelector').style.display = 'none';
                }
            } catch (error) {
                console.error('加载独享服务器电话号码失败:', error);
                document.getElementById('exclusivePhoneSelector').style.display = 'none';
            }
        }

        // 更新独享电话号码显示
        function updateExclusivePhoneDisplay() {
            const currentPhoneDisplay = document.getElementById('currentPhoneDisplay');
            const dropdown = document.getElementById('exclusivePhoneDropdown');
            const btn = document.getElementById('exclusivePhoneBtn');
            
            if (currentSelectedPhone && currentPhoneDisplay) {
                currentPhoneDisplay.textContent = currentSelectedPhone;
            }
            
            if (dropdown) {
                dropdown.innerHTML = '';
                exclusivePhoneNumbers.forEach(item => {
                    const option = document.createElement('div');
                    option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;';
                    if (item.phone === currentSelectedPhone) {
                        option.style.background = 'rgba(76, 175, 80, 0.2)';
                        option.style.fontWeight = 'bold';
                    }
                    option.textContent = item.phone;
                    option.onclick = () => {
                        currentSelectedPhone = item.phone;
                        updateExclusivePhoneDisplay();
                        dropdown.style.display = 'none';
                        loadInboxForPhone(item.phone);
                    };
                    option.onmouseenter = () => {
                        if (item.phone !== currentSelectedPhone) {
                            option.style.background = 'rgba(76, 175, 80, 0.1)';
                        }
                    };
                    option.onmouseleave = () => {
                        if (item.phone !== currentSelectedPhone) {
                            option.style.background = 'transparent';
                        }
                    };
                    dropdown.appendChild(option);
                });
            }
            
            // 设置下拉按钮点击事件
            if (btn) {
                if (exclusivePhoneNumbers.length === 1) {
                    // 只有一个号码时，不显示下拉箭头，不可点击
                    btn.innerHTML = `本机号码: <span id="currentPhoneDisplay">${currentSelectedPhone || '-'}</span>`;
                    btn.onclick = null;
                    btn.style.cursor = 'default';
                } else {
                    // 多个号码时，显示下拉箭头，可点击
                    btn.innerHTML = `本机号码: <span id="currentPhoneDisplay">${currentSelectedPhone || '-'}</span> <span style="font-size: 10px;">▼</span>`;
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        const dropdown = document.getElementById('exclusivePhoneDropdown');
                        if (dropdown) {
                            const isVisible = dropdown.style.display === 'block';
                            dropdown.style.display = isVisible ? 'none' : 'block';
                        }
                    };
                    btn.style.cursor = 'pointer';
                }
            }
        }

        // 切换电话号码的收件箱
        function loadInboxForPhone(phoneNumber) {
            // 这里可以添加切换收件箱的逻辑
            // 例如：根据电话号码过滤收件箱内容
            console.log('切换到电话号码:', phoneNumber);
            // 可以重新加载收件箱数据
        }

        // 点击外部关闭下拉菜单
        document.addEventListener('click', (e) => {
            const selector = document.getElementById('exclusivePhoneSelector');
            const dropdown = document.getElementById('exclusivePhoneDropdown');
            if (selector && dropdown && !selector.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // --- 替换 loadAvailableServersForUser() ---
        async function loadAvailableServersForUser() {
            if (!currentUserId) {
                const selector = document.getElementById('exclusivePhoneSelector');
                if (selector) selector.style.display = 'none';
                return;
            }
            try {
                const resp = await fetch(`${API_BASE_URL}/user/${currentUserId}/servers`);
                const data = await resp.json();
                if (!data || !data.ok) {
                    console.error("loadAvailableServersForUser: unexpected response", data);
                    availableServersForUser = [];
                    const selector = document.getElementById('exclusivePhoneSelector');
                    if (selector) selector.style.display = 'none';
                    return;
                }
                // API returns { ok: true, shared: [...], exclusive: [...], all: [...] }
                const shared = data.shared || [];
                const exclusive = data.exclusive || [];
                // unify format: { server_id, server_name, server_url, type }
                const mapServer = s => ({
                    server_id: s.server_id || s,
                    server_name: s.server_name || s.server_id || s,
                    server_url: s.server_url || s.url || s.server_url,
                    type: (exclusive.find(e => (e.server_id || e) === (s.server_id || s)) ? 'exclusive' : 'public')
                });
                // If server objects are already objects, keep them; otherwise map strings
                const exList = exclusive.map(s => (typeof s === 'string' ? { server_id: s, server_name: s, server_url: s } : s));
                const shList = shared.map(s => (typeof s === 'string' ? { server_id: s, server_name: s, server_url: s } : s));
                availableServersForUser = exList.concat(shList).map(s => ({
                    server_id: s.server_id,
                    server_name: s.server_name,
                    server_url: s.server_url,
                    type: (exList.find(e => e.server_id === s.server_id) ? 'exclusive' : 'public')
                }));
                
                // 修复：移除这里的 connectToAvailableServers() 调用，避免无限循环
                // connectToAvailableServers() 会在其他地方被调用（如初始化时）
                // connectToAvailableServers();

                // 加载独享服务器电话号码
                await loadExclusivePhoneNumbers();
            } catch (err) {
                console.error("loadAvailableServersForUser error:", err);
                availableServersForUser = [];
                const selector = document.getElementById('exclusivePhoneSelector');
                if (selector) selector.style.display = 'none';
            }
        }


        // API模式：服务器由后端自动注册，无需手动连接功能

        // API模式：服务器状态由后端自动管理，前端只需刷新显示
        // 注意：attemptConnect 函数已在后面定义（8208行），这里不再重复定义

        // 删除服务器
        async function deleteServer(serverId) {
            if (!await customConfirm('确定要删除这个服务器吗？')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/servers/${serverId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showMessage('服务器删除成功', 'success');
                        await loadServersFromAPI();
                    } else {
                        await customAlert('删除服务器失败: ' + (data.message || '未知错误'));
                    }
                } else {
                    const error = await response.json();
                    await customAlert('删除服务器失败: ' + (error.message || '网络错误'));
                }
            } catch (error) {
                await customAlert('删除服务器失败: ' + error.message);
            }
        }

        // 更新服务器显示
        // 更新服务器列表显示（主页面用）
        function updateServerListDisplay() {
            const container = document.getElementById('serverList');
            if (!container) return;

            container.innerHTML = '';

            // 显示已连接的服务器
            serverData.connected.forEach(server => {
                const div = document.createElement('div');
                div.className = 'server-item connected';
                div.innerHTML = `
                    <div class="server-info">
                        <span class="server-name">${escapeHtml(server.name)}</span>
                        <span class="server-url">${escapeHtml(server.url)}</span>
                    </div>
                    <button class="btn-delete" onclick="deleteServer('${server.server_id}')">删除</button>
                `;
                container.appendChild(div);
            });

            // 显示可用的服务器
            serverData.available.forEach(server => {
                const div = document.createElement('div');
                div.className = `server-item ${server.status || 'available'}`;
                div.innerHTML = `
                    <div class="server-info">
                        <span class="server-name">${escapeHtml(server.name)}</span>
                        <span class="server-url">${escapeHtml(server.url)}</span>
                    </div>
                    <button class="btn-connect" onclick="attemptConnect(${JSON.stringify(server).replace(/"/g, '&quot;')})">使用</button>
                    <button class="btn-delete" onclick="deleteServer('${server.server_id}')">删除</button>
                `;
                container.appendChild(div);
            });
        }

        // 注意：loadServersFromAPI 函数已在前面定义（7733行），这里不再重复定义
        // 服务器状态轮询（定期更新服务器列表）
        let serverPollingInterval = null;
        
        function startServerPolling() {
            // 停止之前的轮询
            if (serverPollingInterval) {
                clearInterval(serverPollingInterval);
            }
            
            // 立即执行一次
            loadServersFromAPI();
            
            // 每10秒轮询一次服务器状态
            serverPollingInterval = setInterval(() => {
                loadServersFromAPI();
            }, 10000);
        }
        
        function stopServerPolling() {
            if (serverPollingInterval) {
                clearInterval(serverPollingInterval);
                serverPollingInterval = null;
            }
        }

        // 连接到所有已分配的服务器
        async function connectToAssignedServers() {
            const user_id = localStorage.getItem('user_id');
            if (!user_id) return;

            // API模式：启动收件箱轮询和服务器状态轮询
            startInboxPolling(user_id);
            startServerPolling();
            // 加载服务器列表
            await loadServersFromAPI();
        }
        
        // 收件箱轮询
        let inboxPollingInterval = null;
        
        function startInboxPolling(userId) {
            // 停止之前的轮询
            if (inboxPollingInterval) {
                clearInterval(inboxPollingInterval);
            }
            
            // 立即执行一次
            pollInbox(userId);
            
            // 每3秒轮询一次收件箱
            inboxPollingInterval = setInterval(() => {
                pollInbox(userId);
            }, 3000);
        }
        
        function stopInboxPolling() {
            if (inboxPollingInterval) {
                clearInterval(inboxPollingInterval);
                inboxPollingInterval = null;
            }
        }
        
        async function pollInbox(userId) {
            if (!userId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/${userId}/inbox`);
                const data = await response.json();
                
                if (data.ok) {
                    // 更新收件箱
                    if (data.conversations && data.conversations.length > 0) {
                        updateContactList(data.conversations);
                    }
                    
                    // 更新当前对话（如果有）
                    if (currentChatId) {
                        await loadConversationMessages(currentChatId);
                    }
                }
            } catch (err) {
                console.error("轮询收件箱失败:", err);
            }
        }
        
        async function loadConversationMessages(chatId) {
            if (!currentUserId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/${currentUserId}/conversations/${chatId}/messages`);
                const data = await response.json();
                
                if (data.success && data.messages) {
                    const conversationDisplay = document.getElementById('conversationDisplay');
                    if (conversationDisplay) {
                        conversationDisplay.innerHTML = '';
                        data.messages.forEach(msg => {
                            const bubble = document.createElement('div');
                            bubble.className = msg.is_from_me ? 'chat-bubble right' : 'chat-bubble left';
                            bubble.innerHTML = `
                                <span>${msg.message_text || msg.text}</span>
                                <div class="chat-time">${new Date(msg.message_timestamp || msg.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
                            `;
                            conversationDisplay.appendChild(bubble);
                        });
                        conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
                    }
                }
            } catch (err) {
                console.error("加载对话消息失败:", err);
            }
        }


        if (localStorage.getItem('user_id')) {
            connectToAssignedServers();
        }

        // 尝试连接服务器（已改为API模式，不再使用WebSocket）
        function attemptConnect(server) {
            // 直接标记为已连接，因为后端已经通过API注册了
            const index = serverData.available.findIndex(s => s.name === server.name);
            if (index !== -1) {
                serverData.available.splice(index, 1);
                server.status = 'connected';
                serverData.connected.push(server);
                updateServerDisplay();
                showMessage(`服务器 ${server.name} 已通过API连接`, 'success');
            }
        }

        // 连接可用服务器（已改为API模式）
        function connectAvailableServer(serverName) {
            const server = serverData.available.find(s => s.name === serverName);
            if (!server) return;

            // API模式：直接标记为已连接
            attemptConnect(server);
        }

        // 刷新服务器状态（API模式：服务器状态由后端自动管理）
        async function reconnectServer(serverName) {
            // API模式：重新从后端加载服务器列表，获取最新状态
            await loadServersFromAPI();
            showMessage(`已刷新服务器 ${serverName} 的状态`, 'success');
        }

        // 更新服务器显示
        let updateServerDisplayTimer = null;
        function updateServerDisplay() {
            // 清除之前的定时器，实现防抖
            if (updateServerDisplayTimer) {
                clearTimeout(updateServerDisplayTimer);
            }
            
            // 增加防抖时间，减少更新频率
            updateServerDisplayTimer = setTimeout(() => {
                const availableContainer = document.getElementById('availableServers');
                const connectedContainer = document.getElementById('connectedServers');
                
                // 如果不在服务器管理页面，直接返回，避免不必要的操作
                if (!availableContainer && !connectedContainer) {
                    return;
                }
                
                const serverExclusiveMap = new Map();
                // 先处理API返回的assigned_user_id
                [...serverData.connected, ...serverData.available, ...(serverData.disconnected || [])].forEach(server => {
                    if (server.assigned_user_id) {
                        serverExclusiveMap.set(server.name, server.assigned_user_id);
                    }
                });
                // 再处理本地管理员分配的用户组（只处理API没有返回的情况）
                adminAccounts.forEach(account => {
                    if (account.userGroups) {
                        account.userGroups.forEach(group => {
                            if (group.servers) {
                                group.servers.forEach(serverName => {
                                    if (!serverExclusiveMap.has(serverName)) {
                                        serverExclusiveMap.set(serverName, group.userId);
                                    }
                                });
                            }
                        });
                    }
                });
                
                const getExclusiveInfo = (serverName) => {
                    const userId = serverExclusiveMap.get(serverName);
                    return userId ? { isExclusive: true, displayName: `独享-${userId}` } : { isExclusive: false, displayName: serverName };
                };
                
                if (!availableContainer) {
                    if (connectedContainer) {
                        // 只更新已连接列表
                        const connectedFragment = document.createDocumentFragment();
                        connectedContainer.innerHTML = '';
                        serverData.connected.forEach(server => {
                            const btn = document.createElement('button');
                            btn.className = 'server-button connected';
                            
                            // 使用优化后的查找方法
                            const exclusiveInfo = getExclusiveInfo(server.name);
                            const isExclusive = exclusiveInfo.isExclusive;
                            
                            // 如果已分配，使用渐变色样式
                            if (isExclusive) {
                                btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%)';
                                btn.style.color = 'white';
                            }
                            
                            // 提取端口号或编号
                            const portMatch = server.url.match(/:(\d+)/);
                            const port = portMatch ? portMatch[1] : (server.port || server.name.match(/\d+/)?.[0] || '?');
                            
                            btn.innerHTML = `
                                <div class="server-button-name">${port}</div>
                                <div class="server-tooltip">
                                    <div style="font-weight: bold; margin-bottom: 4px;">${server.name}</div>
                                    <div style="font-size: 11px; opacity: 0.9;">${server.url}</div>
                                    ${isExclusive ? '<div style="font-size: 11px; color: #ff6b6b; margin-top: 4px;">独享服务器</div>' : ''}
                                </div>
                            `;
                            btn.onclick = () => btn.classList.toggle('active');
                            connectedFragment.appendChild(btn);
                        });
                        connectedContainer.appendChild(connectedFragment);
                        const countEl = document.getElementById('connectedCount');
                        if (countEl) {
                            countEl.textContent = `(${serverData.connected.length})`;
                        }
                    }
                    return;
                }
                
                const availableFragment = document.createDocumentFragment();
                availableContainer.innerHTML = '';
                
                // 只显示未连接的服务器（过滤掉已连接的）
                const unconnectedServers = serverData.available.filter(server => {
                    // 排除已连接的服务器（通过 server_id 或 name 匹配）
                    const isConnected = serverData.connected.some(connected => 
                        connected.server_id === server.server_id || 
                        (connected.name === server.name && connected.url === server.url)
                    );
                    return !isConnected;
                });
                
                unconnectedServers.forEach(server => {
                    const btn = document.createElement('button');
                    btn.className = 'server-button' + (server.status === 'connecting' ? ' connecting' : '');
                    if (server.status === 'connecting') {
                        const portMatch = server.url.match(/:(\d+)/);
                        const port = portMatch ? portMatch[1] : (server.port || server.name.match(/\d+/)?.[0] || '?');
                        btn.innerHTML = `
                            <div class="server-button-name">...</div>
                            <div class="server-tooltip">
                                <div style="font-weight: bold; margin-bottom: 4px;">连接中...</div>
                                <div style="font-size: 11px; opacity: 0.9;">${server.url}</div>
                            </div>
                        `;
                    } else {
                        // 使用优化后的查找方法（O(1) 查找，而不是 O(n*m) 嵌套循环）
                        const exclusiveInfo = getExclusiveInfo(server.name);
                        const isExclusive = exclusiveInfo.isExclusive;
                        
                        // 如果已分配，使用渐变色样式
                        if (isExclusive) {
                            btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%)';
                            btn.style.color = 'white';
                        }
                        
                        // 提取端口号或编号
                        const portMatch = server.url.match(/:(\d+)/);
                        const port = portMatch ? portMatch[1] : (server.port || server.name.match(/\d+/)?.[0] || '?');
                        
                        btn.innerHTML = `
                            <div class="server-button-name">${port}</div>
                            <div class="server-tooltip">
                                <div style="font-weight: bold; margin-bottom: 4px;">${server.name}</div>
                                <div style="font-size: 11px; opacity: 0.9;">${server.url}</div>
                                ${isExclusive ? '<div style="font-size: 11px; color: #ff6b6b; margin-top: 4px;">独享服务器</div>' : ''}
                            </div>
                        `;
                        btn.onclick = (e) => {
                            btn.classList.toggle('active');
                            connectAvailableServer(server.name);
                        };
                    }
                    availableFragment.appendChild(btn);
                });
                availableContainer.appendChild(availableFragment);

                // 更新已连接列表
                if (connectedContainer) {
                    const connectedFragment = document.createDocumentFragment();
                    connectedContainer.innerHTML = '';
                    serverData.connected.forEach(server => {
                        const btn = document.createElement('button');
                        btn.className = 'server-button connected';
                        
                        // 使用优化后的查找方法（O(1) 查找）
                        const exclusiveInfo = getExclusiveInfo(server.name);
                        const isExclusive = exclusiveInfo.isExclusive;
                        
                        // 如果已分配，使用渐变色样式
                        if (isExclusive) {
                            btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%)';
                            btn.style.color = 'white';
                        }
                        
                        // 提取端口号或编号
                        const portMatch = server.url.match(/:(\d+)/);
                        const port = portMatch ? portMatch[1] : (server.port || server.name.match(/\d+/)?.[0] || '?');
                        
                        btn.innerHTML = `
                            <div class="server-button-name">${port}</div>
                            <div class="server-tooltip">
                                <div style="font-weight: bold; margin-bottom: 4px;">${server.name}</div>
                                <div style="font-size: 11px; opacity: 0.9;">${server.url}</div>
                                ${isExclusive ? '<div style="font-size: 11px; color: #ff6b6b; margin-top: 4px;">独享服务器</div>' : ''}
                            </div>
                        `;
                        btn.onclick = () => btn.classList.toggle('active');
                        connectedFragment.appendChild(btn);
                    });
                    connectedContainer.appendChild(connectedFragment);
                    const countEl = document.getElementById('connectedCount');
                    if (countEl) {
                        countEl.textContent = `(${serverData.connected.length})`;
                    }
                }

                const disconnectedContainer = document.getElementById('disconnectedServers');
                if (disconnectedContainer) {
                    const disconnectedFragment = document.createDocumentFragment();
                    disconnectedContainer.innerHTML = '';
                    serverData.disconnected.forEach(server => {
                        const btn = document.createElement('button');
                        btn.className = 'server-button disconnected';
                        // 提取端口号或编号
                        const portMatch = server.url.match(/:(\d+)/);
                        const port = portMatch ? portMatch[1] : (server.port || server.name.match(/\d+/)?.[0] || '?');
                        
                        btn.innerHTML = `
                            <div class="server-button-name">${port}</div>
                            <div class="server-tooltip">
                                <div style="font-weight: bold; margin-bottom: 4px;">${server.name}</div>
                                <div style="font-size: 11px; opacity: 0.9;">${server.url}</div>
                            </div>
                        `;
                        btn.onclick = (e) => {
                            if (e.target !== reconnectBtn) {
                                btn.classList.toggle('active');
                            }
                        };
                        const reconnectBtn = document.createElement('button');
                        reconnectBtn.className = 'server-action-btn reconnect';
                        reconnectBtn.textContent = '重连';
                        reconnectBtn.onclick = () => reconnectServer(server.name);
                        btn.appendChild(reconnectBtn);
                        disconnectedFragment.appendChild(btn);
                    });
                    disconnectedContainer.appendChild(disconnectedFragment);
                    const disconnectedCountEl = document.getElementById('disconnectedCount');
                    if (disconnectedCountEl) {
                        disconnectedCountEl.textContent = `(${serverData.disconnected.length})`;
                    }
                }
            }, 50); // 50ms防抖
        }

        // ==================== 管理员账户管理 ====================
        // 显示添加管理员弹窗
        function showAddAdminModal() {
            const modal = document.getElementById('addAdminModal');
            if (!modal) return;
            
            const idInput = document.getElementById('newAdminId');
            const passwordInput = document.getElementById('newAdminPassword');
            
            idInput.value = '';
            passwordInput.value = '';
            
            // 移除旧的事件监听器（如果存在）
            const idHandler = idInput._enterHandler;
            const passwordHandler = passwordInput._enterHandler;
            if (idHandler) idInput.removeEventListener('keypress', idHandler);
            if (passwordHandler) passwordInput.removeEventListener('keypress', passwordHandler);
            
            // 添加回车键支持
            const idEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    passwordInput.focus();
                }
            };
            const passwordEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addAdminAccount();
                }
            };
            
            idInput.addEventListener('keypress', idEnterHandler);
            passwordInput.addEventListener('keypress', passwordEnterHandler);
            
            // 保存引用以便后续移除
            idInput._enterHandler = idEnterHandler;
            passwordInput._enterHandler = passwordEnterHandler;
            
            // 使用requestAnimationFrame确保DOM更新后再显示，触发动画
            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    idInput.focus();
                }, 50);
            });
        }

        // 关闭添加管理员弹窗
        function closeAddAdminModal() {
            const modal = document.getElementById('addAdminModal');
            if (!modal) return;
            
            // 先移除show类，触发关闭动画
            modal.classList.remove('show');
            
            // 等待动画完成后再清理
            setTimeout(() => {
                document.getElementById('newAdminId').value = '';
                document.getElementById('newAdminPassword').value = '';
            }, 150); // 等待过渡动画完成（0.15s）
        }

        async function addAdminAccount() {
            const id = document.getElementById('newAdminId').value.trim();
            const password = document.getElementById('newAdminPassword').value.trim();

            if (!id || !password) {
                await customAlert('请填写管理员ID和密码');
                return;
            }

            if (adminAccounts.some(a => a.id === id)) {
                // 先关闭添加管理员弹窗，再显示提示
                closeAddAdminModal();
                setTimeout(async () => {
                    await customAlert('该管理员ID已存在');
                }, 300);
                return;
            }

            adminAccounts.push({ id, password, selectedServers: [] });
            
            try {
                localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
            } catch (error) {
                console.error('保存管理员账号到localStorage失败:', error);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/account`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_id: id,
                        password: password
                    })
                });
                
                if (!response.ok) {
                    console.warn('保存管理员账号到数据库失败，但已保存到本地');
                }
            } catch (error) {
                console.warn('无法连接到API服务器保存管理员账号，但已保存到本地:', error);
            }
            
            // 关闭弹窗
            closeAddAdminModal();
            
            // 等待弹窗关闭动画完成后再显示成功提示
            setTimeout(async () => {
                await customAlert('管理员账号已添加');
                updateAdminAccountDisplay();
            }, 150);
        }

        // ==================== 服务器管理密码设置 ====================
        // 显示密码修改弹窗
        function showPasswordChangeModal() {
            const modal = document.getElementById('passwordChangeModal');
            if (!modal) return;
            
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            
            oldPasswordInput.value = '';
            newPasswordInput.value = '';
            
            // 移除旧的事件监听器（如果存在）
            const oldHandler = oldPasswordInput._enterHandler;
            const newHandler = newPasswordInput._enterHandler;
            if (oldHandler) oldPasswordInput.removeEventListener('keypress', oldHandler);
            if (newHandler) newPasswordInput.removeEventListener('keypress', newHandler);
            
            // 添加回车键支持
            const oldEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    newPasswordInput.focus();
                }
            };
            const newEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    updateServerManagerPassword();
                }
            };
            
            oldPasswordInput.addEventListener('keypress', oldEnterHandler);
            newPasswordInput.addEventListener('keypress', newEnterHandler);
            
            // 保存引用以便后续移除
            oldPasswordInput._enterHandler = oldEnterHandler;
            newPasswordInput._enterHandler = newEnterHandler;
            
            // 使用requestAnimationFrame确保DOM更新后再显示，触发动画
            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    oldPasswordInput.focus();
                }, 50);
            });
        }

        // 关闭密码修改弹窗
        function closePasswordChangeModal() {
            const modal = document.getElementById('passwordChangeModal');
            if (!modal) return;
            
            // 先移除show类，触发关闭动画
            modal.classList.remove('show');
            
            // 等待动画完成后再清理
            setTimeout(() => {
                document.getElementById('oldPasswordInput').value = '';
                document.getElementById('newPasswordInput').value = '';
            }, 150); // 等待过渡动画完成（0.15s）
        }

        // ==================== 积分充值功能 ====================
        // 显示充值面板
        function showRechargeModal() {
            const modal = document.getElementById('rechargeModal');
            if (!modal) return;
            
            // 清空输入和显示
            document.getElementById('rechargeUserIdInput').value = '';
            document.getElementById('rechargeAmountInput').value = '';
            document.getElementById('rechargeUserInfo').style.display = 'none';
            document.getElementById('rechargeRecordsList').innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">请先验证用户以查看充值记录</div>';
            currentRechargeUserId = null;
            
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
                // 聚焦到用户ID输入框
                document.getElementById('rechargeUserIdInput').focus();
            }, 10);
            
            // 添加回车键支持
            const userIdInput = document.getElementById('rechargeUserIdInput');
            const amountInput = document.getElementById('rechargeAmountInput');
            
            // 移除旧的事件监听器
            if (userIdInput._enterHandler) {
                userIdInput.removeEventListener('keypress', userIdInput._enterHandler);
            }
            if (amountInput._enterHandler) {
                amountInput.removeEventListener('keypress', amountInput._enterHandler);
            }
            
            // 用户ID输入框回车：验证用户
            userIdInput._enterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifyRechargeUser();
                }
            };
            userIdInput.addEventListener('keypress', userIdInput._enterHandler);
            
            // 充值金额输入框回车：确认充值
            amountInput._enterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmRecharge();
                }
            };
            amountInput.addEventListener('keypress', amountInput._enterHandler);
        }
        
        // 关闭充值面板
        function closeRechargeModal() {
            const modal = document.getElementById('rechargeModal');
            if (!modal) return;
            
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('rechargeUserIdInput').value = '';
                document.getElementById('rechargeAmountInput').value = '';
                document.getElementById('rechargeUserInfo').style.display = 'none';
            }, 150);
        }
        
        // 验证用户
        let currentRechargeUserId = null;
        async function verifyRechargeUser() {
            const userId = document.getElementById('rechargeUserIdInput').value.trim();
            if (!userId) {
                alert('请输入用户ID');
                return;
            }
            
            try {
                // 获取用户积分
                const creditsResp = await fetch(`${API_BASE_URL}/user/${userId}/credits`);
                if (!creditsResp.ok) {
                    if (creditsResp.status === 404) {
                        alert('用户不存在');
                        return;
                    }
                    throw new Error('获取用户信息失败');
                }
                
                const creditsData = await creditsResp.json();
                if (!creditsData.success) {
                    alert('用户不存在');
                    return;
                }
                
                // 获取用户详细信息（包括usage记录）
                const userResp = await fetch(`${API_BASE_URL}/user/${userId}/statistics`);
                let userData = null;
                if (userResp.ok) {
                    const data = await userResp.json();
                    if (data.success) {
                        userData = data;
                    }
                }
                
                currentRechargeUserId = userId;
                const credits = creditsData.credits || 0;
                
                // 解析usage记录，找出充值记录
                const usage = userData?.usage || [];
                const rechargeRecords = usage.filter(item => item.action === 'recharge');
                const lastRecharge = rechargeRecords.length > 0 ? rechargeRecords[rechargeRecords.length - 1] : null;
                
                // 计算总消费（usage中所有非recharge的credits总和）
                let totalSpent = 0;
                usage.forEach(item => {
                    if (item.action !== 'recharge' && item.credits) {
                        totalSpent += parseFloat(item.credits) || 0;
                    }
                });
                
                // 显示用户信息
                document.getElementById('rechargeInfoUserId').textContent = userId;
                document.getElementById('rechargeInfoUsername').textContent = userData?.username || '-';
                document.getElementById('rechargeInfoCredits').textContent = credits.toFixed(2);
                if (lastRecharge) {
                    const lastRechargeTime = lastRecharge.ts ? new Date(lastRecharge.ts).toLocaleString('zh-CN', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }) : '-';
                    const lastRechargeAmount = parseFloat(lastRecharge.amount || 0).toFixed(2);
                    document.getElementById('rechargeInfoLastRecharge').textContent = `${lastRechargeTime} (${lastRechargeAmount})`;
                } else {
                    document.getElementById('rechargeInfoLastRecharge').textContent = '无';
                }
                document.getElementById('rechargeInfoTotalSpent').textContent = totalSpent.toFixed(2);
                const createdDate = userData?.created ? new Date(userData.created).toLocaleString('zh-CN') : '-';
                document.getElementById('rechargeInfoCreated').textContent = createdDate;
                
                document.getElementById('rechargeUserInfo').style.display = 'block';
                
                // 显示充值记录
                displayRechargeRecords(rechargeRecords);
                
            } catch (error) {
                console.error('验证用户失败:', error);
                alert('验证用户失败: ' + error.message);
            }
        }
        
        // 显示充值记录
        function displayRechargeRecords(records) {
            const container = document.getElementById('rechargeRecordsList');
            if (!records || records.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">暂无充值记录</div>';
                return;
            }
            
            // 按时间倒序排列
            const sortedRecords = records.sort((a, b) => {
                const timeA = new Date(a.ts || 0).getTime();
                const timeB = new Date(b.ts || 0).getTime();
                return timeB - timeA;
            });
            
            let html = '<div style="display: grid; grid-template-columns: 80px 1fr 200px 150px; gap: 15px; padding: 12px 15px; background: #f9f9f9; font-weight: bold; border-bottom: 2px solid #ddd; font-size: 14px;">';
            html += '<div>记录</div><div>用户</div><div>时间</div><div style="text-align: right;">充值金额</div></div>';
            
            sortedRecords.forEach((record, index) => {
                const time = record.ts ? new Date(record.ts).toLocaleString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : '-';
                const amount = parseFloat(record.amount || 0).toFixed(2);
                const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                html += `<div style="display: grid; grid-template-columns: 80px 1fr 200px 150px; gap: 15px; padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #eee; font-size: 14px; align-items: center;">`;
                html += `<div style="color: #666;">${index + 1}</div>`;
                html += `<div style="color: #333;">${currentRechargeUserId}</div>`;
                html += `<div style="color: #666; font-size: 13px;">${time}</div>`;
                html += `<div style="color: #4CAF50; font-weight: bold; text-align: right;">+${amount}</div>`;
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        // 确认充值
        async function confirmRecharge() {
            if (!currentRechargeUserId) {
                alert('请先验证用户');
                return;
            }
            
            const amount = parseFloat(document.getElementById('rechargeAmountInput').value);
            if (!amount || amount <= 0) {
                alert('请输入有效的充值金额');
                return;
            }
            
            if (!confirm(`确认给用户 ${currentRechargeUserId} 充值 ${amount} 积分吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/${currentRechargeUserId}/recharge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    // 显示成功消息
                    if (typeof showMessage === 'function') {
                        showMessage(`充值成功！用户当前余额: ${data.credits.toFixed(2)}`, 'success');
                    } else {
                        alert(`充值成功！用户当前余额: ${data.credits.toFixed(2)}`);
                    }
                    // 清空充值金额输入
                    document.getElementById('rechargeAmountInput').value = '';
                    // 重新验证用户以更新信息和充值记录
                    await verifyRechargeUser();
                } else {
                    const errorMsg = data.message || '未知错误';
                    if (typeof showMessage === 'function') {
                        showMessage('充值失败: ' + errorMsg, 'error');
                    } else {
                        alert('充值失败: ' + errorMsg);
                    }
                }
            } catch (error) {
                console.error('充值失败:', error);
                alert('充值失败: ' + error.message);
            }
        }
        
        // 更新服务器管理密码
        async function updateServerManagerPassword() {
            const oldPassword = document.getElementById('oldPasswordInput').value.trim();
            const newPassword = document.getElementById('newPasswordInput').value.trim();
            
            if (!oldPassword) {
                await customAlert('请输入旧密码');
                document.getElementById('oldPasswordInput').focus();
                return;
            }
            
            if (!newPassword) {
                await customAlert('请输入新密码');
                document.getElementById('newPasswordInput').focus();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/server-manager/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        oldPassword: oldPassword,
                        password: newPassword 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // 极短暂延迟后显示成功提示
                    setTimeout(async () => {
                        await customAlert('修改成功');
                        // 点击确定后关闭修改密码窗口
                        closePasswordChangeModal();
                    }, 100);
                } else {
                    await customAlert(data.message || '更新失败，请检查旧密码是否正确');
                    document.getElementById('oldPasswordInput').focus();
                }
            } catch (error) {
                console.error('更新服务器管理密码失败:', error);
                await customAlert('网络错误，请检查API服务器连接');
            }
        }


        async function editAdminAccount(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            const newPassword = await customPrompt('请输入新密码:', account.password);
            if (newPassword && newPassword.trim()) {
                account.password = newPassword.trim();
                updateAdminAccountDisplay();
            }
        }

        async function deleteAdminAccount(adminId) {
            const confirmed = await customConfirm('确定要删除该管理员账户吗？');
            if (confirmed) {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/account/${adminId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        adminAccounts = adminAccounts.filter(a => a.id !== adminId);
                        updateAdminAccountDisplay();
                    } else {
                        const errorData = await response.json();
                        await customAlert(errorData.message || '删除管理员账号失败');
                    }
                } catch (error) {
                    await customAlert('无法连接到API服务器: ' + error.message);
                }
            }
        }

        function updateAdminAccountDisplay() {
            const container = document.getElementById('adminAccountList');
            const fragment = document.createDocumentFragment();
            container.innerHTML = '';
            adminAccounts.forEach(account => {
                const item = document.createElement('div');
                item.className = 'admin-account-item';
                // 显示已分配的服务器数量，而不是管理用户数量
                const serverCount = (account.selectedServers && account.selectedServers.length) || 0;
                item.innerHTML = `
                    <span class="admin-account-name">
                        <span class="admin-account-badge">${serverCount}</span>
                        ${account.id}
                    </span>
                    <div class="admin-account-actions">
                        <button class="admin-account-action-btn manage" onclick="manageAdminAccount('${account.id}')">管理</button>
                    </div>
                `;
                fragment.appendChild(item);
            });
            container.appendChild(fragment);
        }

        // 管理管理员账户
        async function manageAdminAccount(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            if (!account.selectedServers) account.selectedServers = [];

            // 确保使用已连接的服务器列表
            const allServers = serverData.connected.map(s => s.name || s.server_name || s.server_id);

            const panel = document.getElementById('customModalPanel');
            panel.classList.add('admin-manage-modal');

            const content = document.getElementById('customModalContent');
            content.className = 'admin-manage-content';

            const titleEl = document.getElementById('customModalTitle');
            const messageEl = document.getElementById('customModalMessage');
            const buttonsEl = document.getElementById('customModalButtons');
            const inputEl = document.getElementById('customModalInput');

            titleEl.textContent = `管理管理员: ${account.id}`;
            messageEl.innerHTML = `
                <div class="admin-manage-info-row">
                    <div class="admin-manage-info">
                        <div class="admin-manage-info-item">
                            <span class="admin-manage-info-label">ID:</span>
                            <span>${account.id}</span>
                        </div>
                        <div class="admin-manage-info-item">
                            <span class="admin-manage-info-label">密码:</span>
                            <span style="font-family: monospace;">${account.password}</span>
                        </div>
                    </div>
                    <div class="admin-manage-actions">
                        <button class="admin-account-action-btn edit" onclick="editAdminPasswordInModal('${adminId}')">修改密码</button>
                        <button class="admin-account-action-btn delete" onclick="deleteAdminInModal('${adminId}')">删除账号</button>
                    </div>
                </div>
                <div class="admin-manage-permission-row">
                    <div class="admin-manage-permission-label">管理权限:</div>
                    <div class="admin-manage-servers-label">可管理的后端服务器:</div>
                    <div class="admin-manage-servers-grid" id="adminManageServersGrid">
                        ${allServers.length > 0 ? allServers.map(server => {
                // 检查是否已选中（直接字符串匹配，去除空格）
                const serverStr = String(server).trim();
                const isSelected = account.selectedServers.some(selected => 
                    String(selected).trim() === serverStr
                );
                // 转义服务器名称，防止XSS
                const escapedServer = serverStr.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\\/g, '\\\\');
                return `<button class="admin-manage-server-btn ${isSelected ? 'selected' : ''}" 
                                    onclick="toggleServerSelection('${adminId}', '${escapedServer}', this)">
                                    ${escapedServer}
                                </button>`;
            }).join('') : '<div style="padding: 10px; color: #666; text-align: center;">暂无已连接的服务器</div>'}
                    </div>
                </div>
            `;
            inputEl.style.display = 'none';

            buttonsEl.innerHTML = `
                <button class="admin-manage-footer-btn reset" onclick="resetAdminSelection('${adminId}')">重置</button>
                <button class="admin-manage-footer-btn select-all" onclick="selectAllServers('${adminId}')">全选</button>
                <button class="admin-manage-footer-btn confirm" onclick="confirmAdminManage('${adminId}')">确定</button>
            `;

            const modal = document.getElementById('customModal');
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }

        function toggleServerSelection(adminId, serverName, button) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            if (!account.selectedServers) account.selectedServers = [];

            const index = account.selectedServers.indexOf(serverName);
            if (index > -1) {
                account.selectedServers.splice(index, 1);
                button.classList.remove('selected');
            } else {
                account.selectedServers.push(serverName);
                button.classList.add('selected');
            }
        }

        function resetAdminSelection(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            account.selectedServers = [];
            const grid = document.getElementById('adminManageServersGrid');
            const buttons = grid.querySelectorAll('.admin-manage-server-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
        }

        function selectAllServers(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            // 只显示已连接的服务器，使用服务器名称
            const allServers = serverData.connected.map(s => {
                return s.name || s.server_name || s.server_id || String(s);
            });

            account.selectedServers = [...allServers];
            const grid = document.getElementById('adminManageServersGrid');
            const buttons = grid.querySelectorAll('.admin-manage-server-btn');
            buttons.forEach(btn => btn.classList.add('selected'));
        }

        async function confirmAdminManage(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;
            
            const grid = document.getElementById('adminManageServersGrid');
            if (grid) {
                const selectedButtons = grid.querySelectorAll('.admin-manage-server-btn.selected');
                account.selectedServers = Array.from(selectedButtons).map(btn => btn.textContent.trim());
            }

            try {
                localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
            } catch (error) {
                console.error('保存管理员账号到localStorage失败:', error);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/account/${adminId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selected_servers: account.selectedServers || []
                    })
                });
                
                if (!response.ok) {
                    console.warn('保存管理员账号配置到数据库失败，但已保存到本地');
                }
            } catch (error) {
                console.warn('无法连接到API服务器保存管理员账号配置，但已保存到本地:', error);
            }

            // 关闭弹窗
            closeCustomModal();
            
            updateAdminAccountDisplay();
            
            // 等待弹窗关闭动画完成后再显示成功提示
            setTimeout(async () => {
                await customAlert('管理员配置已保存');
            }, 300);
        }

        async function editAdminPasswordInModal(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            const newPassword = await customPrompt('请输入新密码:', account.password);
            if (newPassword && newPassword.trim()) {
                account.password = newPassword.trim();
                // 保存修改
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('保存管理员账号失败:', error);
                }
                setTimeout(() => {
                    manageAdminAccount(adminId);
                }, 350);
            }
        }

        async function deleteAdminInModal(adminId) {
            const confirmed = await customConfirm('确定要删除该管理员账户吗？');
            if (confirmed) {
                adminAccounts = adminAccounts.filter(a => a.id !== adminId);
                
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('保存管理员账号到localStorage失败:', error);
                }
                
                // 尝试从数据库删除（API）
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/account/${adminId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        console.warn('从数据库删除管理员账号失败，但已从本地删除');
                    }
                } catch (error) {
                    console.warn('无法连接到API服务器删除管理员账号，但已从本地删除:', error);
                }
                
                closeCustomModal();
                updateAdminAccountDisplay();
            }
        }

        // 页面加载时不初始化（页面还未显示，避免不必要的DOM操作）
        // 只在真正打开服务器管理页面时才初始化

        //#endregion
        //#region 管理员页面功能模块（用户管理、服务器分配）
        // ==================== 管理员页面功能 ====================
        let currentManagerId = null;
        let managerUsers = [];
        let managerUserGroups = [];
        let currentGroupCreation = null;

        // 管理员登录后进入管理员页面
        async function loginAsManager(managerId) {
            const account = adminAccounts.find(a => a.id === managerId);
            if (!account) {
                customAlert('管理员账户不存在');
                return;
            }

            currentManagerId = managerId;
            
            // 隐藏登录页面
            const loginPage = document.getElementById('loginPage');
            if (loginPage) {
                loginPage.style.display = 'none';
            }
            document.body.classList.remove('login-mode');
            
            const managerPage = document.getElementById('managerPage');
            if (managerPage) {
                managerPage.style.display = 'block';
                managerPage.classList.add('show');
                document.getElementById('managerIdDisplay').textContent = managerId;
                const adminIndex = adminAccounts.findIndex(a => a.id === managerId);
                document.getElementById('adminNumberDisplay').textContent = adminIndex >= 0 ? (adminIndex + 1) : '1';
            } else {
                console.error('找不到管理员页面元素 #managerPage');
                customAlert('管理员页面加载失败，请刷新页面重试');
                return;
            }

            if (!account.users) account.users = [];
            if (!account.userGroups) account.userGroups = [];
            managerUsers = account.users || [];
            managerUserGroups = account.userGroups || [];

            // 先加载服务器数据，再更新显示
            try {
                await loadServersFromAPI();
            } catch (error) {
                console.error('加载服务器数据失败:', error);
            }
            
            // 加载管理员配置
            try {
                const response = await fetch(`${API_BASE_URL}/admin/account/${managerId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // 更新本地数据
                        if (data.selected_servers) {
                            account.selectedServers = data.selected_servers;
                        }
                        localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                    }
                }
            } catch (error) {
                console.warn('从API加载管理员配置失败，使用本地数据:', error);
            }
            
            // 确保页面显示后再更新内容（关键更新）
            requestAnimationFrame(() => {
                updateManagerDisplay();
            });
            
            const schedulePerformanceLoad = (callback) => {
                if (window.requestIdleCallback) {
                    requestIdleCallback(callback, { timeout: 2000 });
                } else {
                    setTimeout(callback, 500);
                }
            };
            
            schedulePerformanceLoad(async () => {
                await loadManagerPerformance();
            });
        }

        async function backToLoginFromManager() {
            // 保存数据
            if (currentManagerId) {
                const account = adminAccounts.find(a => a.id === currentManagerId);
                if (account) {
                    account.users = managerUsers;
                    account.userGroups = managerUserGroups;
                }
                
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('保存管理员数据失败:', error);
                }
            }
            
            // 显示配置已保存对话框
            const result = await showCustomModal('配置已保存', '配置已保存', 'alert', '', [
                { text: '返回登录界面', value: 'login' },
                { text: '进入主面板', value: 'main' }
            ]);

            // 先关闭管理员页面
            const managerPage = document.getElementById('managerPage');
            const loginPage = document.getElementById('loginPage');
            const contentWrapper = document.querySelector('.content-wrapper');
            
            if (managerPage) {
                managerPage.classList.remove('show');
                managerPage.style.display = 'none';
            }

            if (result === 'login') {
                if (loginPage) {
                    loginPage.style.display = 'flex';
                    document.body.classList.add('login-mode');
                }
                if (contentWrapper) {
                    contentWrapper.style.display = 'none';
                }
                // 清除管理员相关状态
                currentManagerId = null;
                managerUsers = [];
                managerUserGroups = [];
                // 切换到用户登录标签（不是管理员登录）
                const userLoginTab = document.querySelector('.login-tab[data-tab="user"]');
                const adminLoginTab = document.querySelector('.login-tab[data-tab="admin"]');
                if (userLoginTab && adminLoginTab) {
                    userLoginTab.classList.add('active');
                    adminLoginTab.classList.remove('active');
                    const userLoginForm = document.getElementById('userLoginForm');
                    const adminLoginForm = document.getElementById('adminLoginForm');
                    if (userLoginForm && adminLoginForm) {
                        userLoginForm.style.display = 'block';
                        adminLoginForm.style.display = 'none';
                    }
                }
            } else if (result === 'main') {
                // 进入主面板
                // 先隐藏所有页面
                if (loginPage) {
                    loginPage.style.display = 'none';
                    document.body.classList.remove('login-mode');
                }
                if (managerPage) {
                    managerPage.style.display = 'none';
                    managerPage.classList.remove('show');
                }
                // 重置当前管理员ID
                currentManagerId = null;
                // 显示主面板
                if (contentWrapper) {
                    contentWrapper.style.display = 'flex';
                }
                const mainContainer = document.querySelector('.main-container');
                if (mainContainer) {
                    mainContainer.style.display = 'flex';
                }
                const navHomeBtn = document.getElementById('navHomeBtn');
                if (navHomeBtn && typeof navHomeBtn.click === 'function') {
                    navHomeBtn.click();
                }
            }
        }

        function isValidUserId(userId) {
            // 格式1: MM/DD/N (例如: 12111 表示12月11日第1个用户)
            const dateIdPattern = /^(\d{2})(\d{2})(\d{1,3})$/;
            if (dateIdPattern.test(userId)) {
                const month = parseInt(userId.substring(0, 2));
                const day = parseInt(userId.substring(2, 4));
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    return true;
                }
            }
            // 格式2: 用户名（至少4位，字母或数字）
            if (/^[a-zA-Z0-9]{4,}$/.test(userId)) {
                return true;
            }
            return false;
        }

        // 验证用户是否存在（真实调用后端）
        async function verifyUserExists(userId) {
            try {
                // 使用获取积分接口来探测用户是否存在
                const response = await fetch(`${API_BASE_URL}/user/${userId}/credits`);
                if (response.ok) {
                    const data = await response.json();
                    return data.success;
                }
                return false;
            } catch (error) {
                console.error('验证用户失败:', error);
                return false;
            }
        }

        // 显示添加用户弹窗
        function showAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (!modal) return;
            
            document.getElementById('addUserUsername').value = '';
            document.getElementById('addUserUserId').value = '';
            
            // 添加Enter键支持
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    confirmAddUser();
                }
            };
            
            const usernameInput = document.getElementById('addUserUsername');
            const userIdInput = document.getElementById('addUserUserId');
            
            usernameInput.removeEventListener('keypress', handleKeyPress);
            userIdInput.removeEventListener('keypress', handleKeyPress);
            usernameInput.addEventListener('keypress', handleKeyPress);
            userIdInput.addEventListener('keypress', handleKeyPress);
            
            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    document.getElementById('addUserUsername').focus();
                }, 100);
            });
        }

        // 关闭添加用户弹窗
        function closeAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (!modal) return;
            
            modal.classList.remove('show');
            setTimeout(() => {
                document.getElementById('addUserUsername').value = '';
                document.getElementById('addUserUserId').value = '';
            }, 300);
        }

        // 确认添加用户
        async function confirmAddUser() {
            const username = document.getElementById('addUserUsername').value.trim();
            const userId = document.getElementById('addUserUserId').value.trim();
            
            if (!username && !userId) {
                await customAlert('请输入用户名或用户ID');
                return;
            }

            // 优先使用用户ID，如果有的话
            let finalUserId = userId;
            
            // 如果只有用户名，尝试查找对应的用户ID
            if (!finalUserId && username) {
                // 这里暂时假设输入的就是ID，或者后续需要增加通过用户名查ID的接口
                // 目前逻辑保持简单：管理员必须知道用户ID
                if (!isValidUserId(username)) {
                     // 如果格式不像ID，提示用户
                     await customAlert('请输入有效的用户ID（格式：MMDDN，如12111）');
                     return;
                }
                finalUserId = username;
            }

            // 验证ID格式
            if (!isValidUserId(finalUserId)) {
                await customAlert('用户ID格式错误！(格式：MMDDN，如12111)');
                return;
            }

            // 验证用户是否存在
            const exists = await verifyUserExists(finalUserId);
            if (!exists) {
                await customAlert('用户不存在！请检查ID是否正确');
                return;
            }

            if (managerUsers.includes(finalUserId)) {
                await customAlert('该用户已在管理列表中');
                return;
            }

            managerUsers.push(finalUserId);
            
            // 保存...
            const account = adminAccounts.find(a => a.id === currentManagerId);
            if (account) {
                account.users = managerUsers;
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('保存管理员账号失败:', error);
                }
            }
            
            closeAddUserModal();
            updateManagerDisplay();
            await loadManagerPerformance();
        }

        async function addUser() {
            await showAddUserModal();
        }

        async function removeUser(userId) {
            managerUsers = managerUsers.filter(u => u !== userId);
            managerUserGroups = managerUserGroups.filter(g => g.userId !== userId);
            
            const account = adminAccounts.find(a => a.id === currentManagerId);
            if (account) {
                account.users = managerUsers;
                account.userGroups = managerUserGroups;
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('保存管理员账号失败:', error);
                }
            }
            
            updateManagerDisplay();
            await loadManagerPerformance();
        }

        function createGroup() {
            if (managerUsers.length === 0) {
                customAlert('请先添加用户');
                return;
            }

            currentGroupCreation = {
                userId: null,
                selectedServers: [],
                showingServers: false
            };

            updateManagerDisplay();
        }

        function selectUserForGroup(userId) {
            if (!currentGroupCreation) return;
            currentGroupCreation.userId = userId;
            updateManagerDisplay();
        }

        function showServerSelection() {
            if (!currentGroupCreation) return;
            currentGroupCreation.showingServers = !currentGroupCreation.showingServers;
            updateManagerDisplay();
        }

        function toggleServerForGroup(serverName) {
            if (!currentGroupCreation) return;

            const index = currentGroupCreation.selectedServers.indexOf(serverName);
            if (index > -1) {
                currentGroupCreation.selectedServers.splice(index, 1);
            } else {
                currentGroupCreation.selectedServers.push(serverName);
            }
            updateManagerDisplay();
        }

        async function confirmGroupCreation() {
            if (!currentGroupCreation || !currentGroupCreation.userId) {
                await customAlert('请选择用户');
                return;
            }

            if (currentGroupCreation.selectedServers.length === 0) {
                await customAlert('请至少选择一个服务器');
                return;
            }

            const allServers = [
                ...serverData.available,
                ...serverData.connected,
                ...serverData.disconnected
            ];

            for (const serverName of currentGroupCreation.selectedServers) {
                const server = allServers.find(s => s.name === serverName);
                if (server && server.server_id) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/servers/${server.server_id}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: currentGroupCreation.userId
                            })
                        });
                        if (!response.ok) {
                            console.error(`分配服务器 ${serverName} 失败`);
                        }
                    } catch (error) {
                        console.error(`分配服务器 ${serverName} 失败:`, error);
                    }
                }
            }

            const existingGroup = managerUserGroups.find(g => g.userId === currentGroupCreation.userId);
            if (existingGroup) {
                existingGroup.servers = [...currentGroupCreation.selectedServers];
            } else {
                managerUserGroups.push({
                    userId: currentGroupCreation.userId,
                    servers: [...currentGroupCreation.selectedServers]
                });
            }

            currentGroupCreation = null;
            await loadServersFromAPI();
            updateManagerDisplay();
        }

        function resetGroupCreation() {
            currentGroupCreation = null;
            updateManagerDisplay();
        }

        function manageUserGroup(userId) {
            const group = managerUserGroups.find(g => g.userId === userId);
            if (!group) return;

            currentGroupCreation = {
                userId: userId,
                selectedServers: [...group.servers],
                showingServers: false
            };
            updateManagerDisplay();
        }

        async function deleteUserGroup(userId) {
            const group = managerUserGroups.find(g => g.userId === userId);
            if (group) {
                const allServers = [
                    ...serverData.available,
                    ...serverData.connected,
                    ...serverData.disconnected
                ];
                
                for (const serverName of group.servers) {
                    const server = allServers.find(s => s.name === serverName);
                    if (server && server.server_id) {
                        try {
                            await fetch(`${API_BASE_URL}/servers/${server.server_id}/unassign`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                        } catch (error) {
                            console.error(`取消分配服务器 ${serverName} 失败:`, error);
                        }
                    }
                }
            }
            
            managerUserGroups = managerUserGroups.filter(g => g.userId !== userId);
            await loadServersFromAPI();
            updateManagerDisplay();
        }

        // 加载管理员业绩数据
        async function loadManagerPerformance() {
            if (!currentManagerId) return;
            
            try {
                let totalCredits = 0;
                const userPerformanceData = [];
                
                // 遍历所有管理的用户，获取他们的积分消耗数据
                for (const userId of managerUsers) {
                    try {
                        let userCredits = 0;
                        try {
                            const response = await fetch(`${API_BASE_URL}/user/${userId}/statistics`, {
                                method: 'GET',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                // 计算总消耗积分（从consumption_logs中累加）
                                if (data.consumption_logs && Array.isArray(data.consumption_logs)) {
                                    userCredits = data.consumption_logs.reduce((sum, log) => sum + (log.amount || 0), 0);
                                }
                            }
                        } catch (apiError) {
                            // API不存在或出错，使用默认值0
                            console.warn(`获取用户 ${userId} 统计数据失败，使用默认值:`, apiError);
                        }
                        
                        totalCredits += userCredits;
                        userPerformanceData.push({
                            userId: userId,
                            credits: userCredits
                        });
                    } catch (error) {
                        console.error(`处理用户 ${userId} 数据失败:`, error);
                        userPerformanceData.push({
                            userId: userId,
                            credits: 0
                        });
                    }
                }
                
                const totalPerformanceDisplay = document.getElementById('totalPerformanceDisplay');
                if (totalPerformanceDisplay) {
                    totalPerformanceDisplay.textContent = totalCredits.toFixed(2);
                }
                
                // 更新业绩简要显示
                const container = document.getElementById('performanceBriefContainer');
                container.innerHTML = '';
                
                userPerformanceData.forEach((item, index) => {
                    if (index % 2 === 0) {
                        // 每行两个，创建新行
                        const row = document.createElement('div');
                        row.style.display = 'flex';
                        row.style.gap = '10px';
                        row.style.width = '100%';
                        row.style.marginBottom = '10px';
                        
                        // 第一个用户
                        const card1 = createPerformanceCard(item.userId, item.credits);
                        row.appendChild(card1);
                        
                        // 第二个用户（如果存在）
                        if (index + 1 < userPerformanceData.length) {
                            const nextItem = userPerformanceData[index + 1];
                            const card2 = createPerformanceCard(nextItem.userId, nextItem.credits);
                            row.appendChild(card2);
                        } else {
                            // 占位，保持布局
                            const placeholder = document.createElement('div');
                            placeholder.style.flex = '1';
                            row.appendChild(placeholder);
                        }
                        
                        container.appendChild(row);
                    }
                });
            } catch (error) {
                console.error('加载业绩数据失败:', error);
            }
        }

        // 创建业绩卡片
        function createPerformanceCard(userId, credits) {
            const card = document.createElement('div');
            card.style.cssText = `
                flex: 1;
                padding: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                border-radius: 12px;
                border: 2px solid var(--border-dark);
                color: white;
                font-weight: bold;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            `;
            card.innerHTML = `
                <div style="font-size: 14px; margin-bottom: 5px;">${userId}</div>
                <div style="font-size: 16px; color: #ffd700;">${credits.toFixed(2)} 积分</div>
            `;
            return card;
        }

        // 获取用户数据的通用函数
        async function fetchUserData(userId) {
            let userData = {
                userId: userId,
                credits: 0,
                lastAccess: '未知',
                lastTaskCount: 0,
                lastSuccessRate: 0,
                lastSentCount: 0,
                lastCreditsUsed: 0,
                totalAccessCount: 0,
                totalSentCount: 0,
                totalSentAmount: 0,
                totalSuccessRate: 0,
                totalCreditsUsed: 0
            };
            
            try {
                // 获取用户积分
                try {
                    const creditsResponse = await fetch(`${API_BASE_URL}/user/${userId}/credits`);
                    if (creditsResponse.ok) {
                        const creditsData = await creditsResponse.json();
                        userData.credits = creditsData.credits || 0;
                    }
                } catch (error) {
                    console.warn('获取用户积分失败，使用默认值:', error);
                }
                
                // 获取用户统计数据
                try {
                    const statsResponse = await fetch(`${API_BASE_URL}/user/${userId}/statistics`);
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        if (statsData.usage_logs && statsData.usage_logs.length > 0) {
                            const lastLog = statsData.usage_logs[statsData.usage_logs.length - 1];
                            userData.lastTaskCount = lastLog.task_count || 0;
                            userData.lastSentCount = lastLog.sent_count || 0;
                            userData.lastSuccessRate = lastLog.success_rate || 0;
                            userData.lastAccess = lastLog.timestamp || '未知';
                        }
                        if (statsData.consumption_logs && statsData.consumption_logs.length > 0) {
                            const lastConsumption = statsData.consumption_logs[statsData.consumption_logs.length - 1];
                            userData.lastCreditsUsed = lastConsumption.amount || 0;
                        }
                        
                        // 计算总计
                        userData.totalAccessCount = statsData.usage_logs ? statsData.usage_logs.length : 0;
                        userData.totalSentCount = statsData.usage_logs ? statsData.usage_logs.reduce((sum, log) => sum + (log.sent_count || 0), 0) : 0;
                        userData.totalSentAmount = statsData.usage_logs ? statsData.usage_logs.reduce((sum, log) => sum + (log.total_sent || 0), 0) : 0;
                        userData.totalCreditsUsed = statsData.consumption_logs ? statsData.consumption_logs.reduce((sum, log) => sum + (log.amount || 0), 0) : 0;
                        
                        if (userData.totalSentCount > 0) {
                            const totalSuccess = statsData.usage_logs ? statsData.usage_logs.reduce((sum, log) => sum + (log.success_count || 0), 0) : 0;
                            userData.totalSuccessRate = (totalSuccess / userData.totalSentCount * 100).toFixed(2);
                        }
                    }
                } catch (error) {
                    console.warn('获取用户统计数据失败，使用默认值:', error);
                }
            } catch (error) {
                console.error('获取用户数据失败:', error);
            }
            
            return userData;
        }
        
        // 生成用户详情内容的通用函数
        function generateUserDetailContent(userData, userId, showServerSection = true) {
            let serverSectionHtml = '';
            
            if (showServerSection) {
                // 获取该用户分配的服务器
                const userGroup = managerUserGroups.find(g => g.userId === userId);
                const assignedServers = userGroup ? userGroup.servers : [];
                
                // 获取分配给当前管理员的服务器
                const account = adminAccounts.find(a => a.id === currentManagerId);
                const managerAssignedServers = account && account.selectedServers ? account.selectedServers : [];
                
                serverSectionHtml = `
                    <div class="user-detail-server-section">
                        <div class="user-detail-server-header">
                            <div style="font-size: 14px; font-weight: bold;">分配私有服务器</div>
                            <div class="user-detail-server-hint" style="font-size: 11px;">设置独享服务器 获得私有号码 定位接收信息 开通收件箱双向功能</div>
                        </div>
                        <div class="user-detail-server-explanation" style="font-size: 10px; margin-bottom: 8px;">可用服务器为 私有服务器+共享服务器</div>
                        <div id="userServerSelectionGrid" class="user-detail-server-grid">
                            ${managerAssignedServers.map(serverName => {
                                const isSelected = assignedServers.includes(serverName);
                                return `<button class="server-button-new ${isSelected ? 'selected' : ''}" 
                                            onclick="toggleUserServerSelection('${userId}', '${serverName}', this)">
                                        ${serverName}
                                    </button>`;
                            }).join('')}
                        </div>
                        <div class="user-detail-footer">
                            <button class="admin-manage-footer-btn reset" onclick="resetUserServerSelection('${userId}')">重置</button>
                            <button class="admin-manage-footer-btn confirm" onclick="confirmUserServerSelection('${userId}')">确定</button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="user-detail-header">
                    <div style="font-size: 16px; font-weight: bold;">用户ID: ${userData.userId}</div>
                    <div style="display: flex; gap: 15px; font-size: 13px;">
                        <div>积分余额: <span style="color: #4caf50; font-weight: bold;">${userData.credits.toFixed(2)}</span></div>
                        <div>上次访问: <span style="color: #666;">${userData.lastAccess}</span></div>
                    </div>
                </div>
                
                <div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">用户使用数据（统计数据）:</div>
                    <div class="user-detail-stats-grid">
                        <div class="user-detail-stat-card">
                            <div class="user-detail-stat-label">上次发送任务次数</div>
                            <div class="user-detail-stat-value">${userData.lastTaskCount}</div>
                        </div>
                        <div class="user-detail-stat-card">
                            <div class="user-detail-stat-label">上次成功率</div>
                            <div class="user-detail-stat-value">${userData.lastSuccessRate.toFixed(2)}%</div>
                        </div>
                        <div class="user-detail-stat-card">
                            <div class="user-detail-stat-label">上次发送量</div>
                            <div class="user-detail-stat-value">${userData.lastSentCount}</div>
                        </div>
                        <div class="user-detail-stat-card">
                            <div class="user-detail-stat-label">上次消耗积分</div>
                            <div class="user-detail-stat-value">${userData.lastCreditsUsed.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">总计数据:</div>
                    <div class="user-detail-stats-grid">
                        <div style="padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">总访问次数</div>
                            <div style="font-size: 16px; font-weight: bold;">${userData.totalAccessCount}</div>
                        </div>
                        <div style="padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">总发送次数</div>
                            <div style="font-size: 16px; font-weight: bold;">${userData.totalSentCount}</div>
                        </div>
                        <div style="padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">总发送量</div>
                            <div style="font-size: 16px; font-weight: bold;">${userData.totalSentAmount}</div>
                        </div>
                        <div style="padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <div style="font-size: 11px; color: #666;">成功率</div>
                            <div style="font-size: 16px; font-weight: bold;">${userData.totalSuccessRate}%</div>
                        </div>
                        <div style="padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; grid-column: 1 / -1;">
                            <div style="font-size: 11px; color: #666;">积分消耗总数</div>
                            <div style="font-size: 16px; font-weight: bold; color: #f44336;">${userData.totalCreditsUsed.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                ${serverSectionHtml}
            `;
        }
        
        // 显示用户详情对话框
        async function showUserDetailModal(userId) {
            const modal = document.getElementById('userDetailModal');
            const content = document.getElementById('userDetailContent');
            if (!modal || !content) return;
            
            // 获取用户数据
            const userData = await fetchUserData(userId);
            
            // 生成内容
            content.innerHTML = generateUserDetailContent(userData, userId, true);
            
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }
        
        // 加载账号管理面板内容（当前登录用户）
        async function loadAccountPanelContent() {
            const panelE = document.getElementById('panelE');
            if (!panelE) return;
            
            const panelContent = panelE.querySelector('.panel-content');
            if (!panelContent) return;
            
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                panelContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">未登录</div>';
                return;
            }
            
            // 显示加载中
            panelContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">加载中...</div>';
            
            // 获取用户数据
            const userData = await fetchUserData(userId);
            
            // 生成内容（不显示服务器分配部分，因为这是用户自己的账号）
            panelContent.innerHTML = generateUserDetailContent(userData, userId, false);
        }
        

        // 关闭用户详情对话框
        function closeUserDetailModal() {
            const modal = document.getElementById('userDetailModal');
            if (!modal) return;
            modal.classList.remove('show');
        }

        // 切换用户服务器选择
        function toggleUserServerSelection(userId, serverName, button) {
            const userGroup = managerUserGroups.find(g => g.userId === userId);
            if (!userGroup) {
                managerUserGroups.push({
                    userId: userId,
                    servers: [serverName]
                });
                button.classList.add('selected');
            } else {
                const index = userGroup.servers.indexOf(serverName);
                if (index > -1) {
                    userGroup.servers.splice(index, 1);
                    button.classList.remove('selected');
                } else {
                    userGroup.servers.push(serverName);
                    button.classList.add('selected');
                }
            }
        }

        function resetUserServerSelection(userId) {
            const userGroup = managerUserGroups.find(g => g.userId === userId);
            if (userGroup) {
                userGroup.servers = [];
            }
            const grid = document.getElementById('userServerSelectionGrid');
            if (grid) {
                const buttons = grid.querySelectorAll('.admin-manage-server-btn');
                buttons.forEach(btn => btn.classList.remove('selected'));
            }
        }

        // 确认用户服务器选择
        async function confirmUserServerSelection(userId) {
            const userGroup = managerUserGroups.find(g => g.userId === userId);
            const selectedServers = userGroup ? userGroup.servers : [];
            
            // 分配服务器给用户（调用API）
            const allServers = [
                ...serverData.available,
                ...serverData.connected,
                ...serverData.disconnected
            ];
            
            for (const serverName of selectedServers) {
                const server = allServers.find(s => s.name === serverName);
                if (server && server.server_id) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/servers/${server.server_id}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: userId
                            })
                        });
                        if (!response.ok) {
                            console.error(`分配服务器 ${serverName} 失败`);
                        }
                    } catch (error) {
                        console.error(`分配服务器 ${serverName} 失败:`, error);
                    }
                }
            }
            
            // 取消之前分配但现在未选中的服务器
            const account = adminAccounts.find(a => a.id === currentManagerId);
            const managerAssignedServers = account && account.selectedServers ? account.selectedServers : [];
            for (const serverName of managerAssignedServers) {
                if (!selectedServers.includes(serverName)) {
                    const server = allServers.find(s => s.name === serverName);
                    if (server && server.server_id) {
                        try {
                            await fetch(`${API_BASE_URL}/servers/${server.server_id}/unassign`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                        } catch (error) {
                            console.error(`取消分配服务器 ${serverName} 失败:`, error);
                        }
                    }
                }
            }
            
            await loadServersFromAPI();
            closeUserDetailModal();
            updateManagerDisplay();
            await customAlert('服务器分配已保存');
        }

        // 更新管理员面板显示
        let updateManagerDisplayTimer = null;
        function updateManagerDisplay() {
            // 清除之前的定时器，实现防抖
            if (updateManagerDisplayTimer) {
                clearTimeout(updateManagerDisplayTimer);
            }
            
            // 增加防抖时间，减少更新频率
            updateManagerDisplayTimer = setTimeout(async () => {
                const userList = document.getElementById('userList');
                if (!userList) return; // 如果不在管理员页面，直接返回
                
                // 显示加载状态
                userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">加载中...</div>';
                
                const managerUserCountDisplay = document.getElementById('managerUserCountDisplay');
                if (managerUserCountDisplay) {
                    managerUserCountDisplay.textContent = managerUsers.length;
                }
                
                const fragment = document.createDocumentFragment();
                
                const CONCURRENT_LIMIT = 5;
                const userDataPromises = [];
                
                // 分批处理用户数据
                for (let i = 0; i < managerUsers.length; i += CONCURRENT_LIMIT) {
                    const batch = managerUsers.slice(i, i + CONCURRENT_LIMIT);
                    
                    // 批量获取用户数据
                    const batchPromises = batch.map(async (userId) => {
                        // 获取该用户分配的服务器数量
                        const userGroup = managerUserGroups.find(g => g.userId === userId);
                        const serverCount = userGroup ? userGroup.servers.length : 0;
                        
                        // 获取用户统计数据
                        let lastSentCount = 0;
                        let creditsBalance = 0;
                        
                        try {
                            const [creditsResponse, statsResponse] = await Promise.all([
                                fetch(`${API_BASE_URL}/user/${userId}/credits`).catch(() => null),
                                fetch(`${API_BASE_URL}/user/${userId}/statistics`).catch(() => null)
                            ]);
                            
                            if (creditsResponse && creditsResponse.ok) {
                                const creditsData = await creditsResponse.json();
                                creditsBalance = creditsData.credits || 0;
                            }
                            
                            if (statsResponse && statsResponse.ok) {
                                const statsData = await statsResponse.json();
                                if (statsData.usage_logs && statsData.usage_logs.length > 0) {
                                    const lastLog = statsData.usage_logs[statsData.usage_logs.length - 1];
                                    lastSentCount = lastLog.sent_count || 0;
                                }
                            }
                        } catch (error) {
                            console.warn(`获取用户 ${userId} 数据失败:`, error);
                        }
                        
                        // 创建用户按钮
                        const userButton = document.createElement('div');
                        userButton.className = 'user-button';
                        const escapedUserId = String(userId).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        userButton.innerHTML = `
                            <div class="user-button-content">
                                <div class="user-server-count-badge">${serverCount}</div>
                                <div class="user-button-info">
                                    <div class="user-button-top">
                                        <span class="user-id-text">${escapedUserId}</span>
                                        <button class="user-manage-btn" onclick="showUserDetailModal('${escapedUserId}')">管理</button>
                                    </div>
                                    <div class="user-button-stats">
                                        <div class="user-stat-item">
                                            <span class="user-stat-label">last:</span>
                                            <span class="user-stat-value">${lastSentCount}</span>
                                        </div>
                                        <div class="user-stat-item">
                                            <span class="user-stat-label">balance:</span>
                                            <span class="user-stat-value">$${creditsBalance.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        return userButton;
                    });
                    
                    // 等待当前批次完成
                    const batchResults = await Promise.all(batchPromises);
                    batchResults.forEach(button => fragment.appendChild(button));
                    
                    // 每批完成后立即更新 DOM，提供渐进式加载体验
                    if (fragment.children.length > 0) {
                        userList.innerHTML = '';
                        userList.appendChild(fragment.cloneNode(true));
                    }
                }
                
                // 最终更新
                userList.innerHTML = '';
                userList.appendChild(fragment);

            const allServers = [
                ...serverData.available,
                ...serverData.connected,
                ...serverData.disconnected
            ];

            const availableContainer = document.getElementById('managerAvailableServers');
            if (!availableContainer) {
                return;
            }
            availableContainer.innerHTML = '';

            // 获取分配给当前管理员的服务器（从服务器管理页面设置的 selectedServers）
            const account = adminAccounts.find(a => a.id === currentManagerId);
            let managerAssignedServers = [];
            
            if (account && account.selectedServers) {
                managerAssignedServers = account.selectedServers;
            } else {
                fetch(`${API_BASE_URL}/admin/account/${currentManagerId}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        return null;
                    })
                    .then(data => {
                        if (data && data.success && data.selected_servers) {
                            managerAssignedServers = data.selected_servers;
                            // 更新本地数据
                            if (account) {
                                account.selectedServers = managerAssignedServers;
                                localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                            }
                            // 重新渲染显示
                            updateManagerDisplay();
                        }
                    })
                    .catch(error => {
                        console.warn('从API加载管理员服务器配置失败:', error);
                    });
            }
            
            const assignedServers = new Set();
            managerUserGroups.forEach(group => {
                group.servers.forEach(s => assignedServers.add(s));
            });

            // 获取分配给该管理员的服务器（包括已连接和未连接的）
            const managerServers = allServers.filter(server => {
                return managerAssignedServers.includes(server.name);
            });

            // 分离已分配和可用的服务器
            const selectedInCreation = currentGroupCreation ? new Set(currentGroupCreation.selectedServers) : new Set();
            const assignedToUsers = managerServers.filter(server => 
                assignedServers.has(server.name) || selectedInCreation.has(server.name)
            );
            const availableForAssignment = managerServers.filter(server => 
                !assignedServers.has(server.name) && !selectedInCreation.has(server.name)
            );

            // 显示已分配给用户的服务器区域
            if (assignedToUsers.length > 0) {
                const assignedSection = document.createElement('div');
                assignedSection.style.marginBottom = '20px';
                assignedSection.style.padding = '15px';
                assignedSection.style.background = 'rgba(255, 193, 7, 0.1)';
                assignedSection.style.borderRadius = '12px';
                assignedSection.style.border = '2px solid rgba(255, 193, 7, 0.3)';
                
                const assignedTitle = document.createElement('div');
                assignedTitle.style.fontSize = '14px';
                assignedTitle.style.fontWeight = 'bold';
                assignedTitle.style.color = 'var(--text-dark)';
                assignedTitle.style.marginBottom = '10px';
                assignedTitle.textContent = `已分配给用户 (${assignedToUsers.length})`;
                assignedSection.appendChild(assignedTitle);
                
                const assignedGrid = document.createElement('div');
                assignedGrid.className = 'server-buttons-grid-new';
                assignedGrid.style.gap = '18px';
                
                assignedToUsers.forEach(server => {
                    const btn = document.createElement('button');
                    btn.className = 'admin-manage-server-btn';
                    const serverName = server.name || server.server_name || server.server_id || String(server);
                    
                    // 如果正在创建分组且该服务器被选中，添加选中效果
                    if (currentGroupCreation && currentGroupCreation.selectedServers.includes(serverName)) {
                        btn.classList.add('selected', 'active');
                        btn.onclick = () => {
                            btn.classList.toggle('active');
                            toggleServerForGroup(serverName);
                        };
                    } else {
                        btn.onclick = () => btn.classList.toggle('active');
                    }
                    
                    const portMatch = (server.url || '').match(/:(\d+)/);
                    const port = portMatch ? portMatch[1] : (server.port || serverName.match(/\d+/)?.[0] || '?');
                    btn.textContent = port;
                    btn.title = serverName;
                    assignedGrid.appendChild(btn);
                });
                
                assignedSection.appendChild(assignedGrid);
                availableContainer.appendChild(assignedSection);
            }

            if (availableForAssignment.length > 0) {
                const availableSection = document.createElement('div');
                availableSection.style.marginBottom = '20px';
                availableSection.style.padding = '15px';
                availableSection.style.background = 'rgba(76, 175, 80, 0.1)';
                availableSection.style.borderRadius = '12px';
                availableSection.style.border = '2px solid rgba(76, 175, 80, 0.3)';
                
                const availableTitle = document.createElement('div');
                availableTitle.style.fontSize = '14px';
                availableTitle.style.fontWeight = 'bold';
                availableTitle.style.color = 'var(--text-dark)';
                availableTitle.style.marginBottom = '10px';
                availableTitle.textContent = `可分配给用户 (${availableForAssignment.length})`;
                availableSection.appendChild(availableTitle);
                
                const availableGrid = document.createElement('div');
                availableGrid.className = 'server-buttons-grid-new';
                availableGrid.style.gap = '18px';
                
                availableForAssignment.forEach(server => {
                    const btn = document.createElement('button');
                    btn.className = 'admin-manage-server-btn';
                    const serverName = server.name || server.server_name || server.server_id || String(server);
                    
                    // 如果正在创建分组，添加选中效果
                    if (currentGroupCreation) {
                        const isSelected = currentGroupCreation.selectedServers.includes(serverName);
                        if (isSelected) {
                            btn.classList.add('selected', 'active');
                        }
                        btn.onclick = () => {
                            btn.classList.toggle('active');
                            toggleServerForGroup(serverName);
                        };
                    } else {
                        btn.onclick = () => btn.classList.toggle('active');
                    }
                    
                    const portMatch = (server.url || '').match(/:(\d+)/);
                    const port = portMatch ? portMatch[1] : (server.port || serverName.match(/\d+/)?.[0] || '?');
                    btn.textContent = port;
                    btn.title = serverName;
                    availableGrid.appendChild(btn);
                });
                
                availableSection.appendChild(availableGrid);
                availableContainer.appendChild(availableSection);
            } else if (managerAssignedServers.length === 0) {
                // 如果没有分配的服务器，显示提示
                const noServerMsg = document.createElement('div');
                noServerMsg.style.padding = '15px';
                noServerMsg.style.textAlign = 'center';
                noServerMsg.style.color = '#666';
                noServerMsg.style.fontSize = '14px';
                noServerMsg.textContent = '暂无分配给您的服务器，请联系服务器管理员分配';
                availableContainer.appendChild(noServerMsg);
            }

            // 更新用户分组显示
            const groupsContainer = document.getElementById('userGroupsContainer');
            if (!groupsContainer) return;
            groupsContainer.innerHTML = '';

            // 显示分组创建区域
            if (currentGroupCreation) {
                const createArea = document.createElement('div');
                createArea.className = 'group-creation-area';

                const selectedServerNames = currentGroupCreation.selectedServers;
                const unselectedServers = allServers.filter(s =>
                    !selectedServerNames.includes(s.name) &&
                    (!assignedServers.has(s.name) || selectedServerNames.includes(s.name))
                );

                createArea.innerHTML = `
                    <div class="group-creation-row">
                        <button class="group-select-btn ${currentGroupCreation.userId ? 'selected' : ''}" 
                                onclick="selectUserForGroup('${currentGroupCreation.userId || ''}')">
                            ${currentGroupCreation.userId || 'Please select user'}
                        </button>
                        ${!currentGroupCreation.userId ? managerUsers.map(userId => `
                            <button class="group-select-btn" 
                                    onclick="selectUserForGroup('${userId}')">
                                ${userId}
                            </button>
                        `).join('') : ''}
                    </div>
                    <div class="group-creation-row">
                        <button class="group-select-btn ${currentGroupCreation.selectedServers.length > 0 ? 'selected' : ''}" 
                                onclick="showServerSelection()">
                            ${currentGroupCreation.selectedServers.length > 0
                        ? currentGroupCreation.selectedServers[0]
                        : 'Please select backend server'}
                        </button>
                        ${currentGroupCreation.userId && currentGroupCreation.showingServers ? allServers.filter(s => !assignedServers.has(s.name) || selectedServerNames.includes(s.name)).map(server => {
                            const isSelected = selectedServerNames.includes(server.name);
                            return `<button class="group-select-btn ${isSelected ? 'selected' : ''}" 
                                    onclick="toggleServerForGroup('${server.name}')">
                                    ${server.name}
                                </button>`;
                        }).join('') : ''}
                    </div>
                    ${currentGroupCreation.userId && selectedServerNames.length > 0 ? `
                    <div class="group-servers-display">
                        ${selectedServerNames.map(serverName => {
                            const server = allServers.find(s => s.name === serverName);
                            return server ? `
                                <div class="server-tag private">
                                    <div>${server.name}</div>
                                    <div class="server-tag-label">独享私有服务器</div>
                                </div>
                            ` : '';
                        }).join('')}
                        ${unselectedServers.length > 0 ? '<div style="width: 100%; height: 10px;"></div>' : ''}
                        ${unselectedServers.map(server => `
                            <div class="server-tag public">
                                <div>${server.name}</div>
                                <div class="server-tag-label">公共共享服务器</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="group-creation-row">
                        <button class="admin-manage-footer-btn reset" onclick="resetGroupCreation()">重置</button>
                        <button class="admin-manage-footer-btn manage" onclick="confirmGroupCreation()">管理</button>
                    </div>
                    ` : currentGroupCreation.userId && selectedServerNames.length === 0 ? `
                    <div class="group-creation-row">
                        <button class="admin-manage-footer-btn reset" onclick="resetGroupCreation()">重置</button>
                        <button class="admin-manage-footer-btn confirm" onclick="confirmGroupCreation()">确定</button>
                    </div>
                    ` : ''}
                `;
                groupsContainer.appendChild(createArea);
            }

            managerUserGroups.forEach(group => {
                const section = document.createElement('div');
                section.className = 'user-group-section';

                const isEditing = currentGroupCreation && currentGroupCreation.userId === group.userId;

                // 获取所有服务器（已选中的和未选中的）
                const privateServers = group.servers;
                const publicServers = allServers.filter(s => !privateServers.includes(s.name) && !assignedServers.has(s.name));

                section.innerHTML = `
                    <div class="user-group-header">
                        <div class="user-group-name">用户: ${group.userId}</div>
                        <div class="user-group-actions">
                            ${isEditing ? '' : `<button class="admin-account-action-btn manage" onclick="manageUserGroup('${group.userId}')">管理</button>`}
                            <button class="admin-account-action-btn delete" onclick="deleteUserGroup('${group.userId}')">重置</button>
                        </div>
                    </div>
                    <div class="user-group-servers">
                        ${privateServers.map(server => `
                            <div class="server-tag private">
                                <div>${server}</div>
                                <div class="server-tag-label">独享私有服务器</div>
                            </div>
                        `).join('')}
                        ${publicServers.length > 0 ? '<div style="width: 100%; height: 10px;"></div>' : ''}
                        ${publicServers.map(server => `
                            <div class="server-tag public">
                                <div>${server.name}</div>
                                <div class="server-tag-label">公共共享服务器</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                groupsContainer.appendChild(section);
            });
            }, 50); // 50ms防抖
        }

        // 修改管理员登录逻辑
        const originalHandleAdminLogin = handleAdminLogin;
        handleAdminLogin = async function () {
            const username = document.getElementById('adminLoginUsername').value.trim();
            const password = document.getElementById('adminLoginPassword').value.trim();

            if (!username || !password) {
                showMessage('请输入管理员用户名和密码', 'error');
                return;
            }

            // 检查是否是服务器管理设置的管理员
            const account = adminAccounts.find(a => a.id === username && a.password === password);
            if (account) {
                showMessage('管理员登录成功！正在跳转...', 'success');
                setTimeout(() => {
                    loginAsManager(username);
                }, 1000);
            } else {
                // 普通管理员登录：通过API验证
                async function doAdminLogin() {
                    try {
                        if (typeof showMessage === 'function') {
                            showMessage('正在验证管理员身份...', 'info');
                        }
                        
                        const response = await fetch(`${API_BASE_URL}/admin/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                username: username,
                                password: password
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            localStorage.setItem('admin_id', data.admin_id || username);
                            localStorage.setItem('admin_token', data.token);
                            localStorage.setItem('admin_username', username);
                            
                            showMessage('管理员登录成功！正在跳转...', 'success');
                            setTimeout(() => {
                                // 如果API返回了管理员权限，进入管理员面板
                                if (data.has_manager_access) {
                                    loginAsManager(username);
                                } else {
                                    if (typeof showMessage === 'function') {
                                        showMessage('您没有管理员面板访问权限', 'error');
                                    }
                                }
                            }, 1000);
                        } else {
                            const errorMsg = data.message || '管理员登录失败，请检查用户名和密码';
                            if (typeof showMessage === 'function') {
                                showMessage(errorMsg, 'error');
                            } else {
                                alert(errorMsg);
                            }
                        }
                    } catch (error) {
                        console.error('管理员登录错误:', error);
                        const errorMsg = '管理员登录失败：无法连接到服务器，请检查网络连接或联系管理员';
                        if (typeof showMessage === 'function') {
                            showMessage(errorMsg, 'error');
                        } else {
                            alert(errorMsg);
                        }
                        return; // 重要：登录失败时直接返回，不继续执行
                    }
                }
                
                // 执行管理员登录
                await doAdminLogin();
            }
        };

        // 保存原始函数
        window.handleAdminLogin = handleAdminLogin;



        // 全局变量
        let isSending = false;
        let currentChatId = null;
        let unreadChatIds = new Set();
        let newMessageNotification = null;
        let clearedChatIds = new Set(); // 记录已清空的对话ID
        let globalStats = {
            taskCount: 0,  // 发送任务的运行次数
            totalSent: 0,  // A版发送的消息总条数
            totalSuccess: 0,  // A版发送成功的消息条数
            totalFail: 0,  // A版发送失败的消息条数
            totalTime: 0,  // 累计用时（秒）
            totalPhoneCount: 0,  // 发送过的唯一号码总数（A版+C版，去重）
            inboxReceived: 0,  // 收件箱接收的消息数
            inboxSent: 0,       // 收件箱发送的消息数
            inboxTotal: 0       // 收件箱总数（接收+发送）
        };
        let sentPhoneNumbers = new Set();
        const MAX_LOG_ITEMS = 200;
        let logScrollPending = false;
        let conversationScrollPending = false;

        // 用户系统相关
        let currentUserId = null;
        let authToken = null;

        function updateUserInfoDisplay(credits) {
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            const currentUsernameEl = document.getElementById('currentUsername');
            const currentCreditsEl = document.getElementById('currentCredits');

            if (userInfoDisplay && currentUsernameEl && currentCreditsEl) {
                const userInfo = JSON.parse(localStorage.getItem('user_info_' + currentUserId) || '{}');
                currentUsernameEl.textContent = userInfo.username || currentUserId;
                currentCreditsEl.textContent = credits !== undefined ? credits : '-';
                userInfoDisplay.style.display = 'inline-block';
            }
        }

        // 加载用户后端服务器列表
        async function loadUserBackends() {
            if (!currentUserId || !authToken) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/user/${currentUserId}/backends`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const backends = data.backend_servers || [];
供前端使用
                    localStorage.setItem('user_backends', JSON.stringify(backends));
                    return backends;
                }
            } catch (error) {
                console.error('加载后端服务器列表失败:', error);
            }
            return [];
        }

        // 用户认证相关函数

        // 检查登录状态
        function checkAuth() {
            currentUserId = localStorage.getItem('user_id');
            authToken = localStorage.getItem('auth_token');
            if (!currentUserId || !authToken) {
                // 不自动跳转，只返回false，让调用者决定是否跳转
                // 这样可以避免主面板在初始化时被意外隐藏
                return false;
            }
            return true;
        }

        // 字符计数功能
        function getStringLength(str) {
            let length = 0;
            for (let i = 0; i < str.length; i++) {
                const charCode = str.charCodeAt(i);
                if (charCode >= 0x4E00 && charCode <= 0x9FFF) {
                    length += 2;
                } else {
                    length += 1;
                }
            }
            return length;
        }

        function updateCounts() {
            const numbersText = document.getElementById('numbersText').value;
            const numbers = numbersText.split(/[\n,]/).filter(n => n.trim()).length;
            const numbersCountEl = document.getElementById('numbersCount');

            // 号码计数器：0时黑色，大于0时绿色
            if (numbers === 0) {
                numbersCountEl.textContent = `号码: ${numbers}`;
                numbersCountEl.classList.remove('has-numbers');
            } else {
                numbersCountEl.textContent = `号码: ${numbers}`;
                numbersCountEl.classList.add('has-numbers');
            }

            const messageText = document.getElementById('messageText').value;
            const charCount = getStringLength(messageText);
            const messageCountEl = document.getElementById('messageCount');

            // 消息计数器：0时黑色，大于0且<=160时绿色，超过160时红色并显示条数
            if (charCount === 0) {
                messageCountEl.textContent = `字数: ${charCount}`;
                messageCountEl.classList.remove('has-content', 'over-limit');
            } else if (charCount <= 160) {
                messageCountEl.textContent = `字数: ${charCount}`;
                messageCountEl.classList.remove('over-limit');
                messageCountEl.classList.add('has-content');
            } else {
                const messageCount = Math.ceil(charCount / 160);
                messageCountEl.innerHTML = `字数: ${charCount}/160 <span class="message-count-badge">${messageCount}条</span>`;
                messageCountEl.classList.remove('has-content');
                messageCountEl.classList.add('over-limit');
            }
        }

        // 文件导入功能
        function importNumbers() {
            document.getElementById('numbersFile').click();
        }

        function importMessage() {
            document.getElementById('messageFile').click();
        }

        function clearNumbers() {
            const btn = document.getElementById('clearNumbersBtn');
            document.getElementById('numbersText').value = '';
            updateCounts();
            // 修复移动端点击后高亮不消失的问题 - 强制移除焦点和样式
            if (btn) {
                btn.blur();
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.transform = '';
                btn.style.boxShadow = '';
                setTimeout(() => {
                    btn.blur();
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }, 100);
            }
        }

        function clearMessage() {
            const btn = document.getElementById('clearMessageBtn');
            document.getElementById('messageText').value = '';
            updateCounts();
            // 修复移动端点击后高亮不消失的问题 - 强制移除焦点和样式
            if (btn) {
                btn.blur();
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.transform = '';
                btn.style.boxShadow = '';
                setTimeout(() => {
                    btn.blur();
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }, 100);
            }
        }

        // 文件读取处理
        document.getElementById('numbersFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // 读取文件内容
                    const content = e.target.result;
                    // 按换行和逗号分隔，过滤空行，整理成每行一个
                    const numbers = content.split(/[\n,]/)
                        .map(n => n.trim())
                        .filter(n => n.length > 0);
                    // 整理成每行一个的格式
                    document.getElementById('numbersText').value = numbers.join('\n');
                    updateCounts();
                };
                reader.readAsText(file);
            }
            this.value = '';
        });

        document.getElementById('messageFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('messageText').value = e.target.result;
                    updateCounts();
                };
                reader.readAsText(file);
            }
            this.value = '';
        });

        // 更新连接状态
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;

            if (connected) {
                statusEl.innerHTML = '<span style="color: white; font-weight: bold;">●</span> 已连接';
                statusEl.className = 'connection-status status-connected';
            } else {
                statusEl.innerHTML = '<span style="color: white; font-weight: bold;">●</span> 未连接';
                statusEl.className = 'connection-status status-disconnected';
            }
        }

        // 连接到用户可用的所有服务器（API模式）
        let isConnectingServers = false; // 防止重复调用
        async function connectToAvailableServers() {
            if (!checkAuth()) return;
            
            // 防止重复调用
            if (isConnectingServers) {
                return;
            }
            isConnectingServers = true;

            try {
                // 修复：不在这里调用 loadAvailableServersForUser()，避免无限循环
                // 直接使用已有的 availableServersForUser 数据
                // await loadAvailableServersForUser();

                // 检查是否有已连接的服务器
                const hasConnectedServers = serverData.connected && serverData.connected.length > 0;
                const hasAvailableServers = availableServersForUser && availableServersForUser.length > 0;

                if (!hasConnectedServers && !hasAvailableServers) {
                    updateConnectionStatus(false);
                    // 修复：只在第一次显示错误，避免重复通知
                    // showNotification('没有可用的服务器，无法发送消息', 'error');
                    console.warn('没有可用的服务器');
                    return;
                }

                // API模式：更新连接状态
                updateConnectionStatus(true);
                const serverCount = hasConnectedServers ? serverData.connected.length : availableServersForUser.length;
                // 修复：只在服务器数量变化时显示通知，避免重复通知
                // showNotification(`已加载 ${serverCount} 个可用服务器`, 'success');
                console.log('可用服务器数量:', serverCount);
            } finally {
                isConnectingServers = false;
            }
        }

        //#endregion
        //#region API消息处理模块
        // ==================== API消息处理 ====================
        function handleServerMessage(data, serverId = null) {
            if (!data || typeof data !== 'object') return;

            if (data.type === 'status_update') {
                if (data.message === "TASK_COMPLETED") {
                    isSending = false;
                    updateButtonState();
                    return;
                }
                addStatusMessage(data.message, data.message_type || 'info');

                if (data.message && typeof data.message === 'string') {
                    const timeMatch = data.message.match(/发送完成\s+用时:\s*(\d+)秒/i);
                    if (timeMatch) {
                        const timeUsed = parseInt(timeMatch[1]) || 0;
                        if (timeUsed > 0) {
                            globalStats.totalTime += timeUsed;
                            updateTimeDisplay();
                        }
                    }

                    const statsMatch = data.message.match(/Total:\s*(\d+)\s+numbers:\s*(\d+)\s+Success:\s*(\d+)\s+Failed:\s*(\d+)/i);
                    if (statsMatch) {
                        const totalMessages = parseInt(statsMatch[1]) || 0;
                        const phoneCount = parseInt(statsMatch[2]) || 0;
                        const success = parseInt(statsMatch[3]) || 0;
                        const fail = parseInt(statsMatch[4]) || 0;
                        const messageCount = phoneCount > 0 ? Math.floor(totalMessages / phoneCount) : 1;
                        const successMessages = success * messageCount;
                        const failMessages = fail * messageCount;
                        if (phoneCount > 0 || success > 0 || fail > 0) {
                            updateGlobalStats(totalMessages, successMessages, failMessages);
                        }
                    } else {
                        const successMatch = data.message.match(/Success[：:]\s*(\d+)/i);
                        const failMatch = data.message.match(/Failed[：:]\s*(\d+)/i);
                        const totalMatch = data.message.match(/Total[：:]\s*(\d+)/i);

                        if (successMatch || failMatch || totalMatch) {
                            const success = successMatch ? parseInt(successMatch[1]) : 0;
                            const fail = failMatch ? parseInt(failMatch[1]) : 0;
                            const total = totalMatch ? parseInt(totalMatch[1]) : (success + fail);
                            if (total > 0 || success > 0 || fail > 0) {
                                updateGlobalStats(total, success, fail);
                            }
                        }
                    }
                }
            } else if (data.type === 'connected') {
            } else if (data.type === 'initial_chats') {
                updateContactList(data.data);
            } else if (data.type === 'new_messages') {
                if (data.data.count > 0) {
                    showNotification(`收到 ${data.data.count} 条新消息！`, 'info');
                }
                updateContactList(data.data.chat_list, data.data.updated_chats);
                if (data.data && data.data.updated_chats && data.data.updated_chats.length > 0) {
                    const updatedChatId = data.data.updated_chats[0];
                    const chat = data.data.chat_list.find(c => c.chat_id === updatedChatId);
                    if (chat && (!currentChatId || currentChatId !== updatedChatId) && data.data.count > 0) {
                        showNewMessageNotification(updatedChatId, chat.name, chat.last_message_preview);
                    }
                }
                if (currentChatId && data.data.updated_chats && data.data.updated_chats.includes(currentChatId)) {
                    const conversationDisplay = document.getElementById('conversationDisplay');
                    const tempMessage = conversationDisplay.querySelector('[data-temp-message="true"]');
                    if (!tempMessage) {
                        requestConversation(currentChatId);
                    }
                }
            } else if (data.type === 'conversation_data') {
                // 如果是当前对话，且已有临时消息（刚发送的），完全忽略这次更新
                const conversationDisplay = document.getElementById('conversationDisplay');
                const tempMessage = conversationDisplay.querySelector('[data-temp-message="true"]');
                if (tempMessage && data.chat_id === currentChatId) {
                    if (data.data && data.data.messages && data.data.messages.length > 0) {
                        const lastMsg = data.data.messages[data.data.messages.length - 1];
                        const tempMsgText = tempMessage.querySelector('span').textContent.trim();
                        const lastMsgText = (lastMsg.text || '').trim();
                        if (lastMsg.is_from_me && lastMsgText === tempMsgText) {
                            tempMessage.removeAttribute('data-temp-message');
                            let received = 0;
                            let sent = 0;
                            data.data.messages.forEach(msg => {
                                if (msg.is_from_me) {
                                    sent++;
                                } else {
                                    received++;
                                }
                            });
                            inboxMessageStats[data.chat_id] = { received: received, sent: sent };
                            updateInboxStats();
                            return; // 直接返回，不继续处理
                        }
                    }
                    // 如果检测到临时消息，即使内容不完全匹配，也移除标记（可能是格式差异）
                    tempMessage.removeAttribute('data-temp-message');
                    // 更新统计
                    if (data.data && data.data.messages) {
                        let received = 0;
                        let sent = 0;
                        data.data.messages.forEach(msg => {
                            if (msg.is_from_me) {
                                sent++;
                            } else {
                                received++;
                            }
                        });
                        inboxMessageStats[data.chat_id] = { received: received, sent: sent };
                        updateInboxStats();
                    }
                    return;
                }
                displayConversation(data.data, data.chat_id);
            } else if (data.status === "success" && data.message === "回复已发送") {
                document.getElementById('replyInput').value = '';
            } else if (data.status === "error" && data.message.includes("回复发送失败")) {
                // 静默处理错误
            }
        }

        function addStatusMessage(message, type = 'info') {
            const statusList = document.getElementById('statusList');
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });

            // 颜色定义（与统计栏一致）
            const colors = {
                total: '#9C27B0',      // 紫色 - 任务次数
                time: '#2196F3',       // 蓝色 - 用时
                success: '#4CAF50',    // 绿色 - 成功
                fail: '#FF8A80',       // 浅红色 - 失败
                rate: '#FF9800'        // 橙色 - 成功率
            };

            // 格式化消息，添加颜色高亮（只高亮数值，其他文本保持黑色）
            function formatMessage(msg) {
                let formatted = msg;
                formatted = `<span style="color: #000000;">${formatted}</span>`;
                formatted = formatted.replace(/Total:\s*(\d+)/gi,
                    `Total: <span style="color: ${colors.total}; font-weight: bold;">$1</span>`);
                formatted = formatted.replace(/Success:\s*(\d+)/gi,
                    `Success: <span style="color: ${colors.success}; font-weight: bold;">$1</span>`);
                formatted = formatted.replace(/Failed:\s*(\d+)/gi,
                    `Failed: <span style="color: ${colors.fail}; font-weight: bold;">$1</span>`);
                formatted = formatted.replace(/(成功率\s*)(\d+\/\d+\([^)]+\))/gi,
                    `$1<span style="color: ${colors.rate}; font-weight: bold;">$2</span>`);
                formatted = formatted.replace(/(用时:\s*)([\d:]+|[\d.]+[秒分时])/gi,
                    `$1<span style="color: ${colors.time}; font-weight: bold;">$2</span>`);
                return formatted;
            }

            if (message.includes('开始发送')) {
                // 解析开始发送消息：格式 "开始发送 Task120215 (From +13528162835 to 13528162835)"
                const startMatch = message.match(/开始发送\s+([^\s(]+)\s*\(From\s+([^)]+)\s+to\s+([^)]+)\)/);
                if (startMatch) {
                    const taskId = startMatch[1];
                    const fromPhone = startMatch[2];
                    const toPhone = startMatch[3];

                    const messageEl = document.createElement('div');
                    messageEl.className = 'log-item';
                    messageEl.innerHTML = `<span style="color: #000000; font-weight: bold;">[${timestamp}] > 开始发送 ${taskId} :</span><br><span style="color: #000000;"> (From ${fromPhone} to ${toPhone})</span><br>`;
                    statusList.appendChild(messageEl);
                } else {
                    // 如果没有匹配到格式，使用原始消息
                    const messageEl = document.createElement('div');
                    messageEl.className = 'log-item';
                    messageEl.innerHTML = `<span style="color: #000000; font-weight: bold;">[${timestamp}] > ${message}</span>`;
                    statusList.appendChild(messageEl);
                }
            }
            // 2. 处理"发送完成"消息
            else if (message.includes('发送完成')) {
                const messageEl = document.createElement('div');
                messageEl.className = 'log-item';
                let formattedMsg = message;
                // 格式化用时部分
                formattedMsg = formattedMsg.replace(/(用时:\s*)([\d.]+秒)/g,
                    `$1<span style="color: ${colors.time}; font-weight: bold;">$2</span>`);
                formattedMsg = formattedMsg.replace(/发送完成\s+/, '发送完成    ');
                messageEl.innerHTML = `<span style="color: #000000;">[${timestamp}] > ${formattedMsg}</span><br>`;
                statusList.appendChild(messageEl);
            }
            else if (message.includes('Total:') && message.includes('Success:')) {
                const failPattern = /(\u274C\s*失败的消息:)/;
                const hasFailures = failPattern.test(message);

                let resultPart = message;
                let failPart = '';

                if (hasFailures) {
                    const failMatch = message.match(failPattern);
                    if (failMatch) {
                        const failIndex = failMatch.index;
                        resultPart = message.substring(0, failIndex).trim();
                        failPart = message.substring(failIndex).trim();
                    }
                }

                // 处理统计结果部分
                let statsMsg = resultPart.trim();
                statsMsg = statsMsg.replace(/\s+成功率\s+/, '   成功率 ');

                const messageEl = document.createElement('div');
                messageEl.className = 'log-item';
                messageEl.innerHTML = `<span style="color: #000000;">[${timestamp}] > ${formatMessage(statsMsg)}</span>`;
                statusList.appendChild(messageEl);

                // 如果有失败消息，单独处理
                if (failPart) {
                    // 添加空行
                    const emptyEl = document.createElement('div');
                    emptyEl.className = 'log-item';
                    emptyEl.style.height = '8px';
                    statusList.appendChild(emptyEl);

                    // 失败消息标题
                    const failTitleEl = document.createElement('div');
                    failTitleEl.className = 'log-item';
                    failTitleEl.innerHTML = '<span style="color: #000000; font-weight: bold;">&#10060; 失败的消息:</span>';
                    statusList.appendChild(failTitleEl);

                    // 解析失败项 - 处理各种换行格式
                    let failText = failPart;
                    // 移除开头的失败消息标记
                    if (failText.indexOf('失败的消息:') >= 0) {
                        failText = failText.substring(failText.indexOf('失败的消息:') + '失败的消息:'.length).trim();
                    }
                    // 处理可能的不同换行符格式（\n, \r\n, 等）
                    failText = failText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                    const failLines = failText.split('\n')
                        .map(line => line.trim())
                        .filter(line => line && /^\[\d+\]/.test(line)); // 匹配以 [数字] 开头的行

                    failLines.forEach(line => {
                        const failItemEl = document.createElement('div');
                        failItemEl.className = 'log-item';
                        // 提取号码和错误码
                        // 格式：[3] +13128631480 - 发送失败 (错误码: 1)
                        // 或：[7] +13128631480 - 未找到记录 (号码或时间不匹配)
                        const phoneMatch = line.match(/^\[(\d+)\]\s*(.+?)\s*-\s*(.+)$/);
                        if (phoneMatch) {
                            const index = phoneMatch[1];
                            const phone = phoneMatch[2];
                            const originalStatus = phoneMatch[3];

                            // 提取错误码（如果有）
                            const errorCodeMatch = originalStatus.match(/\(错误码:\s*(\d+)\)/);
                            let displayText;
                            if (errorCodeMatch) {
                                displayText = ' 此号码不支持IMessage';
                            } else {
                                displayText = ' 此号码不支持IMessage';
                            }
                            failItemEl.innerHTML = `<span style="color: #000000;">[${index}] ${phone} -${displayText}</span>`;
                        } else {
                            // 如果格式不匹配，保持原样但替换状态为"此号码不支持IMessage"
                            const simpleMatch = line.match(/^\[(\d+)\]\s*(.+?)\s*-/);
                            if (simpleMatch) {
                                failItemEl.innerHTML = `<span style="color: #000000;">[${simpleMatch[1]}] ${simpleMatch[2]} - 此号码不支持IMessage</span>`;
                            } else {
                                failItemEl.innerHTML = `<span style="color: #000000;">${line.replace(/-\s*[^-]+$/, ' - 此号码不支持IMessage')}</span>`;
                            }
                        }
                        statusList.appendChild(failItemEl);
                    });
                }
            }
            // 4. 处理其他普通消息
            else {
                const messageEl = document.createElement('div');
                messageEl.className = 'log-item';
                messageEl.innerHTML = `<span style="color: #000000;">[${timestamp}] > ${message}</span>`;
                statusList.appendChild(messageEl);
            }

            // 限制日志条目数量
            const logItems = statusList.querySelectorAll('.log-item');
            if (logItems.length > MAX_LOG_ITEMS) {
                for (let i = 0; i < logItems.length - MAX_LOG_ITEMS; i++) {
                    logItems[i].remove();
                }
            }

            const statusListMobile = document.getElementById('statusListMobile');
            if (statusListMobile) {
                statusListMobile.innerHTML = statusList.innerHTML;
                // 限制移动端日志条目数量
                const mobileLogItems = statusListMobile.querySelectorAll('.log-item');
                if (mobileLogItems.length > MAX_LOG_ITEMS) {
                    for (let i = 0; i < mobileLogItems.length - MAX_LOG_ITEMS; i++) {
                        mobileLogItems[i].remove();
                    }
                }
                statusListMobile.scrollTop = statusListMobile.scrollHeight;
            }

            if (!logScrollPending) {
                logScrollPending = true;
                requestAnimationFrame(() => {
                    statusList.scrollTop = statusList.scrollHeight;
                    logScrollPending = false;
                });
            }
        }

        //#endregion
        //#region 发送功能模块（API模式 - 发送命令）
        // 通过API发送命令
        async function sendCommand(action, data = {}) {
            if (!currentUserId) {
                console.error('未登录，无法发送命令');
                return false;
            }
            
            try {
                const authToken = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        action: action,
                        data: data
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success || false;
                }
                return false;
            } catch (error) {
                console.error('发送命令失败:', error);
                return false;
            }
        }
        
        // 通过API发送命令到指定服务器
        async function sendCommandToServers(action, data = {}, serverIds = null) {
            if (!currentUserId) {
                console.error('未登录，无法发送命令');
                return false;
            }
            
            try {
                const authToken = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        action: action,
                        data: data,
                        server_ids: serverIds
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success || false;
                }
                return false;
            } catch (error) {
                console.error('发送命令失败:', error);
                return false;
            }
        }

        //#endregion
        //#region 发送任务处理
        // --- 替换 startSending() ---
        async function startSending() {
            if (!currentUserId) {
                alert("请先登录");
                return;
            }
            
            // 检查是否有正在进行的任务（防止重复点击）
            if (isSending) {
                alert("已有任务正在执行，请等待当前任务完成");
                return;
            }
            
            // 检查是否有可用的服务器
            // 修正：只要有connected或available的服务器即可
            // 如果是在本地开发环境，或者没有正确加载服务器列表，尝试跳过检查
            // 只有当明确知道没有服务器时才拦截
            /*
            const hasConnectedServers = serverData.connected && serverData.connected.length > 0;
            const hasAvailableServers = serverData.available && serverData.available.length > 0;
            if (!hasConnectedServers && !hasAvailableServers) {
                // 再尝试加载一次，也许是刚上线
                try {
                    await loadServersFromAPI();
                    const retryConnected = serverData.connected && serverData.connected.length > 0;
                    const retryAvailable = serverData.available && serverData.available.length > 0;
                    if (!retryConnected && !retryAvailable) {
                        alert("没有可用的服务器，无法发送消息。请等待服务器上线或联系管理员。");
                        return;
                    }
                } catch (e) {
                    console.warn("发送前检查服务器失败:", e);
                    // 继续尝试发送，也许服务器已经在后台连接了
                }
            }
            */
            
            // 立即锁定发送按钮
            isSending = true;
            updateButtonState();
            
            const numbersText = document.getElementById('numbersText').value || "";
            const message = document.getElementById('messageText').value || "";
            const interval = parseFloat(document.getElementById('intervalInput').value) || 1.0;
            if (!numbersText.trim() || !message.trim()) {
                isSending = false;
                updateButtonState();
                alert("号码或内容为空");
                return;
            }
            // parse numbers into array (支持逗号/换行)
            let phones = [];
            if (numbersText) {
                // 先统一替换换行符为逗号，然后按逗号分割
                const rawPhones = numbersText.replace(/\r?\n/g, ',').split(',');
                rawPhones.forEach(p => {
                    const n = p.trim();
                    if (n) phones.push(n);
                });
            }
            
            if (phones.length === 0) {
                isSending = false;
                updateButtonState();
                alert("未识别到有效号码");
                return;
            }

            try {
                // 1) create task
                const authToken = localStorage.getItem('auth_token');
                const createResp = await fetch(`${API_BASE_URL}/task/create`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        message: message,
                        numbers: phones,
                        count: 1,
                        token: authToken
                    })
                });
                const createData = await createResp.json();
                if (!createData || !createData.ok) {
                    isSending = false;
                    updateButtonState();
                    alert("创建任务失败: " + (createData && createData.msg ? createData.msg : "未知"));
                    return;
                }
                const taskId = createData.task_id;

                // 2) assign shards
                const assignResp = await fetch(`${API_BASE_URL}/task/assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId })
                });
                const assignData = await assignResp.json();
                if (!assignData || !assignData.ok) {
                    // 分配失败，立即停止，不启动轮询
                    isSending = false;
                    updateButtonState();
                    const errorMsg = assignData && assignData.msg ? assignData.msg : "暂无可用服务器";
                    alert("分配任务失败: " + errorMsg);
                    
                    // 显示错误消息
                    if (typeof addStatusMessage === 'function') {
                        addStatusMessage(`任务 ${taskId} 分配失败: ${errorMsg}`);
                    } else {
                        showNotification(`任务 ${taskId} 分配失败: ${errorMsg}`, 'error');
                    }
                    return;
                }

                // 3) show success UI
                if (typeof addStatusMessage === 'function') {
                    addStatusMessage(`任务 ${taskId} 已创建并分配，正在等待后端执行`);
                } else {
                    showNotification(`任务 ${taskId} 已创建并分配，正在等待后端执行`, 'success');
                }
                // 按钮已经锁定，不需要再次设置
                
                // 启动任务状态轮询
                startTaskStatusPolling(taskId, phones.length);
            } catch (err) {
                isSending = false;
                updateButtonState();
                console.error("startSending error:", err);
                alert("发送失败: " + (err.message || "未知错误"));
            }
        }
        
        // 任务状态轮询（智能间隔）
        let taskPollingIntervals = new Map(); // {taskId: intervalId}
        
        // 停止所有任务轮询
        function stopAllTaskPolling() {
            taskPollingIntervals.forEach((intervalId, taskId) => {
                clearInterval(intervalId);
            });
            taskPollingIntervals.clear();
            isSending = false;
            updateButtonState();
        }
        
        function calculatePollingInterval(totalTasks, backendCount = 10) {
            const tasksPerCycle = 100;
            const timePerCycle = 10;
            const x = totalTasks / tasksPerCycle;
            const y = backendCount;
            const z = x / y;
            let a = z;
            
            if (a > 30) {
                return { firstInterval: a * 1000, regularInterval: 10 * 1000 };
            } else {
                return { firstInterval: a * 1000, regularInterval: a * 1000 };
            }
        }
        
        async function startTaskStatusPolling(taskId, totalTasks) {
            // 停止之前的轮询（如果有）
            if (taskPollingIntervals.has(taskId)) {
                clearInterval(taskPollingIntervals.get(taskId));
            }
            
            const backendCount = 10;
            const intervals = calculatePollingInterval(totalTasks, backendCount);
            let isFirstPoll = true;
            let pollCount = 0;
            const maxPollCount = 60; // 最大轮询次数：60次（安全网，正常情况下不会用到）
            const startTime = Date.now();
            const maxDuration = 2 * 60 * 1000; // 最大持续时间：2分钟（安全网）
            let lastProgress = { done: 0, success: 0, fail: 0 }; // 记录上次进度
            let noProgressCount = 0; // 无进展计数
            
            // 停止轮询并解锁按钮的辅助函数
            const stopPolling = (reason, isError = false) => {
                const intervalId = taskPollingIntervals.get(taskId);
                if (intervalId) {
                    clearInterval(intervalId);
                    taskPollingIntervals.delete(taskId);
                }
                
                isSending = false;
                updateButtonState();
                
                const message = isError 
                    ? `任务 ${taskId} 已停止: ${reason}`
                    : `任务 ${taskId} ${reason}`;
                
                if (typeof addStatusMessage === 'function') {
                    addStatusMessage(message);
                } else {
                    showNotification(message, isError ? 'error' : 'info');
                }
            };
            
            const poll = async () => {
                // 安全检查：防止无限轮询（正常情况下不会触发）
                const elapsed = Date.now() - startTime;
                if (elapsed > maxDuration) {
                    stopPolling('超时停止（超过2分钟）', true);
                    return;
                }
                
                pollCount++;
                if (pollCount > maxPollCount) {
                    stopPolling('达到最大轮询次数，已停止', true);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/task/${taskId}/status`);
                    
                    if (!response.ok) {
                        // API 请求失败，停止轮询
                        stopPolling(`API请求失败: ${response.status} ${response.statusText}`, true);
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.ok) {
                        const status = data.status;
                        const result = data.result || {};
                        const shards = data.shards || {};
                        const success = result.success || 0;
                        const fail = result.fail || 0;
                        const done = shards.done || 0;
                        const total = shards.total || totalTasks;
                        
                        // ========== 人类逻辑：一次任务，发送完就结束，无论成功失败 ==========
                        
                        // 1. 如果状态是 done，任务完成，立即停止
                        if (status === 'done') {
                            stopPolling(`任务完成！成功: ${success}, 失败: ${fail}`, false);
                            globalStats.totalSuccess += success;
                            globalStats.totalFail += fail;
                            updateInlineStats();
                            return;
                        }
                        
                        // 2. 如果状态是 failed/error/cancelled，任务失败，立即停止
                        if (status === 'failed' || status === 'error' || status === 'cancelled') {
                            stopPolling(`任务失败: ${data.message || status}`, true);
                            return;
                        }
                        
                        // 3. 核心逻辑：如果成功+失败的数量 >= 总数，说明任务全部完成，立即停止
                        // 无论成功还是失败，只要全部发送完就结束
                        if (totalTasks > 0 && (success + fail) >= totalTasks) {
                            stopPolling(`任务完成！成功: ${success}, 失败: ${fail}`, false);
                            globalStats.totalSuccess += success;
                            globalStats.totalFail += fail;
                            updateInlineStats();
                            return;
                        }
                        
                        // 4. 检测无进展：如果30秒内进度没有变化，停止（防止卡死）
                        const currentProgress = { done: done, success: success, fail: fail };
                        if (currentProgress.done === lastProgress.done && 
                            currentProgress.success === lastProgress.success && 
                            currentProgress.fail === lastProgress.fail) {
                            noProgressCount++;
                            // 如果连续10次（约30秒）无进展，停止
                            if (noProgressCount >= 10 && pollCount > 5) {
                                stopPolling('任务无进展，已停止', true);
                                return;
                            }
                        } else {
                            // 有进展，重置计数
                            noProgressCount = 0;
                            lastProgress = currentProgress;
                        }
                        
                        // 任务进行中，显示进度
                        if (status === 'pending' || status === 'running') {
                            const progress = total > 0 ? (done / total * 100).toFixed(1) : 0;
                            if (typeof addStatusMessage === 'function') {
                                addStatusMessage(`任务 ${taskId} 进行中... 完成: ${done}/${total} (${progress}%) 成功: ${success} 失败: ${fail}`);
                            }
                        } else {
                            // 未知状态
                            console.warn(`未知任务状态: ${status}`);
                        }
                    } else {
                        // API 返回错误
                        stopPolling(`任务状态查询失败: ${data.message || '未知错误'}`, true);
                        return;
                    }
                } catch (err) {
                    // 网络错误或其他异常
                    console.error("轮询任务状态失败:", err);
                    // 连续错误超过5次才停止
                    if (pollCount > 5) {
                        stopPolling(`网络错误: ${err.message}`, true);
                        return;
                    }
                }
                
                // 第一次轮询后，改用regularInterval
                if (isFirstPoll) {
                    isFirstPoll = false;
                    clearInterval(taskPollingIntervals.get(taskId));
                    const intervalId = setInterval(poll, intervals.regularInterval);
                    taskPollingIntervals.set(taskId, intervalId);
                }
            };
            
            poll();
            const intervalId = setInterval(poll, intervals.firstInterval);
            taskPollingIntervals.set(taskId, intervalId);
        }

        function updateButtonState() {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = isSending;
            if (isSending) {
                sendBtn.textContent = '正在发送...';
            } else {
                sendBtn.textContent = '发送';
            }
        }

        //#endregion
        //#region 收件箱模块（C版面板 - 消息接收和回复）
        // 更新通知计数
        function updateNotificationCount() {
            const navInboxBtn = document.getElementById('navInboxBtn');
            let notificationCountEl = null;
            if (navInboxBtn) {
                notificationCountEl = navInboxBtn.querySelector('.notification-count');
            }

            const unreadCount = unreadChatIds.size;

            if (notificationCountEl) {
                if (unreadCount > 0) {
                    notificationCountEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    notificationCountEl.classList.add('has-unread');
                } else {
                    notificationCountEl.textContent = '0';
                    notificationCountEl.classList.remove('has-unread');
                }
            }

            updateInboxStats();
        }

        function resetInboxOnConnect() {
            const contactList = document.getElementById('contactList');
            if (contactList) {
                contactList.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">暂无对话</div>';
            }

            const conversationDisplay = document.getElementById('conversationDisplay');
            if (conversationDisplay) {
                conversationDisplay.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">选择一个对话开始聊天</div>';
            }

            currentChatId = null;
            unreadChatIds.clear();
            inboxMessageStats = {};
            updateNotificationCount();
            updateInboxStats();
            const replyInput = document.getElementById('replyInput');
            if (replyInput) {
                replyInput.disabled = true;
            }
            const sendReplyBtn = document.getElementById('sendReplyBtn');
            if (sendReplyBtn) {
                sendReplyBtn.disabled = true;
            }
        }

        let inboxMessageStats = {};

        function updateInboxStats() {
            let totalReceived = 0;
            let totalSent = 0;
            Object.values(inboxMessageStats).forEach(stats => {
                totalReceived += stats.received || 0;
                totalSent += stats.sent || 0;
            });
            const total = totalReceived + totalSent;

            // 更新显示（C版收件箱统计）
            const inboxStatsEl = document.getElementById('inboxStats');
            if (inboxStatsEl) {
                inboxStatsEl.textContent = `接收: ${totalReceived}  发送: ${totalSent}  总数: ${total}`;
            }

            globalStats.inboxReceived = totalReceived;
            globalStats.inboxSent = totalSent;
            globalStats.inboxTotal = total;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;
            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;

            globalStats.totalPhoneCount = sentPhoneNumbers.size;

            document.getElementById('taskCount').textContent = globalStats.taskCount;
            document.getElementById('phoneCount').textContent = globalStats.totalPhoneCount;
            document.getElementById('totalSentCount').textContent = totalCount;
            document.getElementById('successCount').textContent = globalStats.totalSuccess;
            document.getElementById('failCount').textContent = globalStats.totalFail;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;

            const taskCountMobile = document.getElementById('taskCountMobile');
            const phoneCountMobile = document.getElementById('phoneCountMobile');
            const totalSentCountMobile = document.getElementById('totalSentCountMobile');
            const successCountMobile = document.getElementById('successCountMobile');
            const failCountMobile = document.getElementById('failCountMobile');
            const successRateMobile = document.getElementById('successRateMobile');
            if (taskCountMobile) taskCountMobile.textContent = globalStats.taskCount;
            if (phoneCountMobile) phoneCountMobile.textContent = globalStats.totalPhoneCount;
            if (totalSentCountMobile) totalSentCountMobile.textContent = totalCount;
            if (successCountMobile) successCountMobile.textContent = globalStats.totalSuccess;
            if (failCountMobile) failCountMobile.textContent = globalStats.totalFail;
            if (successRateMobile) successRateMobile.textContent = `${successRate.toFixed(1)}%`;

            updateInlineStats();
        }

        function updateContactList(chats, updatedChatIds = []) {
            const contactList = document.getElementById('contactList');

            if (!chats || chats.length === 0) {
                contactList.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">暂无对话</div><button class="btn-clear-inbox" id="clearInboxBtn" title="全部删除">全部删除</button>';
                updateNotificationCount();
                updateInboxStats();
                document.getElementById('clearInboxBtn').addEventListener('click', clearInbox);
                return;
            }

            updatedChatIds.forEach(chatId => {
                if (chatId !== currentChatId) {
                    unreadChatIds.add(chatId);
                }
            });

            updateNotificationCount(); // 更新通知计数

            const fragment = document.createDocumentFragment();

            chats.forEach(chat => {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                if (chat.chat_id === currentChatId) {
                    contactItem.classList.add('active');
                }
                if (unreadChatIds.has(chat.chat_id) && chat.chat_id !== currentChatId) {
                    contactItem.classList.add('unread');
                }
                contactItem.dataset.chatId = chat.chat_id;
                contactItem.innerHTML = `
                    <div class="avatar">😎</div>
                    <div class="contact-info">
                        <div class="contact-name">${chat.name}</div>
                        <div class="contact-preview">${chat.last_message_preview || ''}</div>
                    </div>
                `;
                contactItem.addEventListener('click', function () {
                    selectChat(chat.chat_id, chat.name);
                });
                fragment.appendChild(contactItem);
            });

            contactList.innerHTML = '';
            contactList.appendChild(fragment);
            const clearBtn = document.createElement('button');
            clearBtn.className = 'btn-clear-inbox';
            clearBtn.id = 'clearInboxBtn';
            clearBtn.title = '全部删除';
            clearBtn.textContent = '全部删除';
            clearBtn.addEventListener('click', clearInbox);
            contactList.appendChild(clearBtn);

            chats.forEach(chat => {
                if (!inboxMessageStats[chat.chat_id]) {
                    requestConversationForStats(chat.chat_id);
                }
            });

            updateInboxStats();
        }

        // 请求对话数据用于统计
        async function requestConversationForStats(chatId) {
            if (!currentUserId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/${currentUserId}/conversations/${chatId}/messages`);
                const data = await response.json();
                
                if (data.success && data.messages) {
                    handleServerMessage({
                        type: 'conversation_data',
                        chat_id: chatId,
                        data: { messages: data.messages }
                    });
                }
            } catch (err) {
                console.error("获取对话数据失败:", err);
            }
        }

        function selectChat(chatId, chatName) {
            if (currentChatId === chatId) return;
            currentChatId = chatId;
            unreadChatIds.delete(chatId);
            updateNotificationCount();
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active', 'unread');
                if (item.dataset.chatId === chatId) {
                    item.classList.add('active');
                }
            });
            const chatHeader = document.getElementById('chatHeader');
            const chatPhoneNumber = document.getElementById('chatPhoneNumber');
            if (chatPhoneNumber) {
                const phoneNumber = chatName || chatId;
                chatPhoneNumber.textContent = phoneNumber;
            }
            document.getElementById('replyInput').disabled = false;
            document.getElementById('sendReplyBtn').disabled = false;
            requestConversation(chatId);
        }

        async function requestConversation(chatId) {
            if (!currentUserId) return;
            
            const conversationDisplay = document.getElementById('conversationDisplay');
            if (conversationDisplay) {
                conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">加载中...</div>';
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/${currentUserId}/conversations/${chatId}/messages`);
                const data = await response.json();
                
                if (data.success && data.messages) {
                    handleServerMessage({
                        type: 'conversation_data',
                        chat_id: chatId,
                        data: { messages: data.messages }
                    });
                } else {
                    if (conversationDisplay) {
                        conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">加载失败</div>';
                    }
                }
            } catch (err) {
                console.error("获取对话失败:", err);
                if (conversationDisplay) {
                    conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">加载失败</div>';
                }
            }
        }

        function displayConversation(data, chatId) {
            const conversationDisplay = document.getElementById('conversationDisplay');

            let received = 0;
            let sent = 0;
            if (data && data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    if (msg.is_from_me) {
                        sent++;
                        // 记录C版发送过的号码（用于总号码统计）
                        if (chatId && !sentPhoneNumbers.has(chatId)) {
                            sentPhoneNumbers.add(chatId);
                            globalStats.totalPhoneCount = sentPhoneNumbers.size;
                        }
                    } else {
                        received++;
                    }
                });
            }
            inboxMessageStats[chatId] = { received: received, sent: sent };
            updateInboxStats(); // 更新统计

            if (!data || !data.messages || data.messages.length === 0) {
                conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">暂无消息</div>';
                return;
            }

            // 检查是否有临时消息（刚发送的），如果有且是当前对话，只移除标记
            const tempMessage = conversationDisplay.querySelector('[data-temp-message="true"]');
            if (tempMessage && chatId === currentChatId) {
                if (data.messages && data.messages.length > 0) {
                    const lastMsg = data.messages[data.messages.length - 1];
                    const tempMsgText = tempMessage.querySelector('span').textContent.trim();
                    const lastMsgText = (lastMsg.text || lastMsg.message || '').trim();
                    if (lastMsg.is_from_me && lastMsgText === tempMsgText) {
                        tempMessage.removeAttribute('data-temp-message');
                        return;
                    }
                }
                // 如果内容不匹配，也移除标记（可能是格式差异）
                tempMessage.removeAttribute('data-temp-message');
            }

            const fragment = document.createDocumentFragment();
            data.messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = msg.is_from_me ? 'chat-bubble right' : 'chat-bubble left';

                // 修复时间显示
                let timeStr = '';
                if (msg.timestamp) {
                    try {
                        // 尝试解析 ISO 格式的时间戳
                        const date = new Date(msg.timestamp);
                        if (!isNaN(date.getTime())) {
                            timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                        } else {
                            timeStr = msg.timestamp;
                        }
                    } catch (e) {
                        timeStr = msg.timestamp || '';
                    }
                }

                bubble.innerHTML = `
                    <span>${msg.text || msg.message || ''}</span>
                    <div class="chat-time">${timeStr}</div>
                `;
                fragment.appendChild(bubble);
            });

            conversationDisplay.innerHTML = '';
            conversationDisplay.appendChild(fragment);

            updateInboxStats();

            if (!conversationScrollPending) {
                conversationScrollPending = true;
                requestAnimationFrame(() => {
                    conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
                    conversationScrollPending = false;
                });
            }
        }

        function sendReply() {
            const replyInput = document.getElementById('replyInput');
            const message = replyInput.value.trim();
            if (!message || !currentChatId) return;

            const conversationDisplay = document.getElementById('conversationDisplay');
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble right';
            bubble.setAttribute('data-temp-message', 'true');
            bubble.innerHTML = `
                <span>${message}</span>
                <div class="chat-time">${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            conversationDisplay.appendChild(bubble);
            conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
            replyInput.value = '';

            if (currentChatId && !sentPhoneNumbers.has(currentChatId)) {
                sentPhoneNumbers.add(currentChatId);
                globalStats.totalPhoneCount = sentPhoneNumbers.size;
                updateInlineStats();
                const phoneCountEl = document.getElementById('phoneCount');
                if (phoneCountEl) phoneCountEl.textContent = globalStats.totalPhoneCount;
            }

            if (!inboxMessageStats[currentChatId]) {
                inboxMessageStats[currentChatId] = { received: 0, sent: 0 };
            }
            inboxMessageStats[currentChatId].sent++;
            updateInboxStats();

            // 通过API发送回复
            sendReplyViaAPI(currentChatId, message);
        }
        
        // 通过API发送回复
        async function sendReplyViaAPI(chatId, message) {
            if (!currentUserId) return;
            
            try {
                // 创建回复任务
                const authToken = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/task/create`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        message: message,
                        numbers: [chatId],
                        count: 1,
                        task_type: 'reply', // 标记为回复任务
                        token: authToken
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    // 分配任务
                    await fetch(`${API_BASE_URL}/task/assign`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task_id: data.task_id })
                    });
                }
            } catch (err) {
                console.error("发送回复失败:", err);
            }
        }

        // 显示通知消息
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showNewMessageNotification(chatId, senderName, messagePreview) {
            console.log('showNewMessageNotification called:', chatId, senderName);
            const oldBubble = document.querySelector('.message-bubble-notification');
            if (oldBubble) {
                oldBubble.remove();
            }

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble-notification';
            bubble.innerHTML = `📨 新消息: ${senderName}`;

            const clearBtn = document.getElementById('clearLogsBtn');
            if (clearBtn) {
                const rect = clearBtn.getBoundingClientRect();
                bubble.style.top = `${rect.top - 50}px`;
            } else {
                bubble.style.top = '50%';
            }

            document.body.appendChild(bubble);
            console.log('Bubble notification created and added to DOM');

            setTimeout(() => {
                if (bubble && bubble.parentNode) {
                    bubble.remove();
                }
            }, 3000);
        }

        function updateGlobalStats(total = 0, success = 0, fail = 0) {
            if (total > 0 || success > 0 || fail > 0) {
                globalStats.taskCount++;
            }
            globalStats.totalSent += total;
            globalStats.totalSuccess += success;
            globalStats.totalFail += fail;

            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;

            globalStats.totalPhoneCount = sentPhoneNumbers.size;

            document.getElementById('taskCount').textContent = globalStats.taskCount;
            document.getElementById('phoneCount').textContent = globalStats.totalPhoneCount;
            document.getElementById('totalSentCount').textContent = totalCount;
            document.getElementById('successCount').textContent = globalStats.totalSuccess;
            document.getElementById('failCount').textContent = globalStats.totalFail;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;

            const taskCountMobile = document.getElementById('taskCountMobile');
            const phoneCountMobile = document.getElementById('phoneCountMobile');
            const totalSentCountMobile = document.getElementById('totalSentCountMobile');
            const successCountMobile = document.getElementById('successCountMobile');
            const failCountMobile = document.getElementById('failCountMobile');
            const successRateMobile = document.getElementById('successRateMobile');
            if (taskCountMobile) taskCountMobile.textContent = globalStats.taskCount;
            if (phoneCountMobile) phoneCountMobile.textContent = globalStats.totalPhoneCount;
            if (totalSentCountMobile) totalSentCountMobile.textContent = totalCount;
            if (successCountMobile) successCountMobile.textContent = globalStats.totalSuccess;
            if (failCountMobile) failCountMobile.textContent = globalStats.totalFail;
            if (successRateMobile) successRateMobile.textContent = `${successRate.toFixed(1)}%`;

            updateInlineStats();
        }

        function updateTimeDisplay() {
            const timeUsedEl = document.getElementById('timeUsed');
            if (timeUsedEl) {
                const totalSeconds = globalStats.totalTime;
                if (totalSeconds < 60) {
                    timeUsedEl.textContent = `${totalSeconds}s`;
                } else if (totalSeconds < 3600) {
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    timeUsedEl.textContent = `${minutes}分${seconds}秒`;
                } else {
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    timeUsedEl.textContent = `${hours}时${minutes}分${seconds}秒`;
                }
            }
        }

        function updateInlineStats() {
            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;

            const taskCountInline = document.getElementById('taskCountInline');
            const phoneCountInline = document.getElementById('phoneCountInline');
            const totalSentCountInline = document.getElementById('totalSentCountInline');
            const successCountInline = document.getElementById('successCountInline');
            const failCountInline = document.getElementById('failCountInline');
            const successRateInline = document.getElementById('successRateInline');

            if (taskCountInline) taskCountInline.textContent = globalStats.taskCount;
            if (phoneCountInline) phoneCountInline.textContent = globalStats.totalPhoneCount;
            if (totalSentCountInline) totalSentCountInline.textContent = totalCount;
            if (successCountInline) successCountInline.textContent = globalStats.totalSuccess;
            if (failCountInline) failCountInline.textContent = globalStats.totalFail;
            if (successRateInline) successRateInline.textContent = `${successRate.toFixed(1)}%`;
        }

        //#endregion
        //#region 统计功能模块（A版和B版统计显示）
        function initGlobalStatsDisplay() {
            globalStats.totalPhoneCount = sentPhoneNumbers.size;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;
            document.getElementById('taskCount').textContent = globalStats.taskCount;
            document.getElementById('phoneCount').textContent = globalStats.totalPhoneCount;
            document.getElementById('totalSentCount').textContent = totalCount;
            document.getElementById('successCount').textContent = globalStats.totalSuccess;
            document.getElementById('failCount').textContent = globalStats.totalFail;
            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;
            updateTimeDisplay();
            updateInlineStats();
        }

        //#endregion
        //#region 面板切换模块（主页面、发送、收件箱、账号管理）
        function switchPanel(panelType) {
            const workspaceAB = document.getElementById('workspaceAB');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const panelE = document.getElementById('panelE');
            const navHomeBtn = document.getElementById('navHomeBtn');
            const navAccountBtn = document.getElementById('navAccountBtn');
            const navSendBtn = document.getElementById('navSendBtn');
            const navInboxBtn = document.getElementById('navInboxBtn');
            const logPanelBtn = document.getElementById('logPanelBtn');

            if (navHomeBtn) navHomeBtn.classList.remove('active');
            if (navAccountBtn) navAccountBtn.classList.remove('active');
            if (navSendBtn) navSendBtn.classList.remove('active');
            if (navInboxBtn) navInboxBtn.classList.remove('active');

            const isMobile = window.innerWidth <= 768;

            if (workspaceAB) {
                workspaceAB.style.display = 'none';
                workspaceAB.classList.remove('mobile-show', 'single-panel', 'show-log');
            }
            if (panelB) {
                panelB.classList.remove('mobile-show');
                panelB.style.display = 'none';
            }
            if (panelC) {
                panelC.classList.remove('mobile-show');
                panelC.style.display = 'none';
            }
            if (panelD) {
                panelD.classList.remove('mobile-show');
                panelD.style.display = 'none';
            }
            if (panelE) {
                panelE.classList.remove('mobile-show');
                panelE.style.display = 'none';
            }
            if (logPanelBtn) logPanelBtn.classList.remove('active');

            if (panelType === 'home') {
                if (isMobile) {
                    if (panelD) {
                        panelD.classList.add('mobile-show');
                        panelD.style.display = 'flex';
                    }
                } else {
                    if (panelD) panelD.style.display = 'flex';
                }
                if (navHomeBtn) navHomeBtn.classList.add('active');
            } else if (panelType === 'send') {
                if (isMobile) {
                    if (workspaceAB) {
                        workspaceAB.classList.add('mobile-show', 'single-panel');
                        workspaceAB.style.display = 'flex';
                        workspaceAB.classList.remove('show-log');
                    }
                } else {
                    if (workspaceAB) {
                        workspaceAB.style.display = 'flex';
                        workspaceAB.classList.add('single-panel');
                        workspaceAB.classList.remove('show-log');
                    }
                }
                if (navSendBtn) navSendBtn.classList.add('active');
            } else if (panelType === 'inbox') {
                if (isMobile) {
                    if (panelC) {
                        panelC.classList.add('mobile-show');
                        panelC.style.display = 'flex';
                    }
                } else {
                    if (panelC) panelC.style.display = 'flex';
                }
                if (navInboxBtn) navInboxBtn.classList.add('active');
            } else if (panelType === 'account') {
                if (isMobile) {
                    if (panelE) {
                        panelE.classList.add('mobile-show');
                        panelE.style.display = 'flex';
                    }
                } else {
                    if (panelE) panelE.style.display = 'flex';
                }
                if (navAccountBtn) navAccountBtn.classList.add('active');
                // 加载账号管理面板内容
                loadAccountPanelContent();
            }
        }

        // 日志面板切换
        function toggleLogPanel() {
            const workspaceAB = document.getElementById('workspaceAB');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const logPanelBtn = document.getElementById('logPanelBtn');

            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                syncLogToMobile();

                if (workspaceAB) {
                    workspaceAB.classList.remove('mobile-show');
                    workspaceAB.style.display = 'none';
                }
                if (panelC) {
                    panelC.classList.remove('mobile-show');
                    panelC.style.display = 'none';
                }
                if (panelD) {
                    panelD.classList.remove('mobile-show');
                    panelD.style.display = 'none';
                }
                if (panelB) {
                    panelB.classList.add('mobile-show');
                    panelB.style.display = 'flex';
                }
                if (logPanelBtn) logPanelBtn.classList.add('active');
            } else {
                if (workspaceAB && logPanelBtn) {
                    if (workspaceAB.classList.contains('show-log')) {
                        workspaceAB.classList.remove('show-log');
                        workspaceAB.classList.add('single-panel');
                        logPanelBtn.classList.remove('active');
                    } else {
                        workspaceAB.classList.remove('single-panel');
                        workspaceAB.classList.add('show-log');
                        logPanelBtn.classList.add('active');
                    }
                }
            }
        }

        // 同步日志到移动端
        function syncLogToMobile() {
            const statusList = document.getElementById('statusList');
            const statusListMobile = document.getElementById('statusListMobile');
            if (statusList && statusListMobile) {
                statusListMobile.innerHTML = statusList.innerHTML;
                statusListMobile.scrollTop = statusListMobile.scrollHeight;
            }

            const statIds = ['taskCount', 'phoneCount', 'totalSentCount', 'successCount', 'failCount', 'successRate'];
            statIds.forEach(id => {
                const source = document.getElementById(id);
                const target = document.getElementById(id + 'Mobile');
                if (source && target) {
                    target.textContent = source.textContent;
                }
            });
        }

        // 从B面板返回A面板（移动端）
        function backToSendPanel() {
            const workspaceAB = document.getElementById('workspaceAB');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const logPanelBtn = document.getElementById('logPanelBtn');
            const navSendBtn = document.getElementById('navSendBtn');

            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                if (panelB) {
                    panelB.classList.remove('mobile-show');
                    panelB.style.display = 'none';
                }
                if (panelC) {
                    panelC.classList.remove('mobile-show');
                    panelC.style.display = 'none';
                }
                if (panelD) {
                    panelD.classList.remove('mobile-show');
                    panelD.style.display = 'none';
                }
                if (workspaceAB) {
                    workspaceAB.classList.add('mobile-show', 'single-panel');
                    workspaceAB.classList.remove('show-log');
                    workspaceAB.style.display = 'flex';
                }
                if (logPanelBtn) logPanelBtn.classList.remove('active');
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                if (navSendBtn) navSendBtn.classList.add('active');
            }
        }

        // ==================== 事件绑定 ====================
        document.getElementById('navHomeBtn').addEventListener('click', function () {
            switchPanel('home');
        });

        document.getElementById('navSendBtn').addEventListener('click', function () {
            switchPanel('send');
        });

        document.getElementById('navInboxBtn').addEventListener('click', function () {
            switchPanel('inbox');
        });

        document.getElementById('navAccountBtn').addEventListener('click', function () {
            switchPanel('account');
        });

        // 日志面板切换功能（A -> B）
        document.getElementById('logPanelBtn').addEventListener('click', function () {
            toggleLogPanel();
        });

        // 返回IMessage按钮（B -> A，移动端专用）
        document.getElementById('backToSendBtn').addEventListener('click', function () {
            backToSendPanel();
        });

        // 清空日志功能（桌面端）
        document.getElementById('clearLogsBtn').addEventListener('click', function () {
            document.getElementById('statusList').innerHTML = '';
            // 同步清空移动端日志
            const statusListMobile = document.getElementById('statusListMobile');
            if (statusListMobile) statusListMobile.innerHTML = '';
        });

        document.getElementById('clearLogsBtnMobile').addEventListener('click', function () {
            document.getElementById('statusListMobile').innerHTML = '';
            // 同步清空桌面端日志
            const statusList = document.getElementById('statusList');
            if (statusList) statusList.innerHTML = '';
        });

        // 清空收件箱功能
        async function clearInbox() {
            // 获取当前所有对话的ID
            const allChatIds = Array.from(document.querySelectorAll('.contact-item')).map(item => item.dataset.chatId).filter(id => id);

            // 清空前端显示
            const contactList = document.getElementById('contactList');
            contactList.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">暂无对话</div><button class="btn-clear-inbox" id="clearInboxBtn" title="全部删除">全部删除</button>';
            document.getElementById('conversationDisplay').innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">选择一个对话开始聊天</div>';
            document.getElementById('chatHeader').innerHTML = ' 选择一个对话';

            allChatIds.forEach(chatId => {
                clearedChatIds.add(chatId);
            });

            // 重置统计
            inboxMessageStats = {};
            currentChatId = null;
            unreadChatIds.clear();
            updateInboxStats();
            updateNotificationCount();

            // 通知后端这些对话已清空
            if (allChatIds.length > 0 && currentUserId) {
                try {
                    const authToken = localStorage.getItem('auth_token');
                    await fetch(`${API_BASE_URL}/user/${currentUserId}/inbox/clear`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken ? `Bearer ${authToken}` : ''
                        },
                        body: JSON.stringify({
                            chat_ids: Array.from(clearedChatIds)
                        })
                    });
                } catch (err) {
                    console.error("清空收件箱失败:", err);
                }
            }

            // 重新绑定按钮事件（因为innerHTML会移除事件监听）
            document.getElementById('clearInboxBtn').addEventListener('click', clearInbox);
        }

        document.getElementById('clearInboxBtn').addEventListener('click', clearInbox);

        // 事件监听
        document.getElementById('numbersText').addEventListener('input', updateCounts);
        document.getElementById('messageText').addEventListener('input', updateCounts);
        document.getElementById('importNumbersBtn').addEventListener('click', importNumbers);
        document.getElementById('clearNumbersBtn').addEventListener('click', clearNumbers);
        document.getElementById('importMessageBtn').addEventListener('click', importMessage);
        document.getElementById('clearMessageBtn').addEventListener('click', clearMessage);
        document.getElementById('sendBtn').addEventListener('click', startSending);
        document.getElementById('sendReplyBtn').addEventListener('click', sendReply);
        document.getElementById('replyInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendReply();
            }
        });

        // 延长逻辑
        const lockState = {};

        function setupExpand(triggerId, wrapperId) {
            const trigger = document.getElementById(triggerId);
            const wrapper = document.getElementById(wrapperId);
            if (!trigger || !wrapper) return;

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                if (lockState[wrapperId]) {
                    lockState[wrapperId] = false;
                    wrapper.classList.remove('locked');
                    wrapper.classList.remove('expanded');
                } else {
                    lockState[wrapperId] = true;
                    wrapper.classList.add('locked');
                    wrapper.classList.add('expanded');
                }
            });
        }

        // 更新间隔选择器的颜色
        function updateIntervalColor() {
            const intervalSelect = document.getElementById('intervalInput');
            if (intervalSelect) {
                const value = intervalSelect.value;
                intervalSelect.setAttribute('data-value', value);
            }
        }

        // 初始化
        function updateScale() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                // 移动端不缩放
                document.body.style.transform = '';
                document.body.style.transformOrigin = '';
                document.body.style.zoom = '';
                return;
            }

            const devicePixelRatio = window.devicePixelRatio || 1;

            // 111.html中：main-container固定1300×580px，nav-container自适应（约140px），gap 10px
            // 在125%DPI下，浏览器会自动处理DPI，1300px会显示为1300px的逻辑像素大小
            // 所以我们需要固定的尺寸就是：1300×580px（主容器）+ 导航栏自适应

            // 主容器：1300×580px
            // 导航栏：自适应（约140px）
            // 总宽度：约1450px（导航栏140 + gap10 + 主容器1300）
            const designWidth = 1450;
            const designHeight = 580;

            const minMargin = 50;

            // 计算需要的窗口最小尺寸（基础尺寸 + 边距）
            // 只有当窗口小于这个尺寸时，才需要缩放
            const minWindowWidth = designWidth + (minMargin * 2);  // 1150px
            const minWindowHeight = designHeight + (minMargin * 2); // 680px

            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            // 计算可用空间（考虑最小边距）
            const availableWidth = windowWidth - (minMargin * 2);
            const availableHeight = windowHeight - (minMargin * 2);

            let scale = 1.0;

            if (windowWidth < minWindowWidth || windowHeight < minWindowHeight) {
                // 窗口太小，需要缩小
                const scaleX = availableWidth / designWidth;
                const scaleY = availableHeight / designHeight;
                scale = Math.min(scaleX, scaleY);
                // 最小缩放限制：0.5倍
                scale = Math.max(0.5, scale);
            }
            // 如果窗口 >= 1550×680，scale保持1.0，不放大也不缩小（保持111.html的视觉效果）

            const contentWrapper = document.querySelector('.content-wrapper');
            if (contentWrapper) {
                // 关键：固定尺寸为111.html在3440×1440、125%DPI下的显示尺寸
                // 这样在任何屏幕上，只要窗口足够大，都会显示和111.html一样的效果
                contentWrapper.style.setProperty('width', designWidth + 'px', 'important');
                contentWrapper.style.setProperty('height', designHeight + 'px', 'important');
                contentWrapper.style.setProperty('max-width', designWidth + 'px', 'important');
                contentWrapper.style.setProperty('max-height', designHeight + 'px', 'important');
                contentWrapper.style.setProperty('min-width', designWidth + 'px', 'important');
                contentWrapper.style.setProperty('min-height', designHeight + 'px', 'important');

                contentWrapper.style.removeProperty('zoom');

                // 只有当窗口太小时才应用transform缩放
                if (scale < 1.0) {
                    contentWrapper.style.setProperty('transform', `scale(${scale})`, 'important');
                    contentWrapper.style.setProperty('transform-origin', 'center center', 'important');
                } else {
                    contentWrapper.style.removeProperty('transform');
                    contentWrapper.style.removeProperty('transform-origin');
                }

                // 更新调试信息（不需要打开DevTools）
                updateDebugInfo(windowWidth, windowHeight, scale, contentWrapper, devicePixelRatio, 1.0);
            }
        }

        function updateDebugInfo(w, h, scale, wrapper, devicePixelRatio, antiDpiZoom) {
            const debugInfo = document.getElementById('debugInfo');
            if (!debugInfo) return;

            const computed = window.getComputedStyle(wrapper);
            const transform = computed.transform === 'none' ? 'none' : computed.transform;
            const zoom = computed.zoom || '1';

            // 显示所有可能的尺寸值
            document.getElementById('debugInnerWidth').textContent = window.innerWidth + 'px';
            document.getElementById('debugInnerHeight').textContent = window.innerHeight + 'px';
            document.getElementById('debugOuterWidth').textContent = window.outerWidth + 'px';
            document.getElementById('debugOuterHeight').textContent = window.outerHeight + 'px';
            document.getElementById('debugScreenWidth').textContent = window.screen.width + 'px';
            document.getElementById('debugScreenHeight').textContent = window.screen.height + 'px';
            document.getElementById('debugAvailWidth').textContent = window.screen.availWidth + 'px';
            document.getElementById('debugAvailHeight').textContent = window.screen.availHeight + 'px';

            // 显示DPI缩放信息
            const dpiInfo = document.getElementById('debugDpiInfo');
            if (dpiInfo) {
                dpiInfo.textContent = `devicePixelRatio: ${devicePixelRatio.toFixed(2)} (系统缩放${(devicePixelRatio * 100).toFixed(0)}%), 抵消zoom: ${antiDpiZoom.toFixed(3)}`;
            }

            // 显示实际使用的值
            document.getElementById('debugWindowSize').textContent = `${w} × ${h}`;
            document.getElementById('debugScale').textContent = scale.toFixed(3);
            document.getElementById('debugTransform').textContent = transform;

            // 显示zoom值
            const zoomInfo = document.getElementById('debugZoom');
            if (zoomInfo) {
                zoomInfo.textContent = zoom;
            }

            // 按D键显示/隐藏调试信息
            debugInfo.style.display = window.showDebugInfo ? 'block' : 'none';
        }
        //#endregion
        //#region 辅助功能模块（文件导入、清空、计数更新、缩放等）
        function init() {
            const mainContainer = document.querySelector('.main-container');
            if (mainContainer) {
                mainContainer.style.display = 'flex';
            }

            if (!checkAuth()) {
                console.warn('未登录，跳过初始化');
                return;
            }

            updateCounts();
            initGlobalStatsDisplay();
            updateButtonState();
            updateConnectionStatus(false);
            resetInboxOnConnect();
            loadServersFromAPI();
            connectToAvailableServers();
            // 启动服务器状态轮询
            startServerPolling();
            const statusList = document.getElementById('statusList');
            if (statusList) {
                statusList.innerHTML = '';
            }

            // 设置间隔选择器的初始颜色
            updateIntervalColor();

            // 监听间隔选择器的变化
            const intervalSelect = document.getElementById('intervalInput');
            if (intervalSelect) {
                intervalSelect.addEventListener('change', updateIntervalColor);
            }

            updateNotificationCount();

            // 设置延长功能（如果需要的话）
            setupExpand('numTrigger', 'numWrapper');
            setupExpand('logTrigger', 'logWrapper');

            // 确保移动端B面板初始隐藏
            const panelB = document.getElementById('panelB');
            if (panelB) {
                panelB.classList.remove('mobile-show');
                panelB.style.display = 'none';
            }

            updateScale();
            window.addEventListener('resize', updateScale);

            // 键盘快捷键：按D键显示/隐藏调试信息
            window.showDebugInfo = false;
            document.addEventListener('keydown', function (e) {
                if (e.key === 'd' || e.key === 'D') {
                    window.showDebugInfo = !window.showDebugInfo;
                    const debugInfo = document.getElementById('debugInfo');
                    if (debugInfo) {
                        debugInfo.style.display = window.showDebugInfo ? 'block' : 'none';
                    }
                }
            });

            switchPanel('home');
        }

        //#endregion
        //#region 页面切换模块（登录页面、主应用页面切换）
        // 退出登录
        function handleLogout() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            localStorage.removeItem('admin_id');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_username');
            
            showLoginPage();
        }

        function showMainApp() {
            const loginPage = document.getElementById('loginPage');
            const adminPage = document.getElementById('adminPage');
            const managerPage = document.getElementById('managerPage');
            const contentWrapper = document.querySelector('.content-wrapper');
            const mainContainer = document.querySelector('.main-container');
            const panelA = document.getElementById('panelA');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const panelE = document.getElementById('panelE');

            if (loginPage) {
                loginPage.style.display = 'none';
                document.body.classList.remove('login-mode');
            }
            if (adminPage) {
                adminPage.classList.remove('show');
                adminPage.style.display = 'none';
            }
            if (managerPage) {
                managerPage.style.display = 'none';
            }

            if (contentWrapper) {
                contentWrapper.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'flex';
            }
            
            if (panelA) {
                panelA.style.display = 'flex';
            }
            if (panelB) {
                panelB.style.display = 'none';
                panelB.classList.remove('mobile-show');
            }
            if (panelC) {
                panelC.style.display = 'none';
            }
            if (panelD) {
                panelD.style.display = 'none';
            }
            if (panelE) {
                panelE.style.display = 'none';
                panelE.classList.remove('mobile-show');
            }
            
            const navHomeBtn = document.getElementById('navHomeBtn');
            const navAccountBtn = document.getElementById('navAccountBtn');
            const navSendBtn = document.getElementById('navSendBtn');
            const navInboxBtn = document.getElementById('navInboxBtn');
            if (navHomeBtn) navHomeBtn.classList.add('active');
            if (navAccountBtn) navAccountBtn.classList.remove('active');
            if (navSendBtn) navSendBtn.classList.remove('active');
            if (navInboxBtn) navInboxBtn.classList.remove('active');
            
        }

        function showLoginPage() {
            const loginPage = document.getElementById('loginPage');
            const contentWrapper = document.querySelector('.content-wrapper');
            const mainContainer = document.querySelector('.main-container');
            const adminPage = document.getElementById('adminPage');
            const managerPage = document.getElementById('managerPage');

            if (loginPage) {
                loginPage.style.display = 'flex';
                document.body.classList.add('login-mode');
            }

            if (contentWrapper) contentWrapper.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'none';

            if (adminPage) {
                adminPage.classList.remove('show');
                adminPage.style.display = 'none';
            }
            if (managerPage) {
                managerPage.style.display = 'none';
            }
        }

        // 添加页面切换动画
        function showAdminPage() {
            document.getElementById('adminPage').classList.add('show');
            document.getElementById('loginPage').style.display = 'none';
        }

        // 添加加载状态

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        //#endregion
        //#region 页面初始化模块（应用启动入口）
        function initPage() {
            // 检查登录页面初始状态，设置 body 类名
            const loginPage = document.getElementById('loginPage');
            if (loginPage && loginPage.style.display !== 'none') {
                document.body.classList.add('login-mode');
            }
            
            if (typeof window.checkAuth === 'function') {
                if (checkAuth()) {
                    showMainApp();
                    if (typeof window.init === 'function') {
                        window.init();
                    }
                } else {
                    showLoginPage();
                }
            } else {
                const userId = localStorage.getItem('user_id');
                const authToken = localStorage.getItem('auth_token');
                if (userId && authToken) {
                    showMainApp();
                    if (typeof window.init === 'function') {
                        window.init();
                    }
                } else {
                    showLoginPage();
                }
            }
        }

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            stopServerPolling();
            stopInboxPolling();
            stopAllTaskPolling(); // 停止所有任务轮询
        });

        // 页面加载完成
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPage);
        } else {
            initPage();
        }

        //#endregion
    </script>
    
</body>
    

</html>
